$z.defModule("access/index",{initialize:function(){$j("#password_help").data("originalURL",$j("#password_help").attr("href"));this.addEmailToPasswordHelpLink();$j("#user_email").change(function(){$z("access/index").addEmailToPasswordHelpLink()})},addEmailToPasswordHelpLink:function(){var b=$j("#password_help");var a=$j("#user_email").val();var c=$j("#password_help").data("originalURL");if($j.trim(a)===""){b.attr("href",c)}else{a=encodeURIComponent(a);b.attr("href",c+"?email="+a)}}});(function(s,e){var c="end_user",l=c,k=["twitter","facebook","google"],p,a;function d(u,v){return a[v||l][u]}function g(u){return d(u,"agent")&&d(u,"end_user")}function n(){return l==="end_user"?"agent":"end_user"}function j(u){l=(typeof u==="string"?u:n())}function f(){return g("twitter")&&g("facebook")&&g("google")}function h(){return d("twitter")||d("facebook")||d("google")}function r(){if(h()){p.find(".services.external").show();p.find(".separator").show()}else{p.find(".services.external").hide();p.find(".separator").hide()}}function m(){e(k).each(function(v,u){p.find(".service."+u).hide();if(d(u)){p.find(".service."+u).css("display","block")}})}function q(){p.find("a.role").each(function(v,u){u.hide()});if(!f()){p.find("a.role."+n()).show()}}function t(){var u=function u(){r();m();q()};p.bind("activeRole:change",u)}var b=function(u){p=e(".login");a=u.services;if(lastKnownRole=u.last_known_user_role){l=lastKnownRole}p.find(".role.multiple_options").click(this.toggle);t();r();m();q()};b.prototype.toggle=function o(u){j(u);p.trigger("activeRole:change")};s.LoginServiceManager=b})(window.Zendesk,jQuery);$z.defModule("account/business_hours_definitions/show",{initialize:function(){if($j("form#business_hours_form").attr("data-has-business-hours")==="false"){$j("#business_hours_definition_is_active_false").click();$j("form#business_hours_form :input").prop("disabled",true);$j("#sub_setting_is_active").show()}}});$z.defModule("account/dropboxes/edit",{initialize:function(){var b=$j("#dropbox_form"),d=b.find(".upgrade_field"),c=b.find("a.upgrade"),a=b.find(".current_version");c.click(function(){if(!confirm("Upgrade this Feedback Tab?")){return false}$j.ajax({url:c.attr("href"),type:"POST",dataType:"JSON",data:{_method:"PUT"}}).done(function(e){showFlash("Upgraded","notice");a.html(e.version);d.removeClass("upgradeable").addClass("not_upgradeable")}).fail(function(e){var f=JSON.parse(e.responseText);f.error&&showFlash(f.error,"error")});return false})}});$z.defModule("account/dropboxes/version1",{initialize:function(){this._hostName=$j("#zenboxForm").attr("data-zd-host-name");if(!this._hostName){console.warn("No host name found. Is there a #zenboxForm[data-zd-host-name] element?")}$j("#zenboxForm input").change(this.update.bind(this));Zenbox.init(this._settings());this.update({init:true})},update:function(a){var b=this._settings();this._applySettingsToDropbox(b);this._writeTemplate(b,a)},_settings:function(){return{url:this._hostName,tab_id:this._tabID(),tab_color:$j.trim($j("#zenbox_color").val()),title:$j.trim($j("#zenbox_title").val()).replace(/"/g,"'"),text:this._applyHTMLLineBreaks(($j("#zenbox_text").val())).replace(/"/g,"'"),tag:$j("#zenbox_tag").val()}},_applySettingsToDropbox:function(b){var a=$j("#zenbox_tab");a.css("backgroundColor",b.tab_color);a.css("borderColor",b.tab_color);$j("#overlay_zenbox_title").html(b.title);$j("#overlay_zenbox_text").html(b.text);$j("#zenbox_tab").css("backgroundImage","url(http://assets.zendesk.com/external/zenbox/images/tab_"+b.tab_id+".png)")},_writeTemplate:function(c,b){var a=$j("#zenbox_output");a.val($j.mustache(this._template,c));if(b&&!b.init){a.effect&&a.effect("highlight",{},2000)}},_template:'<script type="text/javascript" src="//assets.zendesk.com/external/zenbox/overlay.js"><\/script>\n<style type="text/css" media="screen, projection">\n  @import url(//assets.zendesk.com/external/zenbox/overlay.css);\n</style>\n<script type="text/javascript">\n  if (typeof(Zenbox) !== "undefined") {\n    Zenbox.init({\n      url:       "{{ url }}",\n      tab_id:    "{{ tab_id }}",\n      tab_color: "{{ tab_color }}",\n      title:     "{{ title }}",\n      text:      "{{ text }}",\n      tag:       "{{ tag }}"\n    });\n  }\n<\/script>\n',_applyHTMLLineBreaks:function(a){return $j.trim(a).replace(/\r\n|\n/g,"<br/>")},_tabID:function(){return $j('input:checked[type="radio"][name="zenbox_tab_id"]').val()}});$z.defModule("account/monitored_twitter_handles/index",{initialize:function(){var a=$j("p.add_monitor_handle a#add-twitter");if(arguments[0]==true){a.click(function(){$j("div.help-bubble").slideDown("200")})}else{a.click(this.addTwitterMonitorHandle())}MTH.initialize()},addTwitterMonitorHandle:function(){$j.colorbox({href:"/account/monitored_twitter_handles/new"})}});var MTH={initialize:function(){$j("input.handle_master").each(function(a,b){$j(b).click(MTH.setPrimary)})},setPrimary:function(b){var c=$j(b.target);var d=c.attr("id").split("_").last();var a=c.attr("checked");if(a){MTH.uncheckSiblings(c)}MTH.togglePrimaryFlag(d,a);MTH.requestUpdate(d,a)},showSpinner:function(a){$j("#spinner-"+a).show()},hideSpinner:function(a){$j("#spinner-"+a).hide()},uncheckSiblings:function(a){$j("input.handle_master").prop("checked",false);a.attr("checked",true)},togglePrimaryFlag:function(b,a){$j(".primary-selector").hide();if(a){$j("#primary-selector-"+b).show()}},requestUpdate:function(b,a){MTH.showSpinner(b);$j.ajax({type:"PUT",url:"/account/channels/"+b,data:{handle:{master:a}},success:function(){MTH.hideSpinner(b)}})}};$z.defModule("archived_tickets/index",{initialize:function(){this.updateUI();$j("select#filter_by").change(this.updateUI)},updateUI:function(){["requester","organization"].each(function(a){if(a==$j("select#filter_by").val()){$j("#"+a).show()}else{$j("#"+a).hide()}})}});$z.defModule("categories/form",{initialize:function(){$j("#category_name").focus()}});$z.defModule("categories/show",{initialize:function(){$z("forums/index").initialize()}});$j(document).ready(function(){$j("#chat_availability").click(function(a){a.preventDefault();window.open("/chat","chatWindow","toolbar=0, menubar=0, width=620, height=594, location=0, status=0, directories=0")})});Zendesk.NS("CMS");Zendesk.CMS.Bootstrap=function(){if((typeof(currentAccount)=="undefined")||!currentAccount.hasFeature("ahab")){return}$j("[data-placeholder-id]").each(function(a,d){var d=$j(d);if(!d.data("ahab")){var b=(d.find("textarea")||d.find("input[type=text]"));var e=d.find(".placeholder-info")||$j("<div></div>").insertAfter(b);var c=e.ahab(b);d.data("ahab",c)}})};Zendesk.CMS.Ahab=function(b,a){this.targetInput=a;this.linkElement=b;this.list=null};Zendesk.CMS.Ahab.prototype={show:function(){if((typeof(this.list)=="undefined")||(this.list==null)){this._prepare()}var a=this;$j(this.list).iosMenu({title:"Insert Placeholder",slideDuration:50,click:function(c,d){var b=d.data("value");if(b){$j(a.targetInput).insertAtCaret("{{"+b+"}}");c.toggle()}},backTextFunction:function(b){return $j(b).parent().find("> a").html()}});return this},_prepare:function(){var b=this._render(Zendesk.CMS.texts);var a=$j(this.linkElement).html(b);this.list=a.find("ul.root")},_render:function(b){var a=$j('<ul class="menu root" style="display: none;">');var c=_.reduce(this._renderLevel(b),function(d,e){return d.append(e)},a);return c},_renderLevel:function(e){var b=this;var d=_.without(_.keys(e),"id","title");var c=_.sortBy(d,function(f){return f});var a=_.map(c,function(f){return b._renderItem(f,e[f])});return a},_renderItem:function(b,c){var d=$j("<li></li>");d.append(b);var a=this._renderLevel(c);if(_.any(a)){subLevel=_.reduce(a,function(e,f){return e.append(f)},$j('<ul class="sd"></ul>'));d.append(subLevel).addClass("sub")}else{d.addClass("link")}d.data("full-title",c.title);d.data("value",c.id);return d},_calculateTitles:_.memoize(function(){return _.map($j("li.ui-menu-item.link"),function(a){return $j(a).data("full-title")})}),_searchResultRenderer:function(a){var c=$j("input.ios-menu-search-field").val();var d=a.toLowerCase().split(c.toLowerCase());var b=_.reduce(d,function(e,f){return e+"<strong>"+c+"</strong>"+f});return"<li><a>"+b+"</a></li>"}};jQuery.fn.extend({ahab:function(a){return new Zendesk.CMS.Ahab(this,a).show()}});$j("#cms_variant_is_fallback").change(function(){if($j("#cms_variant_is_fallback").attr("checked")=="checked"){$j("#cms_variant_active_true").attr("checked",true);$j("#cms_variant_active_false").attr("disabled",true)}else{$j("#cms_variant_active_false").attr("disabled",false)}});$j("#get_more_macros").click(function(){$j("#get_more_macros").hide();$j(".macros_reference").fadeIn()});$j("#get_more_triggers").click(function(){$j("#get_more_triggers").hide();$j(".triggers_reference").fadeIn()});$j("#get_more_automations").click(function(){$j("#get_more_automations").hide();$j(".automations_reference").fadeIn()});$j("#cms_texts_filter_form").change(function(){$j(this).closest("form").submit()});Zendesk.NS("CRM");Zendesk.CRM.Application=function(a){this.renderer=a;this.initialDelay=5000;this.backoff=0};Zendesk.CRM.Application.prototype={renderData:function(b,a){if(a){this.renderer.render(b,a)}else{this.renderer.render(b,"ok")}},fetchAndRenderData:function(a){this.url=a;this._setupPoller();this.renderer.renderWaiting();this.poller.start()},_setupPoller:function(){var a=this;this.poller=new Zendesk.CRM.Poller(function(b){a._pollerCallback(a,b)},{initialDelay:this.initialDelay,backoff:this.backoff})},_pollerCallback:function(a,b){$j.ajax({type:"get",url:this.url,success:function(c){if(c.status==="ok"){a.poller.stop();a.renderData(c.records)}else{if(c.status=="errored"){a.poller.stop();a.renderData(c.records,c.status)}else{a.poller.resume()}}},error:function(){a.poller.stop();a.renderData([],"errored")}})}};Zendesk.NS("CRM");Zendesk.CRM.Poller=function(b,a){this.initialDelay=a.initialDelay||10000;this.backoff=a.backoff||5000;this.waitForCallback=a.waitForCallback||false;this.callback=b;this.state="stopped";this.currentDelay=this.initialDelay;this.waitDelay=a.waitDelay||2000;this.debug=!!a.debug;this.trace=""};Zendesk.CRM.Poller.prototype={start:function(){this.state="polling";this._schedulePoll(this.initialDelay);this._trace("[started]")},stop:function(){this.state="stopped"},reset:function(){this.state="resetting"},pause:function(){this.state="paused";this._trace("[paused]")},resume:function(){if(this.state=="paused"){this._trace("[resuming]");this.state="resuming"}},_schedulePoll:function(b){var a=this;setTimeout(function(){a._pollerCallback()},b)},_pollerCallback:function(){if(this.state=="polling"){this.currentDelay=this.currentDelay+this.backoff;var a=this.currentDelay;if(this.waitForCallback){this._trace("[pausing]");this.pause();a=this.waitDelay}this._trace("[callback]");this.callback(this);this._schedulePoll(a)}else{if(this.state=="resetting"){this.state="polling";this.currentDelay=this.initialDelay;this._schedulePoll(this.initialDelay)}else{if(this.state=="paused"){this._trace(".");this._schedulePoll(this.waitDelay)}else{if(this.state=="resuming"){this._trace("[resumed]");this.state="polling";this._schedulePoll(this.currentDelay)}}}}},_trace:function(a){if(this.debug){this.trace=this.trace+a}}};Zendesk.NS("CRM");Zendesk.CRM.ProfileRenderer=function(){this.element=$j("#crm_user_data");this.success_template=$j("#crm_template").html();this.error_template=$j("#crm_error_template").html();this.loading=$j("#crm_loading")};Zendesk.CRM.ProfileRenderer.prototype={renderWaiting:function(){this.loading.show()},render:function(b,a){if(a=="ok"){this._renderSuccess(b)}else{if(a=="pending"){this.renderWaiting()}else{this._renderError()}}},_renderSuccess:function(b){var a=this;_(b).each(function(d){d.fields=a._splitFields(d.fields)});var c=$j.mustache(this.success_template,{records:b});this.element.html(c);this.loading.hide()},_renderError:function(){this.element.html(this.error_template);this.loading.hide()},_splitFields:function(b){var a=[];var d,c;for(var e=0;e<b.length;e++){d=b[e];if(b[e+1]){c=b[e+1];e=e+1}else{c={label:"&nbsp;",value:"&nbsp;",empty:true}}a.push({record1:d,record2:c})}return a}};Zendesk.NS("CRM");Zendesk.CRM.SidebarRenderer=function(a){this.element=$j("#crm_user_data");this.success_template=$j("#crm_template").html();this.error_template=$j("#crm_error_template").html();this.loading=$j("#crm_loading");this.profile_url=a;this.fieldsToShow=10};Zendesk.CRM.SidebarRenderer.prototype={renderWaiting:function(){this.loading.show()},render:function(b,a){if(a=="ok"){this._renderSuccess(b)}else{if(a=="pending"){this.renderWaiting()}else{this._renderError()}}},_renderSuccess:function(b){if(b.length>0){var d=this._addMoreLink(b[0]);var a=this;var f=_(b.slice(1)).map(function(g){return a._addMoreLink(g)});var e=f.length}else{var d=null;var f=null;var e=null}var c=$j.mustache(this.success_template,{mainRecord:d,subRecords:f,showMore:e});this.element.html(c);this.loading.hide();var a=this;$j(".crm-records-toggle",a.element).click(function(g){$j("#crm-sub-records",a.element).slideToggle(function(){$j(".crm-records-toggle",a.element).toggle()});g.stopPropagation();g.preventDefault()})},_addMoreLink:function(a){if(a.fields&&a.fields.length>this.fieldsToShow){a.fields=a.fields.slice(0,this.fieldsToShow);a.moreLink=this.profile_url}return a},_renderError:function(){this.element.html(this.error_template);this.loading.hide()}};$z.defModule("entries/_forums2_show",{initialize:function(b){var a=this;a.zd_label_answered=$j("div.frame > div.entry span.zd_label.answered");$j("div#history.frame > div.item").each(function(d,e){var c=$j(e).attr("data-post_id");if(b["is_moderator?"]===true){$j(e).find("div.user_formatted span.label_theanswer").click(a.set_the_answer_toggle_option(c))}});$j("a[property='is_locked']").click(function(c){$j("div.commenting-controls div.control").toggle()})},set_the_answer_toggle_option:function(b){var a=this;return(function(e){var d=$j(this);d.toggleClass("answered").addClass("ajax");var c=a.set_answered_label(d.hasClass("answered"));$j.post(d.attr("data-update_answer_path"),{is_answer:d.hasClass("answered")},function(){$j.ajax({url:d.attr("data-is_answered_path"),dataType:"json",type:"GET",success:c,complete:function(){d.removeClass("ajax")}})})})},set_answered_label:function(b){var a=this;if(b===true){a.zd_label_answered.addClass("selected")}else{return function(c){a.zd_label_answered.toggleClass("selected",c)}}this.zd_label_answered.toggleClass("selected",b)},set_moderator_toggle_option_for:function(b,a){$(b+"_option").children[0].className=(a?"selected":"deselected");$(b+"_option").children[0].className=(a?"deselected":"selected")},set_moderator_idea_label:function(a){$("flag_option").children[0].className=(a==1?"selected":"deselected");$("flag_option").children[1].className=(a==200?"selected":"deselected");$("flag_option").children[2].className=(a==201?"selected":"deselected")}});$z.defModule("entries/_sidebar_moderator",{initialize:function(b){var a=this;a.moderatorBox=$j("#moderator_box");a.actionDiv=$j("#contentcolumn > div.content > div.action");a.adminLabels=$j("#moderator_box > p.labels");a.zdLabels=$j("div.entry");a.setModeratorToggleOptionFor();a.renderModeratorIdeaLabelFor()},setModeratorToggleOptionFor:function(){var a=this;a.moderatorBox.find("ul.actions > li > a.mod_option").click(a.selectToggle())},renderModeratorIdeaLabelFor:function(){var a=this;a.moderatorBox.find("p.labels > a").click(a.selectToggle())},selectToggle:function(){var b=this;var a={url:$j(this).attr("data-deselected_entry_path"),data:{authenticity_token:Zendesk.currentUser.authenticityToken},dataType:"json",type:"put"};var c=function(e,d){return function(){b.updatePage(e,d)}};return function(d){if($j(this).hasClass("selected")){$j(this).removeClass("selected");a.success=c("deselected",$j(this).attr("property"));a.url=$j(this).attr("data-deselected_entry_path")}else{$j(this).addClass("selected");a.success=c("selected",$j(this).attr("property"));a.url=$j(this).attr("data-selected_entry_path")}$j.ajax(a)}},updatePage:function(c,b){var a=this;switch(b){case"planned":if(c==="selected"){a.adminLabels.find("a.topic_label_done").removeClass("selected");a.adminLabels.find("a.topic_label_not_planned").removeClass("selected");a.zdLabels.find("span.done").removeClass("selected");a.zdLabels.find("span.not_planned").removeClass("selected");a.zdLabels.find("span.planned").addClass("selected")}else{a.adminLabels.find("a.topic_label_planned").removeClass("selected");a.zdLabels.find("span.planned").removeClass("selected");a.zdLabels.find("span.planned").removeClass("selected")}break;case"done":if(c==="selected"){a.adminLabels.find("a.topic_label_planned").removeClass("selected");a.adminLabels.find("a.topic_label_not_planned").removeClass("selected");a.zdLabels.find("span.planned").removeClass("selected");a.zdLabels.find("span.not_planned").removeClass("selected");a.zdLabels.find("span.done").addClass("selected")}else{a.adminLabels.find("a.topic_label_done").removeClass("selected");a.adminLabels.find("span.done").removeClass("done");a.zdLabels.find("span.done").removeClass("selected")}break;case"not_planned":if(c==="selected"){a.adminLabels.find("a.topic_label_planned").removeClass("selected");a.adminLabels.find("a.topic_label_done").removeClass("selected");a.zdLabels.find("span.planned").removeClass("selected");a.zdLabels.find("span.done").removeClass("selected");a.zdLabels.find("span.not_planned").addClass("selected")}else{a.adminLabels.find("a.topic_label_not_planned").removeClass("selected");a.adminLabels.find("span.not_planned").removeClass("done");a.zdLabels.find("span.not_planned").removeClass("selected")}break;case"answered":if(c==="selected"){a.zdLabels.find("span.answered").addClass("selected")}else{a.zdLabels.find("span.answered").removeClass("selected")}break}}});$z.defModule("entries/edit",{initialize:function(a){$("entry_title").focus();$j("form#entryform").submit(function(){if(typeof(entryTagField)!="undefined"){entryTagField.beforeFormSubmit()}if(typeof(entryPhrasesField)!="undefined"){entryPhrasesField.beforeFormSubmit()}})},applyTagsToField:function(d,f,b,c,e){var a=this;if(a.fields===e){a.fields={}}if(a.fields[d]!==e){}else{a.fields[d]=null}$j(function(){function g(j,h){if(c==true){return h.keyCode==188||h.keyCode==13}else{return true}}a.fields[d]=new Autocompleter.MultiValue(f,Autocompleter.cachedLookupTag,b,{frequency:0.3,minChars:2,acceptNewValues:true,newValueChecker:g})})}});$z.defModule("entries",{});$z.defModule("entries/index",{initialize:function(){}});$z.defModule("entries/show",{initialize:function(a){if(typeof(currentUser)!=="undefined"){$j("input[name='authenticity_token']").each(function(){$j(this).attr("value",currentUser.authenticityToken)})}$z("forums/index").initialize()},showFormFor:function(a){$j("#view-post-"+a).hide();$j("#edit-post-"+a).show();tinyMCE.execCommand("mceAddControl",false,"post-edit-field-"+a);InputTracking.fixSubmit($("post-edit-form-"+a),"onsubmit");$j("#edit-link-for-"+a).removeAttr("onclick");$j("#edit-link-for-"+a).click(function(){$j("#view-post-"+a).hide();$j("#edit-post-"+a).show();return false})},hideFormFor:function(a){$j("#edit-post-"+a).hide();$j("#view-post-"+a).show();InputTracking.trackedElements=[]}});Zendesk.NS("Facebook.integration",function(f){function b(k,g){var h=f("#to_colorbox");if(h.length===0){return}var j=h.html();h.html("");f.colorbox({html:j,onComplete:function(){var m=f("#active_facebook_pages .facebook-page").length;var l=f(".add_page").length;f("#available_facebook_pages").parent().addClass("colorbox-facebook");f("#available_facebook_pages").parent().css({height:"100%"});f(".setting").click(function(){if(f(this).hasClass("selected")){f(this).removeClass("selected")}else{f(this).addClass("selected")}});f(".add_page").click(function(){var n=this.id.split("-")[1];f("#pageframe-"+n).fadeOut();k++;var o=e(k,g);var p=a(n);f.colorbox.resize();f.post("/facebook/pages/select",{id:n,settings:p},function(q){f("#fbpages").show();o.html(o.html()+q);c(g);if(k-m==l){f.colorbox.close()}})})},onClosed:function(){window.location.replace("/facebook/settings#general_settings")}})}f(function(){var g=f("#facebook-page-limit-notify");var h=f("#to_colorbox").html();if(g.length>0){b(g.find("#current").html(),g.find("#limit").html())}else{if(h!=null){b(0,0)}}});function a(h){var j=f("#settings_"+h);var g=j.find("#enable_wall_posts").hasClass("selected");var k=j.find("#enable_messages").hasClass("selected");var l=j.find("#import_acstivity").hasClass("selected");return[g,k,l]}function e(h,g){if(h<=g){f("#facebook-page-limit-notify").html(I18n.t("txt.facebook_integration.views.colorbox.pages_added",{active_pages:h,page_limit:g}))}var j="#active_facebook_pages";if(h>g){j="#inactive_facebook_pages";f(j).show()}return f(j)}function c(g){var h=f(".facebook_page");f("#no_pages").hide();h.removeClass("nobottom");f(h[g-1]).addClass("nobottom");f(h[h.length-1]).addClass("nobottom")}function d(g){if(g.is(":checked")===true){f("#facebook-controls").show()}else{f("#facebook-controls").hide()}}f(document).ready(function(){var g=f("#comment_is_public");d(g);g.change(function(){d(g)})})},jQuery);$z.defModule("feeds/index",{initialize:function(){},renderLatestComment:function(a){$j.ajax({url:"/tickets/"+a+"/events?for=feed&filter=latest",dataType:"html",context:$j("#"+a+"-reply"),success:function(b){$j("#"+a+"-ticket-form").hide();$j("#ticket-form").appendTo($j("#ticket-form-home"));this.replaceWith(b)}})},renderRemainingComments:function(a){this.remoteCall("/tickets/"+a+"/events?for=feed&filter=remaining","li#"+a+"-all")},renderCommentBody:function(a){this.remoteCall("/events/"+a+"?for=feed","span#"+a+"-comment-body")},remoteCall:function(a,b){$j.ajax({url:a,dataType:"html",context:$j(b),success:function(c){this.replaceWith(c)}})},renderTicketForm:function(e,a,d,b,c){$j(".fake-text-area").show();$j("#show-ticket-properties").show();$j("#ticket-properties").hide();$j("#ticket-status-new").prop("disabled",a!="0");$j("#"+e+"-fake-reply").hide();$j("#ticket-form").appendTo($j("#"+e+"-ticket-form"));$j("#ticket_status_id").val(a);$j("#ticket_priority_id").val(d);$j("#ticket_group_id").val(b);$j("#ticket_assignee_id").val("");$j("#comment_value").val("");$j("#comment_is_public").prop("checked",false);updateProperties(c);$j("#"+e+"-ticket-form").show();$j("#ticket-form").show();$j("#comment_value").focus()}});(function(b){function a(c){var d=b("<div/>").css({position:"absolute",left:c.left+"px",top:c.top+"px",width:(c.right-c.left)+"px",height:(c.bottom-c.top)+"px",outline:"red 1px solid"});b("body").append(d);window.setTimeout(function(){d.remove()},1000)}b.fn.bounds=function(d,c){d=d||c;var e={left:Number.POSITIVE_INFINITY,top:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY,width:function(){return this.right-this.left},height:function(){return this.bottom-this.top},show:function(){a(this);return this},toString:function(){return JSON.stringify(this)}};this.each(function(f,h){var g=b(h),j=g.offset();if(d){j.right=j.left+b(g).outerWidth(c);j.bottom=j.top+b(g).outerHeight(c)}else{j.right=j.left+b(g).width();j.bottom=j.top+b(g).height()}if(j.left<e.left){e.left=j.left}if(j.top<e.top){e.top=j.top}if(j.right>e.right){e.right=j.right}if(j.bottom>e.bottom){e.bottom=j.bottom}});return e}})($j);(function(a){a.fn.filterOrFind=function(b){var c=a(this);return c.find(b).add(c.filter(b))}})($j);(function(){var a=Zendesk.NS("Forums.Search");$z.defModule("forums/_search",{initialize:function(b){b=b||{};b.forumsSearch=true;a.Instant.setup(b);a.Autocomplete.setup(b)}})})();$z.defModule("forums/form",{initialize:function(a){$j("input#forum_visibility_restriction_id_1, input#forum_visibility_restriction_id_2").click(function(){$j("#forum_is_locked_false").prop("disabled",false);$j(".forum-language-selector").show("slow")});$j("input#forum_visibility_restriction_id_3").click(function(){$j("#forum_is_locked_false").prop("disabled",true);$j("#forum_is_locked_true").prop("checked",true);$j(".forum-language-selector").hide();$j("#forum_translation_locale_id").val("")});$j("form.edit_forum").submit(function(){if(typeof(forumTagField)!="undefined"){forumTagField.beforeFormSubmit()}})}});(function(){function e(f){if(f!="stats"){$j(".sparkline").removeClass("active")}$j(".forum-nav a.active").removeClass("active");if(f){$j("#forum_nav_"+f).addClass("active")}else{$j(".forum-nav a:first").addClass("active")}}function d(){if($j(".category-header").attr("id")){$j(".category-header").map(function(f,g){categoryTopRightEdit($j(g).attr("id"));makeCategorizedForumsDraggable($j(g).parent().find(".category").attr("id"))});$j(".buttons-right .reorder").show();addCategoryReordering();categoryDescription();$j(".category-header").show()}else{return false}}function c(f){$j(".buttons-right .reorder").hide();$j("#detailed_stats_graph_container").hide();$j("#content_entries .frame:first").html('<div id="topic_search_loading" class="loading"></div>');$j.ajax({url:$j("#forum_nav_"+f).attr("url"),data:{xhr:true}}).done(function(g){$j("#content_entries").html(g);$j("#search-result").paginateResults();$j(".forum_tabs").trigger("events-loaded.entries.zendesk");if(f=="overview"){d()}});e(f)}function b(){$j("#comments_section").show();e("comments")}var a={initialize:function(f){f=f||{};f.scopeSammyTo=f.scopeSammyTo||".forum_tabs";$j(".category li span").truncateViaFade();this.sammy_app=$j.sammy(f.scopeSammyTo,function(){this.get("#stats/:statName",function(){$j(".buttons-right .reorder").hide();$j("#comments_section").hide();var g=this.params.statName;Zendesk.Stats.ForumUI.showDetailGraph(".sparkline#"+g);e("stats")});this.get("#stats",function(){$j(".buttons-right .reorder").hide();$j("#comments_section").hide();Zendesk.Stats.ForumUI.showDetailGraph(".sparkline:first");e("stats")});this.get("#overview",function(){c("overview")});this.get("#recent",function(){c("recent")});this.get("#popular",function(){c("popular")});this.get("#unanswered",function(){c("unanswered")});this.get("#answered",function(){c("answered")});this.get("#planned",function(){c("planned")});this.get("#not_planned",function(){c("not_planned")});this.get("#done",function(){c("done")});this.get("#comments",function(){b()});this.get("",function(){$j("#detailed_stats_graph_container").hide();var g=$j(".forum-nav a:first").attr("href");if(g){if(g=="#comments"){b();return false}e(g.replace("#",""));d();$j(".forum_tabs").trigger("events-loaded.entries.zendesk")}})});Zendesk.Stats.ForumUI.setup(this.sammy_app);this.sammy_app.disable_push_state=true;this.sammy_app.run()}};$z.defModule("forums/index",a);$z.defModule("forums/show",a);$z.defModule("forums/forums1_index",a);$z.defModule("forums/forums2_index",a)}());function InvitationForm(a){this.container=$j(a);this.emails=[];this.fieldColor=this.field().css("color");this.fieldText=this.field().val();this.resetField();this.registerEvents();this.invite()}InvitationForm.prototype={container:null,emails:null,fieldText:null,fieldColor:null,registerEvents:function(){var a=this;a.form().submit(function(){$j.ajax({data:$j(this).serialize(),type:$j(this).attr("method"),url:$j(this).attr("action"),beforeSend:function(b){a.inviting()},success:function(b){a.add(b);a.invited()},error:function(b,d,c){a.error().html(b.responseText);a.error().show();a.enableButton()}});return false});a.link().click(function(){a.invite();return false});a.field().click(function(){if(a.field().val()===a.fieldText){a.field().css("color",a.fieldColor);a.field().val("")}});a.field().blur(function(){if($j.trim(a.field().val()).length===0){a.resetField()}})},add:function(b){var a=this;$j.each(b.split(", "),function(d,c){if(!a.emails.include(c)){a.emails.push(c)}})},present:function(){return this.emails.join(", ")},invite:function(){this.enableButton();this.form().show();this.link().hide();this.notice().hide();this.error().hide()},inviting:function(){this.button().val("Sending invitation...");this.button().prop("disabled",true)},invited:function(){this._trackInvitation(this.emails);this.notice().html("You have invited "+this.present()+" to your help desk.");this.form().hide();this.resetField();this.link().show();this.notice().show();this.error().hide()},enableButton:function(){this.button().val("Invite!");this.button().prop("disabled",false)},resetField:function(){this.field().val(this.fieldText);this.field().css("color","gray")},form:function(){return this.container.find("form")},link:function(){return this.container.find("a")},notice:function(){return this.container.find("div#notice")},error:function(){return this.container.find("div#error")},field:function(){return this.container.find("textarea#email")},button:function(){return this.container.find("input[type='submit']")},_trackInvitation:function(b){var a=this.form();_(b).each(function(c){a.trackEvent()})}};Zendesk.NS("GettingStartedLocalized",function(e){var c="Admin GS Localized";function d(){e("#getting_started_localized").attr("data-tracking-module",c);a("Load")}function a(f){Zendesk.Instrumentation.ToTango.track(f,c)}function b(){var f=e("#contact_us");if(!f.exists()){return}Zenbox.init({dropboxID:f.data("feedback-tab-id"),url:"https://support.zendesk.com",tabID:"support",tabColor:"black",tabPosition:"Left",hide_tab:true});f.find("a").click(function(){Zenbox.show();a("Contact us link")})}e(document).ready(function(){if(!e("#getting_started_localized").exists()){return}d();b()})},this.jQuery);function PhotoForm(){this.container=$j("#customize_photo");this.registerEvents();if(this.image().attr("src")===this.defaultImage){this.showForm()}else{this.showLinks()}this.error().hide()}PhotoForm.prototype={defaultImage:"/images/frame_user.png",container:null,registerEvents:function(){var a=this;a.field().change(function(){if($j.trim(a.field().val()).length!==0){a.processing(I18n.t("txt.admin.public.javascript.views.getting_started.uploading_image"));a.form().submit()}return false});a.frame().load(function(){var c=$j("#upload_frame").contents().find("body").text();if($j.trim(c).length!==0){try{var b=$j.parseJSON(c);a.setPhoto(b.public_filename,b.id);a.form().trackEvent();a.error().hide()}catch(d){a.error().html(I18n.t("txt.admin.public.javascript.views.getting_started.error_while_uploading_image"));a.error().show()}a.showLinks()}});a.changeLink().click(function(){a.showForm();return false});a.deleteLink().click(function(){if(!a.photoId()){a.error().html(I18n.t("txt.admin.public.javascript.views.getting_started.sorry_gravatars_cannot_be_deleted"));a.error().show();return false}$j.ajax({type:"delete",url:"/photos/"+a.photoId()+"?format=js",beforeSend:function(b){a.processing(I18n.t("txt.admin.public.javascript.views.getting_started.deleting_image"))},success:function(b){a.setPhoto(a.defaultImage,"");a.showForm();a.error().hide()},error:function(b,d,c){a.error().html("There was an error deleting the image. Please try again or contact our support team.");a.error().show();a.showLinks()}});return false})},showForm:function(){this.processingIndicator().hide();this.form().show();this.modifyLinks().hide()},processing:function(a){this.processingMessage().html(a);this.processingIndicator().show();this.form().hide();this.modifyLinks().hide()},showLinks:function(){this.field().val("");this.processingIndicator().hide();this.form().hide();this.modifyLinks().show()},photoId:function(){return this.image().attr("data-id")},setPhoto:function(a,b){this.image().attr("data-id",b);this.image().attr("src",a)},processingIndicator:function(){return this.container.find("div#processing_indicator")},processingMessage:function(){return this.container.find("span#processing_message")},modifyLinks:function(){return this.container.find("div#modify_photo")},changeLink:function(){return this.container.find("a#change_photo")},deleteLink:function(){return this.container.find("a#delete_photo")},error:function(){return this.container.find("div#error")},frame:function(){return this.container.find("#upload_frame")},image:function(){return this.container.find("img#user_photo")},field:function(){return this.container.find("input[type='file']")},form:function(){return this.container.find("form")}};Zendesk.NS("GettingStarted",function(w){var p=w("#invite_block");var b=w("#test_block");var c=w("#customize_block");var r=w(".block");var e=null;var q="Admin GS";function u(x){x.removeClass("closed").removeClass("shrunk").addClass("opened");r.not(x).addClass("closed").addClass("shrunk").removeClass("opened")}function h(x){x.addClass("done")}function t(){r.addClass("closed").removeClass("shrunk").removeClass("opened")}function v(){w(".opened .block_button").live("click",function(){h(w(this).closest(".block"));t();s()});w(".closed .block_button, .shrunk .block_button").live("click",function(){u(w(this).closest(".block"));s()});w(".block_button").mouseover(function(){w(this).closest(".block").addClass("highlighted")}).mouseout(function(){w(this).closest(".block").removeClass("highlighted")});w(".close_block_link").click(function(){t();s();return false})}function m(){p.find("form").submit(function(){var y=w(this).find("input[type='submit']");var z=w(this).find("input[type='text']");var x=w("#invitation_result");w.each(z.val().split(/[\s,;]+/),function(B,A){k("Invite agent")});w.ajax({data:w(this).serialize(),type:w(this).attr("method"),url:w(this).attr("action"),beforeSend:function(A){y.prop("disabled",true).val("Inviting...")},success:function(A){x.html("Invite sent successfully!");z.val("")},error:function(A,C,B){x.html(A.responseText)},complete:function(){y.prop("disabled",false).val("Invite!")}});return false})}function g(){b.find("form").submit(function(){var y=w(this).find("input[type='submit']");var x=w("#test_ticket_result");w.ajax({data:w(this).serialize(),type:w(this).attr("method"),url:w(this).attr("action"),beforeSend:function(z){y.prop("disabled",true).val("Sending Test Email...")},success:function(z){y.hide();x.html("Test ticket was sent successfully.")},error:function(z,B,A){y.prop("disabled",false).val("Error. Try again...")}});return false})}function j(){w("#test_macro_form").submit(function(){var x=w(this).find("input[type='submit']");w.ajax({data:w(this).serialize(),type:w(this).attr("method"),url:w(this).attr("action"),beforeSend:function(y){x.prop("disabled",true).val("Creating ticket and macro...")},success:function(y){x.val("Ticket and macro created")},error:function(y,A,z){x.prop("disabled",false).val("Error. Try again...")}});return false})}function d(){w(".setup_item.closed").mouseover(function(){w(this).addClass("highlighted")}).mouseout(function(){w(this).removeClass("highlighted")});w(".setup_item.closed").click(function(){w(this).removeClass("closed").addClass("opened");w(this).find(".setup_item_content").slideDown()});w(".setup_item .close_setup_item").click(function(){w(this).siblings(".setup_item_content").hide();w(this).closest(".setup_item").removeClass("opened").addClass("closed");return false});w("#macros_setup").trigger("click")}function f(){w(".show_unsolved_tickets").click(function(){return n("tab_views",null,"tickets_arrow")});w(".show_forums").click(function(){return n("tab_forums",null,"forums_arrow")});w(".show_customization").click(function(){return n("tab_settings","settings_account","customization_arrow")});w(".show_people_agents").click(function(){return n("tab_manage","manage_people","people_agents_arrow")});w(".show_people_groups").click(function(){return n("tab_manage","manage_people","people_groups_arrow")});w(".show_ticket_fields").click(function(){return n("tab_manage","ticket_fields","ticket_fields_arrow")});w(".show_triggers").click(function(){return n("tab_manage","triggers","triggers_arrow")});w(".show_macros").click(function(){return n("tab_manage","macros","macros_arrow")});w(".show_automations").click(function(){return n("tab_manage","automations","automations_arrow")})}function n(y,x,z){w("li.tab_manage, li.tab_settings").removeClass("over");w(".show_me_arrow").hide();clearTimeout(e);w("html,body").animate({scrollTop:0},"slow");y=w("li."+y);z=w("#"+z);var A="0 2";if(x){x=w("li[data-menu-item-name="+x+"]");y.addClass("over");A="-192 -33"}z.show();z.position({my:"top",at:"bottom",of:x||y,offset:A});e=setTimeout(function(){z.hide();y.removeClass("over")},5000);return false}function l(){w("#getting_started_revamp").attr("data-tracking-module",q);w(".block_button").click(function(){var y=w(this).closest(".block");var x=y.attr("data-tracking-activity");if(y.hasClass("opened")){k(x+": Done")}else{if(y.hasClass("done")){k(x+": Revisit")}else{k(x+": Start")}}});k("Load")}function k(x){Zendesk.Instrumentation.ToTango.track(x,q)}function s(){r.each(function(){Zendesk.SettingsCookie.set(o(w(this)),w(this).attr("class"))})}function a(){r.each(function(){var y=w(this);var x=Zendesk.SettingsCookie.get(o(y));if(x&&x.include("done")){h(y)}if(x&&x.include("opened")){u(y)}})}function o(x){return"_zendesk_getting_started_"+x.prop("id")}w(document).ready(function(){if(!w("#getting_started_revamp").exists()){return}v();m();g();d();j();f();a();l()})},this.jQuery);$z.defModule("getting_started/show",{initialize:function(a){if(!$j("#getting_started").exists()){return}this.setInstrumentationModule();new InvitationForm("div#invite_agents");new InvitationForm("div#invite_testers");new SignatureForm();new PhotoForm();this.attachModalVideo();this.trackPageView();$j("#getting_started .adventure_set a, #getting_started .getting-started-steps a").instrumentTracking()},attachModalVideo:function(){$j(".aside_fixed a").instrumentTracking().click(function(a){a.preventDefault();$j.colorbox({inline:true,href:"#modal_content"})})},setInstrumentationModule:function(){var a;if(currentUser.isAdmin){a="Admin Getting Started"}else{a="Agent Getting Started"}$j("#getting_started").attr("data-tracking-module",a);this.instrumentationModule=a},trackPageView:function(){Zendesk.Instrumentation.ToTango.track("Load",this.instrumentationModule)}});function SignatureForm(){this.container=$j("#customize_signature");this.registerEvents();this.send()}SignatureForm.prototype={container:null,registerEvents:function(){var a=this;a.form().submit(function(){$j.ajax({data:$j(this).serialize()+"&id="+Zendesk.currentUser.id+"&authenticity_token="+encodeURIComponent(Zendesk.currentUser.authenticityToken),type:"PUT",url:$j(this).attr("action")+"?format=js",beforeSend:function(b){a.sending()},success:function(b){a.text().html(b.value);a.sent();a.form().trackEvent()},error:function(b,d,c){a.error().html(b.responseText);a.error().show();a.enableButton()}});return false});a.link().click(function(){a.send();return false})},send:function(){this.enableButton();this.form().show();this.link().hide();this.notice().hide();this.error().hide()},sending:function(){this.button().val(I18n.t("txt.admin.public.javascript.views.getting_started.saving_signature"));this.button().prop("disabled",true)},sent:function(){this.notice().html(I18n.t("txt.admin.public.javascript.views.getting_started.signature_updated"));this.form().hide();this.link().show();this.notice().show();this.error().hide()},enableButton:function(){this.button().val(I18n.t("txt.admin.public.javascript.views.getting_started.save_signature"));this.button().prop("disabled",false)},form:function(){return this.container.find("form")},link:function(){return this.container.find("a")},notice:function(){return this.container.find("div#notice")},error:function(){return this.container.find("div#error")},text:function(){return this.form().find("textarea")},button:function(){return this.form().find("input[type='submit']")}};var HeaderRenderer={};HeaderRenderer.hasRenderedTopRight=false;HeaderRenderer.renderTopRight=function(){var e=$j("#top-right");if(!e||HeaderRenderer.hasRenderedTopRight){return}HeaderRenderer.hasRenderedTopRight=true;var d=[];if(!currentUser.isAnonymous){var b=currentUser.first_name;if(currentAccount.isSandbox){b=b+" (SANDBOX)"}if(currentUser.isAgent||currentAccount.showUserProfile){d.push($j("<a />",{id:"top-right-name",href:"/users/"+currentUser.id,html:b}))}else{d.push($j("<span/>",{id:"top-right-name",html:b}));if(currentAccount.showChangePassword){d.push($j("<a/>",{href:"/password",text:I18n.t("txt.layout.change_pwd")}))}}if(currentUser.localeIsDifferent){d.push($j("<a />",{href:"?locale="+currentUser.locale_id,text:currentUser.localeIsDifferent}))}}if(currentUser.isAdmin||(currentUser.isAgent&&(currentAccount.isLotusVisibleToAgents||currentAccount.doAgentsPreferLotus))){var c=(currentAccount.doAgentsPreferLotus)?I18n.t("txt.views.shared.header.back_to_agent"):I18n.t("txt.views.shared.header.try_the_new_zendesk"),a="https://"+currentAccount.subdomain+"."+currentAccount.domain+"/agent/";if(window.ticket_id){a+="#/tickets/"+window.ticket_id}d.push('<a href="/?return_to='+escape(a)+'">'+c+"</a>")}if(Zendesk.viewedOnMobileDevice&&currentAccount.hasFeature("mobile")){var f=document.location.href;d.push('<a href="/mobile/switch?return_to='+escape(f)+'">'+I18n.t("txt.views.shared.header.go_to_mobile_site")+"</a>")}if(currentUser.isAgent&&currentAccount.lastTrialDay){d.push(I18n.t("txt.admin.public.javascript.header_renderer.days_left_in_trial_label_with_params",{count:currentAccount.daysLeftInTrial}));jQuery("#expires_badge .count").text(currentAccount.daysLeftInTrial)}if(currentUser.isAdmin){d.push('<a href="http://support.zendesk.com">'+I18n.t("txt.admin.public.javascript.header_renderer.help")+"</a>")}if(currentUser.assumed){d.push('<a href="/users/revert">'+I18n.t("txt.javascript.views.agent_console.revert_identity")+"</a>")}if(currentUser.isAnonymous){d.push($j("<a/>",{href:"/login",text:I18n.t("txt.layout.login")}));if(currentAccount.isOpen&&!currentAccount.hasRemoteAuthentication){d.push($j("<a/>",{href:"/registration",text:I18n.t("txt.layout.signup")}))}}else{d.push($j("<a/>",{href:"/access/logout",text:I18n.t("txt.layout.logout")}))}if(d.length>0){e.append(d.shift());d.each(function(g){e.append(" | ");e.append(g)})}};function buildOrganizationLink(c,a){var d="/organizations/"+c.id+"/requests";var b={href:d,text:c.name.truncate(35)};if(a){b["class"]=a}return $j("<a>",b)[0]}HeaderRenderer.hasUpdatedTabs=false;HeaderRenderer.updateTabs=function(){var d=$j("#top-menu > ul#green").first();if(!d||HeaderRenderer.hasUpdatedTabs){return}HeaderRenderer.hasUpdatedTabs=true;if(currentUser.isAnonymous){if(!currentAccount.isOpen){d.find("> li:not(.right, .tab_home)").remove()}else{if(!currentAccount.hasRemoteAuthentication&&!currentUser.hasEmail){d.find("> li.tab_new a").attr("href","/anonymous_requests/new")}}}if(currentUser.accessibleForums){var f=$j('<li class="main tab_forums"/>');f.append($j("<a/>",{"class":"tab",href:"/forums",text:currentAccount.forumsTitle}));d.find("> li.tab_home").after(f)}if(currentUser.isEndUser){var e=d.find("> li:not(.right)").last();var c=$j('<li class="main tab_organization"/>');if(currentUser.canViewMultipleOrganizations){c.append($j("<a/>",{"class":"tab",href:"#",text:I18n.t("txt.layout.organization_requests")}));var b=$j('<ul class="menu-drop">');currentUser.sharedOrganizations.each(function(j,g){var h=$j("<li>").append(buildOrganizationLink(j))[0];b.append(h)});c.append(b)}else{if(currentUser.canViewOrganization){c.append(buildOrganizationLink(currentUser.organization,"tab"))}}e.after(c)}d.find("> li.first").removeClass("first");d.find("> li.active").removeClass("active");d.find("> li").first().addClass("first");d.find("> li").addClass("main");var a=d.find("> li.tab_"+Zendesk.tab);a.removeClass("main").addClass("active");a.next().addClass("first")};if(typeof(currentUser)!=="undefined"){HeaderRenderer.renderTopRight();HeaderRenderer.updateTabs()}(function(){var a=Zendesk.NS("Forums.Search");$z.defModule("home/_home_page_search_box",{initialize:function(b){b=b||{};b.homePageSearch=true;a.Autocomplete.setup(b)}})})();$z.defModule("home/index",{initialize:function(){if(currentUser.isAgent){$j("#dashboard").ready(function(){$j("#dashboard").show();$j.get("/home/dashboard",function(a){$j("#dashboard").html(a).show()})})}if(currentUser.isAdmin){new IntroductoryTextForm()}if(currentUser.managePinnedOrder){$z("home/reorder_pinned_entries").initialize()}$z("forums/index").initialize()}});(function(b,c){var a=b.IntroductoryTextForm=function(){this.form=c("#introductory_text .introductory_text_form");this.display=c("#introductory_text .introductory_display_texts");this.editLink=this.display.find(".edit_this");this.cancelLink=this.form.find(".cancel_link");this.setup()};a.prototype={setup:function(){var d=this;this.form.hide();this.editLink.click(function(){d.display.hide();d.form.show()});this.cancelLink.click(function(){d.form.hide();d.display.show()})}}}(window,$j));(function(j,p){var e,b,d,m,r,f;function q(){document.location.href="/home"}function c(){alert("Sorry, there was an error saving your changes.")}function k(){var t=j(this);var s=r.find("ol").sortable("serialize",{key:"ids[]"});if(s=="ids[]="){s=""}else{s=s+"&"}j.ajax({url:t.attr("action"),type:t.attr("method"),data:s+t.serialize(),success:q,error:c});return false}function n(){m.hide();d.show();r.remove();r=null}function g(){r.find("a.cancel").click(function(){n();return false}).end().find("form").submit(k);var s=r.find("ul,ol");s.each(function(){j(this).sortableWithEmptyTarget({emptyTargetText:I18n.t("txt.admin.views.home._reorder_pinned_entries.drag_topics_here_label"),emptyTargetClass:"item sortable",axis:"y",placeholder:"sortable item target",connectWith:s.not(this)})})}function l(s){return !!s.pinned_index}function o(){if(r){return}j.getJSON(b.attr("href"),null,function(s){s=p(s);r=j(j.mustache(e,{orderedEntries:s.select(l),unorderedEntries:s.reject(l)})).appendTo(m);f.hide();g()})}function a(){d.hide();m.show();o()}function h(){e=j("#reorder_pinned_entries_template").html();m=j('<div class="frame"></div>').hide().insertAfter(j("#pinned_topics_title"));f=j('<div class="loading">&nbsp;</div>').appendTo(m);b=j("#show_pinned_entries_reordering").click(function(){a();return false});d=j("#pinned-entries-frame, #entries_pagination").add(b)}$z.defModule("home/reorder_pinned_entries",{initialize:h})}(this.jQuery,this._));jQuery(function(f){var c=f(".home #suggest_form");if(c.length===0){return}var g=f("#topic_search"),b=f("#topic_search_result"),a=f("#topic_search_loading"),d=f("#show_more_results");function h(k){a.removeClass("loading");g.show();b.html(k);var j=Zendesk.ResultsPaginator.parseNextPageFrom(b);if(j==null){d.hide();if(b.is(":empty")){b.html('<h2 class="empty_suggestion_set">'+I18n.t("txt.entries.list.empty")+"</h2>")}}else{b.paginateResults()}}function e(j){g.hide();a.addClass("loading");b.html("");f.get("/categories/search_for_home_page_box?"+c.serialize(),{format:"html",for_search:1,page:1}).done(h);return false}c.submit(e)});if(!this.Zendesk){this.Zendesk={}}(function(d,b,a,c){a.Banner={containerSelector:"#banners",container:function(){var f=a.Banner;var e=d(f.containerSelector);if(e.length<=0){b.error("Could not find a banner container. Do you have an "+f.containerSelector+" element?")}else{return f._bindIgnoreEventListenerIfNeeded(e)}},templateSelector:"#banner-item-template",template:function(){var e=a.Banner;if(!e._template){var f=d(e.templateSelector).first();if(f.length<=0){b.error("Could not find a Banner template. Do you have an "+e.templateSelector+" element?")}else{e._template=f.html()}}return e._template},_ignoreEventListenerBound:false,_bindIgnoreEventListenerIfNeeded:function(e){var f=a.Banner;if(!f._ignoreEventListenerBound){e.bind("ignore.zd.banner",function(h,g){g.disappear();return true});e.bind("reload.zd.banner",function(h,g){window.location.reload(true);return true});f._ignoreEventListenerBound=true}return e},create:function(g){var f=a.Banner;var e=d.extend({},f._buildLI(g||{}),f._enhancements);d(e).find(".ignore").click(function(){d(e).trigger("ignore.zd.banner",[e])});d(e).find(".reload a").click(function(){d(e).trigger("reload.zd.banner",[e]);return false});return e.appendTo(f.container())},_buildLI:function(f){var e=d(d.mustache(a.Banner.template(),{text:(f.text||"")}));if(!(f.visible)){e.hide()}["icon","ignore","reload"].each(function(g){if(f[g]===false){e.find("."+g).hide()}});return e},_enhancements:{toString:function(){return"<banner text="+this.content().text()+">"},setContent:function(e){this.content().html(e);return this},appear:function(f){var e=this;e.slideDown(null,function(){e.trigger("appear.zd.banner",[e]);f&&f()});return e},disappear:function(f){var e=this;e.slideUp(null,function(){e.trigger("disappear.zd.banner",[e]);f&&f()});return e},visible:function(){return this.filter(":visible").length>0},hidden:function(){return this.filter(":hidden").length>0}}};c(["icon","content","ignore","reload"]).each(function(e){a.Banner._enhancements[e]=function(){return d(this).find("."+e)}})})(this.jQuery,this.console,this.Zendesk,this._);jQuery(function(a){a("#top-menu li.tab_getting_started").each(function(c,b){var e=a(b);var d=e.find("> a").text().strip();if(d.length>0){e.attr("data-tracking-activity",d);e.find("a").instrumentTracking()}})});$z.defModule("monitor/children/show",{initialize:function(a){$j("#subscription_payment_method_type").change(function(){if($j("#subscription_payment_method_type").val()==0){$j("#manual-discount-options").show()}else{$j("#manual-discount-options").hide()}});$j("#subscription_payment_method_type").change();$j("#account_settings_monitored_facebook_page_limit").change(function(){$j("#fb_page_limit").html($j(this).val())});$j("#get_unadded_numbers").click(function(){var b=$j(this).attr("value");$j("#unadded_numbers").html("Loading");$j.get("/monitor/children/find_unadded_numbers",{account_id:b},function(c){$j("#unadded_numbers").html(c);$j(".add_phone_number").click(function(){var e=$j("#get_unadded_numbers").attr("value");var f=$j(this);var d=f.attr("sid");var g=$j("input[@name=country"+d+"]:checked");if(g.length==0){g=$j("input[name$=country"+d+"]")}$j("#unadded_number_"+d).html("<td colspan='4'>Loading</td>");$j.post("/monitor/children/add_unadded_number",{account_id:e,phone_number:f.attr("number"),sid:d,country:g[0].value},function(h){$j("#unadded_number_"+d).html(h)})})})})}});$z.defModule("monitor/payments/show",{initialize:function(a){$j("#refund_button").click(function(){$j.colorbox({href:"#refund_form",inline:true});return false})}});$z.defModule("monitor/search/index",{initialize:function(){this.checkIndexed();this.captureReindex()},checkIndexed:function(){var a=this;$j(".indexable").each(function(){a.updateIndexed($j(this))})},updateIndexed:function(a){var b=a.attr("data-indexable").split("-");$j.getJSON("/monitor/search/check_indexed",{id:b[0],account:b[1]},function(c){a.addClass("indexable indexed").toggleClass("not",!c).text(c?"indexed":"unindexed")})},captureReindex:function(){var a=this;$j(".reindexable").each(function(){$j(this).bind("submit",function(e){var b=$j(e.target);var c=b.attr("id");var g=c.split("-")[1].split("_");var h=g[0];var d=g[1];var f=g[2];$j.post(b.attr("action"),{id:h,type:d,account:f},function(){$j(b.find("button").first()).text("Reindexed");var j=h.split("@").reverse().join("_");a.updateIndexed($j("#check_indexed-"+h+"_"+d+"_"+f))});return false})})}});$z.defModule("people/bulk_delete/index",{initialize:function(){this.form=$j("#bulk_form");this.check=$j("#bulk_check_all");this.submitBtn=$j("#bulk_submit");this.checkboxes=$j("#bulk_form .bulk_check_one");this.toggleBulkSubmit();this.check.change($j.proxy(this.manageBulkUpdate,this));this.checkboxes.change($j.proxy(this.toggleBulkSubmit,this));this.submitBtn.click($j.proxy(this.submitBulkForm,this))},manageBulkUpdate:function(b){var a=this.check.prop("checked");this.checkboxes.prop("checked",a);this.toggleBulkSubmit()},submitBulkForm:function(a){if(a){a.stopPropagation();a.preventDefault()}if(!this.anyChecked()){return}$j("#bulk_spinner").show();$j.ajax({type:this.form.attr("method"),url:this.form.attr("action"),data:this.form.serialize(),success:function(b){clearFlash();$j.colorbox({html:b});$j("#bulk_spinner").hide()},error:function(b){showFlash("Error:"+b,"error");$j("#bulk_spinner").hide()}})},toggleBulkSubmit:function(b){var a=this.anyChecked();this.submitBtn.prop("disabled",!a);this.submitBtn.toggleClass("button_disabled",a)},anyChecked:function(){return $j("#bulk_form .bulk_check_one:checked").length>0}});Zendesk.NS("Groups");Zendesk.Groups.DeletionVerifier=function(a){this.form=$j(a)};Zendesk.Groups.DeletionVerifier.prototype={init:function(){this.attachHandlers()},attachHandlers:function(){var a=this;this.form.find("#delete-group").click(function(b){a.showModal()})},showModal:function(){var a=this;$j.colorbox({href:"./confirm_delete",inline:false,onComplete:function(){a.attachModalHandlers()}})},attachModalHandlers:function(){$j("#group-delete-confirm #cancel-delete").click(this.closeModal)},closeModal:function(){$j.colorbox.close()}};$z.defModule("people/groups/edit",{initialize:function(){this.verifier=new Zendesk.Groups.DeletionVerifier("#account-settings");this.verifier.init()}});$z.defModule("people/groups/show",{initialize:function(){$z("people/search/index").initialize()}});$z.defModule("people/organizations/edit",{initialize:function(a){$j("form#account-settings").submit(function(){if(typeof(organizationTagField)!="undefined"){organizationTagField.beforeFormSubmit()}})}});$z.defModule("people/organizations/show",{initialize:function(){$z("people/search/index").initialize()}});Zendesk.NS("People.Passwords",function(d){var a=0;var c=0;var b=function(f){var e=f.sequence;if(e<c){return}c=e;var h=_(f.errors);var g=d("#password_requirements ul li");_(g).each(function(l){var k=d(l);var j=d.trim(k.text());if(h.contains(j)){k.addClass("invalid").removeClass("valid")}else{k.addClass("valid").removeClass("invalid")}})};d(document).ready(function(){d(".validate_password").keyup(function(f){var e=currentAccount.secureUrlPrefix+"/password/validate_password";d.ajax({type:"POST",url:e,data:{password:d(this).val(),sequence:a+=1},success:b})})})},jQuery);Zendesk.NS("People.Roles",function(k){var f=k("#permission_set_permissions_ticket_access");var j=k("#permission_set_permissions_forum_access");var h=k("#permission_set_permissions_end_user_profile");var d=k("#permission_set_form");var a=d.data("light-agent");function e(p){var t=k("#ticket_access_message");var y=k("#assign_to_any_group");var x=k("#permission_set_permissions_ticket_editing");var w=k("label[for='permission_set_permissions_ticket_editing']");var m=function(){var z="To deselect this option, you must change ticket access selection";x.prop("checked",true).prop("disabled",true).prop("title",z).change();w.prop("title",z)};var v=function(){x.prop("disabled",a).removeAttr("title");w.removeAttr("title")};var s=function(){t.html(I18n.t("txt.admin.javascrips.views.people.roles.user_belongs_group")).show()};var r=function(){y.show()};var o=function(){t.html(I18n.t("txt.admin.javascrips.views.people.roles.user_belongs_organization")).show()};var u=function(){t.hide()};var n=function(){y.hide()};var q={"assigned-only":[u,n,m],"within-groups":[s,r,v],"within-organization":[o,n,v],all:[u,n,v]};if(x.exists()){p.selectInteraction(q)}}function c(s){var m=k("#permission_set_permissions_forum_access_restricted_content");var p=k("label[for='permission_set_permissions_forum_access_restricted_content']");var n=k("#permission_set_manage_help_center");var o=function(){var t="To deselect this option, you must change forums editing permission";m.prop("checked",true).prop("disabled",true).prop("title",t);p.prop("title",t)};var r=function(){m.prop("disabled",false).removeAttr("title");p.removeAttr("title")};var q={full:o,"default-interaction":r};if(m.exists()){s.selectInteraction(q)}if(n.exists()){n.prop("disabled",a)}}function b(r){var m=k("#people_editing_options");var o=k("#permission_set_permissions_edit_organizations");var n=function(){m.slideDown();o.prop("disabled",false)};var p=function(){m.slideUp();o.prop("disabled",true)};var q={edit:n,full:n,"default-interaction":p};k(r).selectInteraction(q)}function l(){if(f.exists()){e(f)}if(j.exists()){c(j)}if(h.exists()){b(h)}}function g(){var m=k("[name='permission_set[permissions][assign_tickets_to_any_group]']");d.find(":input").not(":submit, [name='_method'], [name='authenticity_token']").not(f).not(m).prop("disabled",true)}k(document).ready(function(){l();if(a){g()}})},this.jQuery);function UserMergeWizard(a){this.redirectToWinner=a;this.registerEvents()}UserMergeWizard.prototype={redirectToWinner:false,lookupUser:function(b,a,c){new Ajax.Request("/users/"+b+"/merge/autocomplete",{method:"GET",parameters:{name:a,rand:(new Date()).getTime()},onSuccess:function(d){c(d.responseJSON)}})},registerEvents:function(){var a=this;$j("#merge_link").live("click",function(){$j.colorbox({href:$j(this).attr("href"),onComplete:function(){var c=a.winnerForm().attr("data-loser");var b=new Autocompleter.Cache(a.lookupUser.curry(c));new Autocompleter.Json("winner","winner_auto_complete",b.lookup.bind(b),{frequency:0.1,minChars:3});$j("input[placeholder]").placeholder()}});return false});a.winnerLinks().live("click",function(){$j.colorbox({href:$j(this).attr("href")});return false});a.winnerForm().live("submit",function(){$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),success:function(b){$j.colorbox({html:b})},error:function(b,d,c){$j.colorbox({html:b.responseText})}});return false});if(!a.redirectToWinner){a.confirmForm().live("submit",function(){$j.ajax({data:$j(this).serialize(),type:"POST",url:$j(this).attr("action")+"?format=js",beforeSend:function(b){a.confirmButton().val("Merging users...");a.confirmButton().prop("disabled",true)},success:function(b){$j.colorbox.close()},error:function(b,d,c){$j.colorbox({html:b.responseText});a.confirmButton().val("Confirm and Merge");a.confirmButton().prop("disabled",false)}});return false})}},winnerForm:function(){return $j("#winner_form")},winnerField:function(){return this.winnerForm().find("input[type='text']")},continueButton:function(){return this.winnerForm().find("input[type='submit']")},winnerLinks:function(){return $j(".winner_selector")},confirmForm:function(){return $j("#confirm_merge_form")},confirmButton:function(){return this.confirmForm().find("input[type='submit']")}};$z.defModule("people/users/edit",{initialize:function(c){var b=this;this.confirmationMessages={leavingLegacy:I18n.t("txt.admin.public.javascripts.views.people.users_edit.assigning_new_role"),downgradingRole:I18n.t("txt.admin.public.javascripts.views.people.users_edit.downgrading_role")};var a=$j("#user_voice_number"),e=$j("#test_call_button");if(a.exists()){a.live("keyup",function(f){if($j.trim($j(f.currentTarget).val())===""){e.attr("disabled","disabled")}else{e.removeAttr("disabled")}})}if($j("#original_roles").exists()){this.setupNonEnterpriseRoles(c);$j("#user_default_group_id").live("change",function(){var f=$j(this).val();$j("#user_groups_"+f).prop("checked",true)})}else{$j("#user_default_group_id").change(function(){b.enableGroup($j("#group_"+$j(this).val()))});b.enableGroup($j("#group_"+$j("#user_default_group_id").val()))}var d=$j("#role_and_groups_form");this.formElm=d.exists()?d:$j("#user-form");if($j(".role_groups").exists()){$j(".user_type, #user_role_or_permission_set").change($j.proxy(this.manageRoleDisplay,this));this.manageRoleDisplay();$j("#group_tiles .tile").click(function(f){var g=$j(f.target).hasClass("tile")?$j(f.target):$j(f.target).parents(".tile");b.selectGroup(g)});this.formElm.submit($j.proxy(this.confirmSaveForEnterprise,this))}else{this.formElm.submit({userId:c},$j.proxy(this.confirmSave,this))}$j("form#user-form [type=submit]").bind("click",function(f){if(typeof(userTagField)!="undefined"){userTagField.beforeFormSubmit()}});if($j("#identities").exists()){$j(".email.unverified_email .add_identity, .twitter .add_identity, .google .add_identity, .facebook .add_identity").colorbox({onComplete:function(){$j("#focus").focus()}});this.identitiesManager=new Zendesk.IdentitiesManager(c,$j.proxy(this.setupPrimary,this));this.renderIdentities(c)}$j("#status_spinner").addClass("spinner small").hide();$j("#test_call_button").click(function(h){h.preventDefault();$j("#test_call_status").removeClass("test_call_error");if($j("#test_call_button").val()===I18n.t("txt.admin.views.people.users.basic_info.test_call")){var g=$j("#user_voice_number").val();$j("#test_call_button").val(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.calling")+"...");$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.dialing",{number:g}));var j=b.prepCallData(g,$j("#user_voice_extension").val());$j("#status_spinner").fadeIn("slow");var k=$j.post("/voice/confirm_numbers/test_call",j,function(l){return l});function f(){var l=$j.get("/voice/confirm_numbers/test_call_status",{call_sid:k.responseText},function(m){return m});l.always(function(){var m=l.responseText;if(m==="queued"||m==="ringing"||m==="retry"){setTimeout(f,500)}else{if(m==="in-progress"){$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.forward_success",{number:g}));setTimeout(f,500)}else{if(m==="completed"){$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.test_success"));$j("#test_call_button").val(I18n.t("txt.admin.views.people.users.basic_info.test_call"));$j("#status_spinner").fadeOut("slow")}else{$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.test_error",{number:g}));$j("#test_call_status").addClass("test_call_error");$j("#test_call_button").val(I18n.t("txt.admin.views.people.users.basic_info.test_call"));$j("#status_spinner").fadeOut("slow")}}}})}}k.always(function(){setTimeout(f,1500)})})},prepCallData:function(b,e){var d={number:b},c=/^\s*(w*\d+#?)\s*$/,a=c.exec(e);if(a){d.ext=a[1]}return d},setupNonEnterpriseRoles:function(a){if($j("#user_roles_4").is(":checked")){$j("#agent_groups").html($j("#group-block").html())}if($j("#user_roles_2").is(":checked")){$j("#admin_groups").html($j("#group-block").html())}$j("#user-radio").click(function(){$j("#agent_groups, #admin_groups").empty();$j("#end_user_block").show();$j("#agent_block, #admin_groups").hide();$j("#user_restriction_id_4").click();$j("#display_name").hide()});$j("#user_roles_4").click(function(){$j("#agent_groups").html($j("#group-block").html());$j("#admin_groups").empty();$j("#agent_block").show();$j("#admin_groups, #end_user_block").hide();$j("#user_restriction_id_0").click();$j("#display_name").show()});$j("#user_roles_2").click(function(){$j("#admin_groups").html($j("#group-block").html());$j("#agent_groups").empty();$j("#agent_block, #end_user_block").hide();$j("#admin_groups").show();$j("#display_name").show()})},manageRoleDisplay:function(h){this.roleData=this.roleData||$j.parseJSON($j("#role_data").html());var b=$j("#roles_agent"),a=$j("#agent_details"),f=a.find(".description"),g=a.find(".headcount"),l=$j("#enduser_details"),c=$j('#enduser_details input[name="user[restriction_id]"]'),j=$j("#roles_enduser").prop("checked"),d=$j("#user_role_or_permission_set"),k=_(this.roleData).find(function(e){return e.id==d.val()});d.prop("disabled",j);l.toggle(j);a.toggle(!j);if(!j){c.prop("disabled",true);b.val(k.id=="admin"?2:4);f.html(k.description);g.html(k.headcount)}else{c.prop("disabled",false)}this.displayGroups(j)},displayGroups:function(a){$j("#groups_unavailable").toggle(a);$j("#groups_available").toggle(!a);if(a){$j("#group_tiles input").prop("disabled",true)}else{$j("#group_tiles input.empty").prop("disabled",false);_($j("#group_tiles .tile")).each(function(b){b=$j(b);if(b.hasClass("selected")){$j(b.find("input")).prop("disabled",false)}})}},selectGroup:function(a){if(a.hasClass("selected")){this.disableGroup(a)}else{this.enableGroup(a)}},enableGroup:function(a){a.addClass("selected");$j("input",a).prop("disabled",false)},disableGroup:function(a){a.removeClass("selected");$j("input",a).prop("disabled",true)},confirmSaveForEnterprise:function(d){if(d){d.stopPropagation();d.preventDefault()}var c=$j("#user_role_or_permission_set option:first-child").val()==="";var a=$j("#user_role_or_permission_set").val()!=="";var b=$j("#roles_agent").prop("checked");if(c&&b&&a){if(!confirm(this.confirmationMessages.leavingLegacy)){return false}}else{if(!this.confirmDemotion($j("#roles_enduser").prop("checked"))){return false}}this.formElm.unbind("submit");this.formElm.submit()},confirmSave:function(a){if(a){a.stopPropagation();a.preventDefault()}if(!this.confirmDemotion($j("#user-radio").prop("checked"))){return false}var b=$j("#user_roles_4").is(":checked")?"Agent":($j("#user_roles_2").is(":checked")?"Admin":"End-User");Zendesk.Instrumentation.ToTango.track(b,"User - Save");$j("#submit-button").val(a.data.userId?I18n.t("txt.users.edit.updating"):I18n.t("txt.users.edit.creating")).prop("disabled",true);this.formElm.unbind("submit");this.formElm.submit()},confirmDemotion:function(a){var b=this.formElm.data("is-agent");if(b&&a){return confirm(this.confirmationMessages.downgradingRole)}else{return true}},renderIdentities:function(c){var h,g,e,d,b,f;var a=this.identitiesManager.allPrimaryCandidates().length!==0;$j(this.identitiesManager.identities).each($j.proxy(function(k,j){h=$j("<a>",{href:"javascript: void(0);",html:I18n.t("txt.users.edit.delete_identity")}).click($j.proxy(this.deleteIdentity,this)).data("elmId",j.elmId).addClass("remove_link");g=$j("<span>",{html:j.name}).addClass("identity_name");e=$j("<span>",{html:"("+I18n.t("txt.users.edit.primary")+")",style:"display: none"}).addClass("primary_label");d=$j("<span>",{html:"("+I18n.t("txt.users.edit.email_not_verified")+")"}).addClass("status unverified");$j("<li>",{id:j.elmId}).append(g).append(j.isUnverified()?d:"").append((j.isPrimaryCandidate()&&!j.isUnverified())?e:"").append(h).appendTo($j(j.listElmId));if(this.identitiesManager.limitToSingleIdentity(j)){$j("."+j.identity_type+" .add_identity").hide()}if(!a&&j.isExternalIdentity){$j("#"+j.elmId).find(".remove_link").hide()}},this));b=this.identitiesManager.primary();if(typeof b!=="undefined"){f=$j("#"+b.elmId);f.find(".primary_label").show();f.find(".remove_link").hide()}this.setupPrimary()},setupPrimary:function(){var b=this.identitiesManager.allPrimaryCandidates();if(b.length>1||(b.length==1&&!b[0].isPrimary)){$j("#primary_section").show()}else{$j("#primary_section").hide();return}var a=$j("#primary_identity");this.renderPrimary(this.identitiesManager.primary());a.unbind("change",$j.proxy(this.updatePrimary,this));a.bind("change",$j.proxy(this.updatePrimary,this))},renderPrimary:function(b){var a=$j("#primary_identity");a.html("");if(b==undefined){a.append($j("<option>",{html:"&mdash;"}))}else{a.append($j("<option>",{value:b.elmId,html:b.name+" ("+I18n.t("txt.users.edit.primary")+")"}))}_(this.identitiesManager.allPrimaryCandidates()).each(function(c){if(c!=b){a.append($j("<option>",{value:c.elmId,html:c.name}))}})},updatePrimary:function(d){if(d){d.stopPropagation();d.preventDefault()}var c=this.identitiesManager.allPrimaryCandidates();if(c.length<1||(c.length==1&&c[0].isPrimary)){$j("#primary_section").hide();return}var a=$j("#primary_identity");var b=this.identitiesManager.find(a.val());var f=$j("<div>").addClass("spinner small").insertAfter(a);this.identitiesManager.makePrimary(b).done(function(){f.remove()}).fail(function(){f.remove()}).done($j.proxy(function(){this.renderPrimary(b);$j(".remove_link").show();$j("#"+b.elmId).find(".remove_link").hide();$j(".primary_label").hide();$j("#"+b.elmId).find(".primary_label").show();clearFlash()},this)).fail($j.proxy(function(e){this.setupPrimary();showFlash(e,"error")},this))},deleteIdentity:function(c){if(c){c.stopPropagation();c.preventDefault()}var b=$j(c.target);var a=this.identitiesManager.find(b.data("elmId"));if(!confirm(I18n.t("txt.users.edit.remove_account_confirmation",{identityName:a.name}))){return false}var d=$j("<div>").addClass("spinner small").insertAfter(b);b.hide();this.identitiesManager.remove(a).done(function(){d.remove()}).fail(function(){d.remove()}).done(function(){$j("."+a.identityType+" .add_identity").show();$j("#"+a.elmId).remove();clearFlash()}).fail(function(e){var f=JSON.parse(e.responseText);f.error&&showFlash(f.error,"error")})}});$z.defModule("people/search/index",{initialize:function(){if($j("#bulk_update").exists()){this.setupBulkUpdate()}},setupBulkUpdate:function(){var a=$j(".individual_bulk_checkbox");this.activeCheckboxes=$j(_(a.find(".checkbox")).select(function(b){return !$j(b).prop("disabled")}));if(this.activeCheckboxes.length<1){$j("#bulk_update").hide();a.hide()}else{this.bulkSubmitElm=$j("#bulk_submit");this.toggleBulkSubmit();$j("#bulk_check").change($j.proxy(this.manageBulkUpdate,this));this.activeCheckboxes.change($j.proxy(this.toggleBulkSubmit,this));$j("#bulk_submit").click($j.proxy(this.submitBulkForm,this))}},manageBulkUpdate:function(b){var a=$j("#bulk_check").prop("checked");this.activeCheckboxes.not(".disabled").prop("checked",a);this.toggleBulkSubmit()},submitBulkForm:function(a){if(a){a.stopPropagation();a.preventDefault()}if(!this.anyChecked()){return}$j("#bulk_check").hide();$j("#bulk_spinner").show();$j.ajax({type:"POST",url:"/users/select_bulk_action",data:($j("#bulk_form").serialize()),success:function(b){clearFlash();$j.colorbox({html:b});$j("#bulk_spinner").hide();$j("#bulk_check").show()},error:function(b){showFlash("Error:"+b,"error");$j("#bulk_spinner").hide();$j("#bulk_check").show()}})},toggleBulkSubmit:function(a){if(this.anyChecked()){this.bulkSubmitElm.prop("disabled",false);this.bulkSubmitElm.removeClass("button_disabled");this.bulkSubmitElm.addClass("button")}else{this.bulkSubmitElm.prop("disabled",true);this.bulkSubmitElm.removeClass("button");this.bulkSubmitElm.addClass("button_disabled")}},anyChecked:function(){return _(this.activeCheckboxes).any(function(a){return $j(a).prop("checked")})}});$z.defModule("people/users/merge",{initialize:function(){},switch_to_password_form:function(){$j("#user_merge_email_form").hide();$j("#user_merge_password_form").show();$j.colorbox.resize();$j("#user_merge_email_for_password_form").val($j("#user_merge_email").val());$j("#user_merge_password_email_display").html($j("#user_merge_email").val())},on_email_submit:function(){if(this.email_validate($j("#user_merge_email").val())){this.toggle_form("email");return false}else{alert(I18n.t("txt.user.merge.enter_valid_email"));return true}},on_password_submit:function(){if($j("#user_merge_password").val()!==""){this.toggle_form("password");return false}else{alert(I18n.t("txt.user.merge.enter_valid_password"));return true}},email_validate:function(a){var b=/^([A-Za-z0-9_\+\-\.])+(\+[0-9]+)?\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;return b.test(a)},password_does_not_match:function(a){this.toggle_form("password");alert(a)},toggle_form:function(a){$j("#user_merge_waiting_for_"+a).toggle();$j("#user_merge_submit_"+a).toggle()}});$z.defModule("people/users/new",{initialize:function(a){$z("people/users/edit").initialize(a)}});$z.defModule("people/users/show",{initialize:function(b){this.userId=b;var a=$j("#suspend_access");this.userSuspended=(a.attr("data-user-suspended")!=="false");if(this.userSuspended){$j("#suspended").show()}$j("a.toggle-twitter-data").click(function(){$j(this).closest("p.user-twitter").next(".twitter-properties").slideToggle(50)});$j(".visibility-controls").click(function(){$j("a.toggle-twitter-data",this).toggle()});$j("#make_direct_number_link").click(function(c){$j.colorbox({inline:true,href:"#make_direct_number_layer"});if(c){c.preventDefault()}});$j("#edit_number_link").click(function(c){$j.colorbox({inline:true,href:"#edit_number_layer"});if(c){c.preventDefault()}});new UserMergeWizard(true);this.setSuspensionActionText();a.click($j.proxy(this.setSuspensionStatus,this))},setSuspensionStatus:function(b){b.preventDefault();if(this.settingStatus===true){return}this.settingSuspensionStatus=true;var a="/users/"+this.userId;$j.ajax({url:a,type:"PUT",dataType:"json",dataFilter:function(c){trimmed_data=$j.trim(c);if(trimmed_data==""){return"{}"}else{return c}},data:{authenticity_token:currentUser.authenticityToken,user:{suspended:!this.userSuspended}},success:$j.proxy(function(){this.userSuspended=!this.userSuspended;this.setSuspensionActionText();$j("#suspended").toggle(this.userSuspended);showFlash((this.userSuspended?I18n.t("txt.admin.javascrips.users_show.user_suspended_label"):I18n.t("txt.admin.javascrips.users_show.user_unsuspended_label")),"notice");this.settingSuspensionStatus=false},this),error:function(c){var d=this.userSuspended?"suspend":"unsuspend";if(d=="suspend"){message=I18n.t("txt.admin.javascrips.users_show.suspend_user_label")}else{message=I18n.t("txt.admin.javascrips.users_show.unsuspend_user_label")}showFlash(message,"error");this.settingSuspensionStatus=false}})},setSuspensionActionText:function(){$j("#suspend_access").html(this.userSuspended?I18n.t("txt.admin.javascrips.users_show.unsusped_access_label"):I18n.t("txt.admin.javascrips.users_show.suspend_access_label"))}});$z.defModule("recaptcha/index",{initialize:function(){window.Recaptcha={reload:function(){$j.getJSON("/recaptcha/fetch",function(a){$j("#recaptcha_challenge_field").val(a.recaptcha_challenge_field);$j("#recaptcha_challenge_image").attr("src",a.google_recaptcha_api_image_url+a.recaptcha_challenge_field)})}};$j("#recaptcha_image").append('<img id="recaptcha_challenge_image"><input id="recaptcha_challenge_field" name="recaptcha_challenge_field" type="hidden">');window.Recaptcha.reload()}});$z.defModule("reports/edit",{initialize:function(a){$j("fieldset.conditions span select").autocompleteFromSelectIfLarge()}});Zendesk.NS("Reports");Zendesk.Reports.ForumAnalytics=function(a){a=a||{};this.container=a.container;this.sammyApp=this._extendSammyApp(a.app);this.routes={TAB:"#forum_analytics",STATS:"#forum_analytics/stats/:statName"}};Zendesk.Reports.ForumAnalytics.prototype={$:function(a){return $j(a,this.container)},_extendSammyApp:function(b){var a=this;return b.bind("tab.changed_and_loaded",function(d,c){if(c.tabID!=="forum_analytics"){return}if(!a.$("#stats_summary_container").length){return}a._initUI();a._loadDefaultState();var f;if(this.matchPath(c.path,a.routes.TAB)){a._getRouteTab()}else{if(f=this.matchPath(c.path,a.routes.STATS)){a._getRouteStats(f)}}})},_getRouteStats:function(b){var a=this.$(".sparkline#"+b.statName);if(a.hasClass("active")){return}Zendesk.Stats.ForumUI.showDetailGraph(a,{container:this.container})},_getRouteTab:function(){this._getRouteStats({statName:this.$(".sparkline:first").attr("id")})},_loadDefaultState:function(){if(!this.$(".sparkline > div:not(:empty)").length){Zendesk.Stats.ForumUI._drawSparklines({container:this.container})}},_initUI:function(){if(this._initialized){return}this._initialized=true;Zendesk.Stats.ForumUI._bindSparklineHandlers(this.sammyApp,{statsURL:"#forum_analytics/stats",container:this.container})}};Zendesk.NS("Reports");Zendesk.Reports.Overview=function(a){a=a||{};this.container=a.container;this.sammyApp=this._extendSammyApp(a.app)};Zendesk.Reports.Overview.prototype={$:function(a){return $j(a,this.container)},_bindSparklineHandlers:function(){var b=this,a;a=[{context:".ticket_stats .search_sparkline",path:"#reports"},{context:"#forum_views",path:"#forum_analytics/stats/entry_view"},{context:"#forum_topics",path:"#forum_analytics"},{context:"#search_total_searches",path:"#search_analytics"},{context:"#search_tickets_created",path:"#search_analytics/stats/tickets"}];$j(a).each(function(c,d){$j(d.context).bind("click",function(){b.sammyApp.setLocation(d.path)})})},_drawAllSparklines:function(){var a=this,b;b=[{div:"#tickets_created_sparkline",statName:"created_count",draw:this._drawTicketSparklines},{div:"#tickets_solved_sparkline",statName:"solve_count",draw:this._drawTicketSparklines},{div:"#tickets_first_response_time_sparkline",statName:"first_response_time",draw:this._drawTicketSparklines},{div:"#tickets_satisfaction_sparkline",statName:"csr",draw:this._drawTicketSparklines},{div:"#forum_views_sparkline",statName:"entry_view",draw:this._drawForumSparklines},{div:"#forum_topics_sparkline",statName:"entry_create",draw:this._drawForumSparklines},{div:"#search_total_searches_sparkline",statName:"searches",draw:this._drawSearchSparklines},{div:"#search_tickets_created_sparkline",statName:"tickets",draw:this._drawSearchSparklines}];$j(b).each(function(c,d){d.draw.call(a,d)})},_drawForumSparklines:function(c){var b=this.$(c.div),a,d=Zendesk.Stats.ForumUI._statsInfo(this.$("#stats_object"));a=new Zendesk.Stats.Graph(b,{graphType:"sparkline",resource:"forum",objectType:d.objectType,objectId:d.objectId,statName:c.statName,start:d.windowStart,totalCountDiv:b.closest(".sparkline_container").find(".stat_total")});a.draw()},_drawSearchSparklines:function(c){var b=this.$(c.div),a;a=new Zendesk.Stats.Graph(b,{graphType:"sparkline",searchStatURL:"/account/search_account_stats",statName:c.statName,totalCountDiv:b.closest(".sparkline_container").find(".stat_total")});a.draw()},_drawTicketSparklines:function(c){var b=this.$(c.div),a;a=new Zendesk.Stats.Graph(b,{graphType:"sparkline",searchStatURL:"/account/0/ticket_stats_by_account",statName:c.statName,totalCountDiv:b.closest(".sparkline_container").find(".stat_total")});$j.getJSON(a.statsURL,{start:a.startTime,interval:86400}).done($j.proxy(this._drawSparkline,a,a.statsURL,this._calculateTotal))},_extendSammyApp:function(b){var a=this;return b.bind("tab.changed_and_loaded",function(f,d){if(d.tabID!=="overview"){return}if(!a.$(".stats_summary_container").length){return}a._initUI();var c=a.$(".search_sparkline > div:not(:empty)");if(c.length){return}a._drawAllSparklines()})},_drawSparkline:function(b,a,d){this.data=d.data;this.draw();var e="0,0",c=a(d.data,d.counts);if(this.statName==="csr"){e="0,0%";c*=100}if(this.statName==="first_response_time"){c=c/3600}$j(this.totalCountDiv).append(Zendesk.Stats.formatNumber(e,c))},_calculateTotal:function(f,c){var d=0,e=0;if(c&&c.length===f.length){for(var b=0;b<f.length;b++){if(c[b]===undefined){continue}e+=f[b][1]*c[b];d+=c[b]}e/=d}else{for(var a=0;a<f.length;a++){e+=f[a][1]}}return e},_initUI:function(){if(this._initialized){return}this._initialized=true;this._bindSparklineHandlers()}};Zendesk.NS("Reports.Page");Zendesk.Reports.Page.init=function(){var a=new Zendesk.TabbedContainer.SammyApp();new Zendesk.Reports.Overview({app:a.app,container:"#overview"});new Zendesk.Reports.ForumAnalytics({app:a.app,container:"#forum_analytics"});new Zendesk.Reports.SearchAnalytics({app:a.app,container:"#search_analytics"});a.app.bind("tab.change",function(f,d){var c=$j("#"+d.tabID);var b=function(){a.app.trigger("tab.changed_and_loaded",d)};if(c.data("loaded")){b()}else{c.data("loaded",true);c.responsiveLoad("/reports?tab="+d.tabID,b)}});a.init()};Zendesk.NS("Reports");Zendesk.Reports.SearchAnalytics=function(a){a=a||{};this.container=a.container;this.sammyApp=this._extendSammyApp(a.app);this.routes={STATS:"#search_analytics/stats/:statName",TAB:"#search_analytics",TABLE:"#search_analytics/table/:orderField/:sortDirection/page/:page"}};Zendesk.Reports.SearchAnalytics.prototype={$:function(a){return $j(a,this.container)},_extendSammyApp:function(b){var a=this;return b.bind("tab.changed_and_loaded",function(d,c){a.searchStatsTable=a._initializeTable();if(c.tabID!=="search_analytics"){return}if(!a.$(".stats_summary_container").length){return}a._initUI();a._loadDefaultState();var f;if(this.matchPath(c.path,a.routes.TAB)){a._getRouteTab()}else{if(f=this.matchPath(c.path,a.routes.TABLE)){a._getRouteTable(f)}else{if(f=this.matchPath(c.path,a.routes.STATS)){a._getRouteStats(f)}}}})},_getRouteStats:function(c){var b=c.statName,a=this.$(".search_sparkline#"+b);if(a.hasClass("active")){return}this._drawDetailGraph(a);this._setTableDescription(b);this._fetchTableForSparkline(b);this.$("#percentage_stats_graph").hide();this.$("#detailed_stats_graph").show();if(b!=="searches"){this._addPercentageSelectMenu(b)}else{this.$("#stats_graph_select_menu").empty()}},_getRouteTab:function(){this._getRouteStats({statName:this.$(".search_sparkline:first").attr("id")})},_getRouteTable:function(d){this._loadDefaultGraph();var c=d.orderField,a=parseInt(d.page,10),b=d.sortDirection;this.$("#search_string_stats table th img").hide();this._sortTopStats(this.$("#search_string_stats table th."+c),b,a)},_initializeTable:function(){if(!this.$(".stats_summary_container").length){return undefined}var b={divTable:"#search_string_stats",statsType:"all",orderField:"searches",searchStatsTemplate:"#search_stats_template",divPaginationTotal:"#pagination_total",container:this.container};this.$("#search_string_feedback_checkbox").hide();this.$(b.divTable+" #show_more").hide();var a=new Zendesk.Stats.SearchStatsTable(b);this._displayFeedbackCheckbox(a);return a},_loadDefaultGraph:function(){if(this.$("#detailed_stats_graph").is(":empty")){this._drawDetailGraph(this.$(".search_sparkline:first"))}},_loadDefaultState:function(){if(!this.$(".search_sparkline > div:not(:empty)").length){this._drawSparklines()}},_setFeedbackCheckbox:function(a){if(a===true){this.$("#search_string_feedback_checkbox").show()}},_displayFeedbackCheckbox:function(a){a.isFeedbackData(this,this._setFeedbackCheckbox);var b=this.$("#search_string_stats #feedback_tag");b.prop("checked",false);b.click(function(){var c=($j(this).is(":checked")?"feedback_tab":"all");a.modifyDisplayed({statsType:c})})},_bindSparklineHandlers:function(){var a=this;this.$(".search_sparkline").bind("click",function(){if(($j(this).hasClass("active"))){return false}else{a.sammyApp.setLocation("#search_analytics/stats/"+$j(this).attr("id"))}})},_sortByColumn:function(){var a=this;var b=this.$("table.tickets th").slice(0,-1);b.css({cursor:"pointer"});b.click(function(){var e=$j(this).attr("class"),c=a.searchStatsTable.statOptions.page,d=a.searchStatsTable.getNextSortDirection(e);a.sammyApp.setLocation("#search_analytics/table/"+e+"/"+d+"/page/"+c);return false})},_bindTableHandlers:function(){this._sortByColumn();var a=this;this.$("#search_string_stats #show_more a").click(function(){a.$("table.tickets tr:hidden").show();var b=a.searchStatsTable,e=b.statOptions.orderField,c=b.nextPage(),d=b.getCurrentSortDirection(e);a.sammyApp.setLocation("#search_analytics/table/"+e+"/"+d+"/page/"+c);return false})},_bindSelectMenuHandler:function(){var a=this;this.$("#stats_graph_select_menu select").live("change",function(){var b=$j(this).find("option:selected").val();if(b==="percentage"){a._showPercentageGraph()}else{a._showOriginal()}})},_showOriginal:function(){this.$("#percentage_stats_graph").hide();this.$("#detailed_stats_graph").show()},_showPercentageGraph:function(){var d=this.$("#searches_sparkline").data("graph_data").data;var f=this.$(".active").find("div").data("graph_data").data;var c=[];for(var b=0;b<d.length;b++){var a=parseInt((parseInt(f[b][1],10)*100)/parseInt(d[b][1],10),10);c.push([d[b][0],(isNaN(a)?0:a)])}this.$("#detailed_stats_graph").hide();this.$("#percentage_stats_graph").show();var e=new Zendesk.Stats.Graph(this.$("#percentage_stats_graph"),{graphType:"percentage",data:c});e.draw()},_drawSparklines:function(){var c=[{div:"#searches_sparkline",statName:"searches"},{div:"#no_results_sparkline",statName:"no_results"},{div:"#no_clicks_sparkline",statName:"no_clicks"},{div:"#tickets_sparkline",statName:"tickets"}];for(var b=0;b<c.length;b++){var a=new Zendesk.Stats.Graph(this.$(c[b].div),{graphType:"sparkline",searchStatURL:"/account/search_account_stats",statName:c[b].statName,totalCountDiv:this.$(c[b].div).parent().parent().find(".stat_total")});a.draw()}},_drawDetailGraph:function(a){this.$(".search_sparkline.active").removeClass("active");this.$(a).addClass("active");var b=this.$(a).prop("id");var c=new Zendesk.Stats.Graph(this.$("#detailed_stats_graph"),{graphType:"area",searchStatURL:"/account/search_account_stats",statName:b});c.draw();$j(window).resize(function(){c.draw()})},_setTableDescription:function(b){var a={searches:{title:I18n.t("txt.admin.public.javascript.views.reports.top_500_searches"),description:""},no_results:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_results_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.search.top_500_searches_no_results_description")},no_clicks:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_clicks_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_clicks_description")},tickets:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_tickets_created_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_tickets_created_description")}}[b];this.$(".stats_summary_description").empty();this.$(".stats_summary_description").append(a.title);this.$(".stats_summary_extra_description").empty();this.$(".stats_summary_extra_description").append(a.description)},_fetchTableForSparkline:function(a){var b={searches:["searches","desc"],no_results:["avg_results","asc"],no_clicks:["ctr","asc"],tickets:["tickets","desc"]}[a];if(a!=="searches"){this.$("#search_string_feedback_checkbox input[type=checkbox]").prop("checked",false);this.searchStatsTable.statOptions.statsType="all"}this._sortTopStats(this.$("th."+b[0]),b[1],1,this._filterCallback)},_addPercentageSelectMenu:function(b){var d=this.$("#stats_graph_select_menu");var e=this.$("#"+b).parent().find(".stat_title").html().toLowerCase();var c=[];var a=this._getPercentageSelectMenuTranslation(e);c.push("<select>");c.push('<option value="original">'+a+"</option>");c.push('<option value="percentage">'+I18n.t("txt.admin.public.javascript.views.reports.search.percent_of_total_searches_option")+"</option>");c.push("</select>");d.empty();d.append(c.join())},_getPercentageSelectMenuTranslation:function(a){if(a==I18n.t("txt.admin.views.reports.tabs.search.with_no_results_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_with_no_results_label")}else{if(a==I18n.t("txt.admin.views.reports.tabs.search.with_no_clicks_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_with_no_clicks_label")}else{if(a==I18n.t("txt.admin.views.reports.tabs.search.tickets_created_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_tickets_created_label")}else{return"Number "+a}}}},_filterCallback:function(b){this.$("table.tickets td."+b).each(function(){if(b=="ctr"||b=="avg_results"){if(parseFloat($j(this).html())>0.05){$j(this).parent().hide()}}if(b=="tickets"){if(parseFloat($j(this).html())<1){$j(this).parent().hide()}}});if(this.$(".active").attr("id")!=="searches"){var a=this.$("table.tickets tbody tr:visible").sort(function(d,c){return parseInt($j(c).find(".searches").html(),10)-parseInt($j(d).find(".searches").html(),10)});this.$("table.tickets tbody").empty();this.$("table.tickets tbody").append(a);this.$("#show_more").hide();this.$(".view_sort").remove();this.$("th.searches").children("div.title").append('<img alt="Table-arrow" class="view_sort" src="/images/table-arrow.png"/>');this.$("table.tickets th").css({cursor:"default"});this.$("table.tickets th").unbind("click");if(this.$("#search_string_feedback_checkbox").is(":visible")){this.$("#search_string_feedback_checkbox").hide();this.$("#search_string_feedback_checkbox").data("show_again",true)}}else{if(this.$("#search_string_feedback_checkbox").data("show_again")){this.$("#search_string_feedback_checkbox").show();this.$("#search_string_feedback_checkbox").data("show_again",false)}this._sortByColumn()}},_setSortImage:function(b,c){this.$(".view_sort").remove();var a=(c==="desc"?"/images/table-arrow.png":"/images/table-arrow1.png");b.children("div.title").append('<img alt="Table-arrow" class="view_sort" src="'+a+'"/>')},_sortTopStats:function(b,e,d,g){var f=b.prop("class"),c=this.searchStatsTable,a=(this.$(".active").attr("id")==="searches")?15:100;c.setSort(f,e);c.modifyDisplayed({page:d,pageSize:a},this,g);this._setSortImage(b,e)},_initUI:function(){if(this._initialized){return}this._initialized=true;this._bindSparklineHandlers();this._bindTableHandlers();this._bindSelectMenuHandler()}};(function(a){function c(d){a("#ticket_organization_id").val(a(this).val())}a(function b(){a("#request_organization_id").change(c)})}(jQuery));(function(h){var g;var k={};function c(o){var n=_.find(g,function(p){return p.id===o});if(n==null){throw new Error("No such form: "+o)}return n}function d(o){var n=c(o);return n.ticket_fields}function a(){h("#ticketfields").hide();h("#attatchmentfriends").hide()}function b(){h("#ticketfields").show();h("#attatchmentfriends").show();h("#ticket-field-friends div").show()}function m(p){var o=d(p);var n=h("#ticket-field-friends");n.text("");_.each(o,function(s,q){var r=k[s.id];n.append(r)});b();j();h("#suggestions_for_new_topic").hide();if(Zendesk&&Zendesk.bindRelatedTopics){Zendesk.bindRelatedTopics()}}function j(){h("ul.drop-list").each(function(n,o){new Zendesk.UI.NestedMenu(o).initialize()});h(".field-tagger").ticketTagger()}function f(o){var n=parseInt(h(o.target).val(),10);if(n===-1){a();return}m(n)}function e(){var n=g[0].id;m(n)}h(function l(){var n=h("#ticket_forms_data");if(n.length===0){return}g=JSON.parse(n.html());if(g.length===0){return}h("#ticket-field-friends div[data-field-id]").each(function(p,o){var q=h(o).data("field-id");k[q]=o});if(g.length===1){e();return}a();h("#ticket_ticket_form_id").change(f).change()})}(jQuery));$z.defModule("rules/_bulk_update",{initialize:function(){var a=$j("#ticket-chat");a.submit(function(b){$j.ajax({url:a.attr("action"),type:"POST",data:a.serialize()+"&background=true",dataType:"json",success:function(c){var d=new Zendesk.JobStatus(c.status_url,{title:I18n.t("txt.public.javascripts.views.rules._bulk_update.processing_tickets"),renderResult:function(f){var e={title:I18n.t("txt.public.javascripts.views.rules._bulk_update.tickets_processed",{count:f.results.length}),body:$j("<ul/>")};if(f.status==="completed"){document.location="/tickets/bulk_result?background="+f.job.id+"&return_to="+escape(document.location)}return e}})}});$j("#bulk-update").hide();$j("table.tickets th.checkbox input").remove();$j("table.tickets input.tickets_to_bulk_update").remove();return false})}});$z.defModule("rules/analysis/show",{initialize:function(a){$j("select#analysis-filter").change(function(d){var b=$j("select#analysis-filter option:selected").val();var c=jQuery.queryParameters();var e={filter:c.filter};if(typeof(b)!="undefined"){e.filter=b}if(typeof(c.select)=="string"){e.select=c.select}if(typeof(c.key)=="string"){e.key=c.key}window.location.href=$j(location).attr("protocol")+"//"+$j(location).attr("host")+$j(location).attr("pathname")+"?"+$j.param(e)})}});$z.defModule("rules/edit",{initialize:function(){$j("fieldset.conditions span select").autocompleteFromSelectIfLarge();function c(e){var f;switch($j("#submit_type").val()){case"deactivate":f=I18n.t("txt.admin.views.rules.confirm_deactivate");break;case"delete":f=I18n.t("txt.admin.views.rules.confirm_delete");break;default:return true}var d=$j(this);if(d.data("is-recently-confirmed")){d.data("is-recently-confirmed",null);return true}else{e.stopImmediatePropagation();e.preventDefault();if(confirm(f)){d.data("is-recently-confirmed",true).trigger("submit")}return false}}function b(){var d=$$("ul#result_columns li").pluck("id");if(d.length>1){$("output_columns").value=d.join(",").gsub("sort_","");return true}else{alert("Please select at least two columns to include in table");return false}}var a=$j("#viewform");switch(a.data("ruleType")){case"View":a.submit(b);break;case"Automation":case"Trigger":a.submit(c)}}});jQuery(function(b){var a=b("#view_output_columns").find(".sortablelist");if(!a.exists()){return}a.each(function(){b(this).sortableWithEmptyTarget({emptyTargetClass:"item sortable",placeholder:"sortable target",connectWith:a.not(this)})});$j("#result_columns").bind("sortreceive",function(c,d){if($j(this).find("li").size()>11){$j(d.sender).sortable("cancel")}})});$z.defModule("rules/index",{initialize:function(d){var b=function(f,e){f=$j(f).html().strip().toLowerCase();e=$j(e).html().strip().toLowerCase();return(f<e)?-1:((f>e)?1:0)};var c=function(f){var e=[];var g=$j("#active-rules div.item").not(".reorder");$j.each(f,function(h,k){var j=g[h];$j(j).find("div.title div").text(k.innerText);e[h]=j});g.remove();$j("#active-rules").prepend(e)};var a=function(f){var e=$j("ul#active-rules-sort-list li.item.sortable").sort(function(h,g){if(f=="desc"){return b(g,h)}return b(h,g)});c(e);$j("ul#active-rules-sort-list li.item.sortable").remove();$j("ul#active-rules-sort-list").prepend(e)};$j("div#active-rules_sort input.sort_asc").click(function(e){a("asc")});$j("div#active-rules_sort input.sort_desc").click(function(e){a("desc")});$j("a.cancel-sorting").click(function(e){Ordering.cancelOrdering("div#active-rules");c($j("ul#active-rules-sort-list li.item.sortable"))});$j("select#rule-select, select#rule-sort").change(function(h){var f=$j("select#rule-sort option:selected").val();var g=$j("select#rule-select option:selected").val();var j="/rules?";var e=jQuery.queryParameters();var k={filter:e.filter};if(typeof(f)!="undefined"){k.sort=f}if(typeof(g)!="undefined"){k.select=g}window.location.href=$j(location).attr("protocol")+"//"+$j(location).attr("host")+j+$j.param(k)})}});$z.defModule("rules/show",{initialize:function(){var a="textarea[id*='ticket_fields'], input[id*='ticket_fields']";var e=$j(a).css("color");$j(a).css("color","gray");$j(a).click(function(){$j(this).css("color",e)});$j(a).blur(function(){if($j(this).val()==I18n.t("control.dropdown.value.no_change")){$j(this).css("color","gray")}});var b=$j("th:contains('Subject')");if(b.width()>50){b.css("width",b.width())}else{b.css("width","50px")}var c="textarea#comment_value";var d="p#placeholders_in_comment_notice";$(document).observe("macro:applied",function(){if(($j(c).val().indexOf("{{")>-1)||($j(c).val().indexOf("{%")>-1)){$j(d).show()}else{$j(d).hide()}})}});Zendesk.NS.extend("Satisfaction",{Score:{offered:1,poor:4,good:16},ScoreValue:{"1":"offered","4":"poor","5":"poor","16":"good","17":"good"},Input:{init:function(){if($j(this._rootSelector).length){this._satisfactionButtons=$j("#satisfaction_rating form .rating");this._currentRatingContainer=$j("#current_rating");this._currentRating=this._parseCurrentRating();this._ratingTemplate=$j("#current_rating_template").html();this._form=$j("#satisfaction_rating form");this._app=this._buildSammyApplication(jQuery,this._rootSelector)}},_scoreSpanTemplate:'<span class="rating selected {{scoreKey}}">{{scoreText}}</span>',_ensureVisible:function(){if($j(this._rootSelector).is(":hidden")){if(this._currentRating&&this._currentRating.score>1){this._form.hide();this._renderRating(this._currentRating).show()}else{this._currentRatingContainer.hide();this._form.show()}$j(this._rootSelector).show()}},_parseCurrentRating:function(){var a=$j("#current_rating_data").html();var b=$j("<div />").html(a).text();return JSON.parse(b)},_renderRating:function(c){var a=Zendesk.Satisfaction.ScoreValue[c.score];var b=$j.mustache(this._scoreSpanTemplate,{scoreKey:a,scoreText:I18n.t("txt.satisfaction.score."+a)});var d={header:I18n.t("txt.satisfaction.score.current",{score:b}),commentHeader:I18n.t("txt.satisfaction.header.comment"),showComment:I18n.t("txt.satisfaction.comment.show"),hideComment:I18n.t("txt.satisfaction.comment.hide"),modifyRating:I18n.t("txt.satisfaction.rating.modify"),anonymousModifyRating:I18n.t("txt.satisfaction.rating.anonymous_modify"),comment:c.comment,canModify:c["can_modify?"],isAnonymous:currentUser.isAnonymous};return this._currentRatingContainer.html($j.mustache(this._ratingTemplate,d))},_rootSelector:"#satisfaction_rating",_buildSammyApplication:function(b,a){var c=b.sammy(a,function(){this.debug=true;this.before(function(){Zendesk.Satisfaction.Input._ensureVisible();return true});this.get("#/satisfaction",function(){});this.post(/^\/requests\/.+\/satisfaction/,function(d){var e=Zendesk.Satisfaction.Input._form;jQuery.ajax({url:e.attr("action"),type:e.attr("method").toUpperCase(),data:e.serialize(),dataType:"json",error:function(f,h,g){d.redirect("#/satisfaction/error")},success:function(g,h,f){Zendesk.Satisfaction.Input._currentRating=g;d.trigger("ticket.satisfaction.created",g);d.redirect("#/satisfaction/success")}})});this.get("#/satisfaction/success",function(){Zendesk.Satisfaction.Input._form.hide();Zendesk.Satisfaction.Input._renderRating(Zendesk.Satisfaction.Input._currentRating).show();this.redirect("#/satisfaction")});this.get("#/satisfaction/error",function(){});this.get("#/satisfaction/cancel",function(){Zendesk.Satisfaction.Input._satisfactionButtons.removeClass("selected");if(Zendesk.Satisfaction.Input._currentRating){Zendesk.Satisfaction.Input._form.hide();Zendesk.Satisfaction.Input._currentRatingContainer.show()}else{$j("#satisfaction_form_body").slideUp(500)}});this.get("#/satisfaction/comment/hide",function(){Zendesk.Satisfaction.Input._currentRatingContainer.find(".comment").slideUp().end().find("a.hide_comment").hide().end().find("a.show_comment").show()});this.get("#/satisfaction/comment/show",function(){Zendesk.Satisfaction.Input._currentRatingContainer.find(".comment").slideDown().end().find("a.show_comment").hide().end().find("a.hide_comment").show()});this.before("#/satisfaction/new",function(){Zendesk.Satisfaction.Input._currentRatingContainer.hide();Zendesk.Satisfaction.Input._form.show()});this.get("#/satisfaction/new",function(){});this.get("#/satisfaction/new/:ratingName",function(){var e=this.params.ratingName;var d=Zendesk.Satisfaction.Input._satisfactionButtons.filter("."+e);if(!d.hasClass("selected")){Zendesk.Satisfaction.Input._satisfactionButtons.not(d).removeClass("selected");d.addClass("selected");$j("#satisfaction_form_body:hidden").slideDown(500);$j("#ticket_satisfaction_score").val(Zendesk.Satisfaction.Score[e])}})});c.run("#/satisfaction");return c}}});jQuery(function(){Zendesk.Satisfaction.Input.init()});Zendesk.NS("Zuora");Zendesk.Zuora.InvoicePage=function(){};Zendesk.Zuora.InvoicePage.prototype={show:function(){var a=this;$j("button[data-invoice-id]").click(function(){var c=$j(this);var d="invoice-items-for-"+c.data("invoice-id");var b=function(){return $j("#"+d).first()};c.find("span").html(b().is(":visible")?"Details":"Hide");if(_.any(b())){b().toggle();return}$j(c).addClass("activity").prop("disabled",true);$j.ajax({url:"/zuora/invoice/invoice_items.json?invoice_id="+$j(c).data("invoice-id"),success:function(g){var h=a.prepareInvoiceItems(g);var f=$j('<table class="invoice-items">');f.append('<tr><th>Description</th><th class="count">Quantity</th><th class="money">Amount</th><th class="money">Discount</th><th class="money">Total</th></tr>');_.each(h,function(k){var l=k.discountAmount()+k.discountPercentage();var j=$j("<tr>").append($j("<td>").html(k.description()).append($j("<div>").html(k.serviceStartDate()+" to "+k.serviceEndDate()))).append($j("<td>").addClass("count").html(k.quantity()+" Agent(s)")).append($j("<td>").addClass("money").html("$"+k.chargeAmount())).append($j("<td>").addClass("money").html("$"+l)).append($j("<td>").addClass("money").html("$"+k.totalAmount()));f.append(j)});var e=$j(c).closest("tr");e.after($j("<tr>").attr("id",d).append($j("<td colspan=5>").css("background-color",e.find("td").first().css("background-color")).append(f)));$j(c).removeClass("activity").prop("disabled",false)}})})},prepareInvoiceItems:function(a){var c=_.uniq(_.pluck(a,"service_start_date"));var b=_.map(c,function(d){return _.filter(a,function(e){return e.service_start_date==d})});return _.map(b,function(d){return new Zendesk.Zuora.InvoiceItemRow(d)})}};Zendesk.Zuora.InvoiceItemRow=function(a){this.rawInvoiceItems=a};Zendesk.Zuora.InvoiceItemRow.prototype={description:function(){return this._charge().charge_name},serviceStartDate:function(){return $j.datepicker.formatDate("mm-dd-yy",new Date(this.rawInvoiceItems[0].service_start_date))},serviceEndDate:function(){return $j.datepicker.formatDate("mm-dd-yy",new Date(this.rawInvoiceItems[0].service_end_date))},hasDiscount:function(){return _.any(this.rawInvoiceItems,function(a){return a.processing_type=="1"})},discountAmount:function(){if(!this.hasDiscount()){return 0}return parseFloat(this._discount().charge_amount)},discountPercentage:function(){if(!this.hasDiscount()){return 0}return" ("+this._discount().unit_price+"%)"},totalAmount:function(){return parseFloat(this.chargeAmount())+parseFloat(this.discountAmount())},chargeAmount:function(){return parseFloat(this._charge().charge_amount).toFixed(2)},perUnitCharge:function(){return parseFloat(this._charge().unit_price).toFixed(2)},quantity:function(){return this._charge().quantity},_charge:function(){return _.find(this.rawInvoiceItems,function(a){return a.processing_type=="0"})},_discount:function(){return _.find(this.rawInvoiceItems,function(a){return a.processing_type=="1"})}};jQuery(function(E){var e=E("form#subscription_settings");if(e.length===0){return}var a={1:"monthly",2:"quarterly",3:"biannually",4:"annually"};var Q=[null,"small","medium","large","extra_large"];var v=JSON.parse(E("#plan_data").html());_(JSON.parse(E("#billing_cycle_labels").html())).each(function(V,U){v[U].billingCycleLabels=_(V)});_(v).each(function(U,V){V=parseInt(V,10);if(isNaN(V)){return}U.id=V;U.className=Q[V];v[V]=v[U.className]=U});var P,R;P=R=v[e.data("plan-type")||3];var M=(currentAccount.isPayingCustomer);var J=e.find("#subscription_plan_type"),A=e.find("#subscription_max_agents"),p=e.find("#subscription_max_agents_error"),n=e.find("#subscription_billing_cycle_type"),u=e.find("#coupon_code"),q=e.find("#voice_optin"),s=e.find("#voice_transcription_optin"),N=e.find(".voice_option .pricing"),O=e.find(".voice_transcription_optin .pricing"),f=e.find(".voice_transcription_optin"),h=e.find("#coupon_code_error"),T=e.find("#coupon_expiry"),y=e.find("#subtotal"),k=e.find("#discount"),F=e.find("#coupon_discount"),C=e.find("#total"),x=e.find("#billing_period .period"),I=e.find("#after_coupon_expiry"),g=e.find(".button.save"),l=e.find("#cancel_warning"),S=e.find("#terms_agree");q.change(function(){var U=E(this);if(U.prop("checked")){N.addClass("active");s.attr("disabled",false);f.removeClass("disabled")}else{N.removeClass("active");s.attr("disabled",true);f.addClass("disabled")}});s.change(function(){var U=E(this);if(U.prop("checked")){O.addClass("active")}else{O.removeClass("active")}});if(!q.is(":checked")){s.attr("disabled",true);f.addClass("disabled")}function z(){return currentAccount.isPayingCustomer&&!currentAccount.isInTrial&&R&&P&&R.id<P.id}function H(){return parseInt(A.val(),10)}function K(U){if(R.restricted_to_annual_billing){n.val(4);$j(".billing_cycle_input").hide();return}var V=n.val();n.find("option").remove();R.billingCycleLabels.each(function(W,X){n.append('<option value="'+X+'">'+W+"</option>")});n.val(V);$j(".billing_cycle_input").show()}function D(U){return"$"+addCommas(U.toFixed(2))}function r(U){u.val(U.coupon_code);y.html(D(U.cycle_undiscounted_price));k.html("-&nbsp;"+D(U.cycle_discount_no_coupon));F.html("-&nbsp;"+D(U.cycle_coupon_discount));C.html(D(U.cycle_discounted_price));h.toggle(U.coupon_error!=null).html(U.coupon_error);T.toggle(U.coupon_expires_on!=null).html("Through "+U.coupon_expires_on);I.toggle(U.coupon_expires_on!=null).find(".value").html(D(U.cycle_undiscounted_price-U.cycle_discount_no_coupon))}function L(){var V=H(),U;if(isNaN(V)){U=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_number_of_agents_is_Required")}else{if(V<R.max_agent_floor){U=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_this_plan_requires_at_least",{number_of_agents:R.max_agent_floor})}else{if(V>R.max_agent_ceiling){U=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_this_plan_allows_no_more_than",{number_of_agents:R.max_agent_ceiling})}}}p.toggle(!!U).html(U);return !U}function t(){return L()}function G(){if(isNaN(H())){return}var U=false;setTimeout(function(){if(!U){e.addClass("recalculating");g.prop("disabled",true)}},200);E.getJSON("/account/subscription/calculate",e.serialize()).done(r).always(function(){U=true;e.removeClass("recalculating");g.prop("disabled",false)})}function m(){var U=n.val();if(U){x.html(I18n.t("txt.admin.views.accounts.subscription._subscription_summary.billed_"+a[U].capitalize()))}}function o(){return"/account/subscription/confirm?subscription[plan_type]="+J.val()+"&subscription[max_agents]="+H()+"&subscription[billing_cycle_type]="+n.val()+"&coupon_code="+u.val()+"&voice_optin="+(q.is(":checked")?"1":"0")+"&voice_transcription_optin="+(s.is(":checked")?"1":"0")}function b(){var U=this;E("#colorbox").find("#terms_agree").change(function(){var V=E(this).is(":checked");E(this).closest("form").find("footer input").prop("disabled",!V);S.val(V)}).end().find("#cboxClose,.close").click(function(){U.trigger("confirmation-dismissed");return false}).end().find("form").submit(function(){U.trigger("update-confirmed");return false})}function c(){this.redirect("#subscription","plan",R.className)}function j(){if(R.fixed_agent_count){E(".max_agent_input").hide()}else{E(".max_agent_input").show()}}function B(){var U=Math.min(H(),R.max_agent_ceiling);A.val(Math.max(U,R.max_agent_floor));j()}function w(U){if(U=="small"){$j(".causeware").show()}else{$j(".causeware").hide()}}var d=E.sammy("#subscription_settings",function(){this.bind("update-confirmed",function(){E.colorbox.close();e.trigger("submit",{confirmed:true})});this.bind("confirmation-dismissed",function(){E.colorbox.close();this.redirect("#subscription","plan",R.className)});this.get("#subscription/plan/:size",function(){var U=this.params.size;e.removeClass(Q.join(" ")).addClass(U);w(U);R=v[U];J.val(R.id);B();t();K(U);m();G()});this.get("#subscription/cancel",function(){l.show()});this.get("#subscription/confirmUpdate",function(){E.colorbox({href:o(),width:"600px",maxWidth:"600px",onComplete:E.proxy(b,this),onCleanup:E.proxy(c,this)})});this.get(/#\/?subscription\/?$/,function(){this.redirect("#subscription","plan",R.className)})});A.change(t);A.add(n).change(G);n.change(m);u.blur(G);e.submit(function(U,V){V=V||{};if(E(this).hasClass("recalculating")){return false}if(!t()){return false}if(z()){window.location=e.data("downgrade-url")+"?"+e.serialize();return false}if(M&&!V.confirmed){d.setLocation("#subscription/confirmUpdate");return false}});d.run("#/subscription");m();Zendesk.Instrumentation.ToTango.track("Subscription","Load")});(function(a){Zendesk.SalesforceConfiguration={init:function(){this.cache();this.events()},cache:function(){this.$openEditorLnk=a(".edit_salesforce_object");this.$openFilterLnk=a(".edit_object_filter");this.$expandLnk=a(".expand_link");this.$contractLnk=a(".contract_link");this.$selectLnk=a(".add_link a");this.$deselectLnk=a(".remove_link a");this.$objectForm=a("#salesforce_object_form");this.$filterForm=a("#salesforce_filter_form");this.$resetLnk=a("#reset_fields");this.$confSelector=a("#account_settings_use_salesforce_configuration");this.$configuration=a("#salesforce_configuration");this.$lookupChx=a("#account_settings_salesforce_integration");this.$lookupField=a("#lookup_field");this.boxWidth="820px";this.boxHeight="600px";this.sortTarget="salesforce_selected_objects";this.sortContainer="salesforce_selected_objects_sort";this.sortList="salesforce_selected_objects_sort_list"},events:function(){var b=this;this.$openEditorLnk.live("click",function(){a.colorbox({href:a(this).attr("href"),width:b.boxWidth,height:b.boxHeight,onComplete:function(){b.objSelector().change()}});return false});this.$openFilterLnk.live("click",function(){a.colorbox({href:a(this).attr("href"),width:b.boxWidth,height:"380px",onComplete:function(){a("#date_filter_value").datepicker();a("#regular_filter_field, #date_filter_field").change()}});return false});a("#regular_filter_field, #date_filter_field").live("change",function(){if(a(this).val()===""){a(this).addClass("empty")}else{a(this).removeClass("empty")}});this.$expandLnk.live("click",function(){var d,c;d=a(this).closest(".folder");c=b.getChildren(d);if(d.data("loaded")===false){b.loadFolder(d,c,a(this))}b.expandFolder(d,c);return false});this.$contractLnk.live("click",function(){var d,c;d=a(this).closest(".folder");c=b.getChildren(d);b.contractFolder(d,c);return false});this.$selectLnk.live("click",function(){var c=a(this).closest(".field").data("field");b.selectField(c);return false});this.$deselectLnk.live("click",function(){var c=a(this).closest("li").data("field");b.deselectField(c);return false});this.$objectForm.live("submit",function(){if(a("#mapping_salesforce_field option").length===0){alert(I18n.t("txt.admin.views.settings.extensions._salesforce3.select_some_field_alert"));return false}var d,e,c;d=a(this).serializeArray();e={};c={};a(".selected_fields li.field.selected").each(function(){var g,h,f;g=a(this).data("field");h=a(this).data("title");d.push({name:"fields[]",value:g});e[g]=h;f=b.getFolder(a(this));if(f.exists()){c[f.data("relationship")]={object:f.data("object"),type:f.data("type")}}});d.push({name:"object_label",value:b.selectedObjectLabel()});d.push({name:"labels",value:JSON.stringify(e)});d.push({name:"relationships",value:JSON.stringify(c)});d.push({name:"mapping_salesforce_field_type",value:a("#mapping_salesforce_field option:selected").data("type")});d.push({name:"authenticity_token",value:Zendesk.currentUser.authenticityToken});a.post(b.saveObjectUrl(),a.param(d)).done(function(f){a("#salesforce_configuration").html(f)}).fail(function(f){a("#salesforce_configuration").prepend(f.responseText)}).always(function(){b.setupSort();a.colorbox.close()});return false});this.$filterForm.live("submit",function(){var e,c,f,d;e=[];e.push({name:"object",value:a("#object_name").val()});e.push({name:"relationship_name",value:a("#relationship_name").val()});e.push({name:"limit",value:a("#limit").val()});f={field:a("#regular_filter_field").val(),type:a("#regular_filter_field option:selected").data("type"),operator:a("#regular_filter_operator").val(),value:a("#regular_filter_value").val()};d={field:a("#date_filter_field").val(),type:a("#date_filter_field option:selected").data("type"),operator:a("#date_filter_operator").val(),value:a("#date_filter_value").val()};e.push({name:"filters[]",value:JSON.stringify(f)});e.push({name:"filters[]",value:JSON.stringify(d)});e.push({name:"authenticity_token",value:Zendesk.currentUser.authenticityToken});a.post(b.saveFilterUrl(),a.param(e)).done(function(g){}).fail(function(g){a("#salesforce_configuration").prepend(g.responseText)}).always(function(){a.colorbox.close()});return false});this.$resetLnk.live("click",function(){a("#regular_filter_field, #regular_filter_value, #date_filter_field, #date_filter_value").val("");a("#limit").val("5");a("#regular_filter_field, #date_filter_field").change();return false});this.objSelector().live("change",function(){var e,f,d,c;d=a(this).val()||"";c=b.selectedObjectLabel();e=a("#salesforce_fields");f=b.loadingImage()+"  "+I18n.t("txt.admin.views.settings.extensions._salesforce3.loading_fields",{object_name:c});e.html('<div class="salesforce_item">'+f+"</div>");e.load(b.fieldsUrl(d),function(){b.setupFieldsSort();b.addMappingSalesforceFields()})});this.testForm().find(":submit").live("click",function(){var c,e,d;c=b.testForm().find("input[type=text]");e=c.serializeArray();d=new Zendesk.CRM.Application(new Zendesk.CRM.SidebarRenderer());d.fetchAndRenderData(b.testUrl()+"?format=json&"+a.param(e));return false});this.$confSelector.change(function(){var c=a(this).val();if(c==="0"){b.$configuration.slideUp()}else{b.$configuration.slideDown()}});this.$confSelector.change();this.$lookupChx.change(function(){if(a(this).is(":checked")){b.$lookupField.slideDown()}else{b.$lookupField.slideUp()}});this.$lookupChx.change();a("a#cancel_sorting").live("click",function(){Ordering.cancelOrdering("#"+b.sortTarget);return false});a("a#start_sorting").live("click",function(){Ordering.SetOrder("#"+b.sortTarget);return false});this.setupSort()},selectField:function(d){var b,c;b=a('li[data-field="'+d+'"]');c=this.getFolder(b);b.removeClass("non_selected");b.closest("li").addClass("selected");c.removeClass("non_selected");c.closest("li").addClass("selected");this.addMappingSalesforceField(b)},deselectField:function(d){var b,c;b=a('li[data-field="'+d+'"]');b.removeClass("selected");b.closest("li").addClass("non_selected");c=this.getFolder(b);if(this.getChildren(c).find("li.field.selected").length===0){c.removeClass("selected");c.closest("li").addClass("non_selected")}this.mappingSalesforceField().find("option[value='"+d+"']").remove()},expandFolder:function(c,b){b.show();c.addClass("expanded");c.removeClass("contracted")},contractFolder:function(c,b){b.hide();c.addClass("contracted");c.removeClass("expanded")},addMappingSalesforceField:function(d){var e,c,f,b;e=d.data("field");c=d.data("type");f=d.data("title");b=(e===this.mappingSalesforceField().data("selected"))?"selected=selected":"";if(!e.include("::")&&c!=="textarea"){this.mappingSalesforceField().append('<option value="'+e+'" data-type="'+c+'" '+b+">"+f+"</option>")}},addMappingSalesforceFields:function(){var b=this;a(".selected_fields li.field.selected").each(function(){b.addMappingSalesforceField(a(this))})},getChildren:function(b){return b.parent().find(".children")},getFolder:function(b){return b.parents(".folder_container").find(".folder")},fieldsUrl:function(b){var c={object:b};return"extensions/edit_salesforce_fields?"+a.param(c)},relatedFieldsUrl:function(b){var c={object:b.data("object"),relationship_name:b.data("relationship")};return"extensions/salesforce_related_fields?"+a.param(c)},saveObjectUrl:function(){return"extensions/save_salesforce_object"},saveFilterUrl:function(){return"extensions/save_object_filter"},testUrl:function(){return"/crm/sync_ticket_info"},setupSort:function(){a("#"+this.sortList).sortable();submit_sortable_list(this.sortTarget,this.sortContainer,this.sortList,"extensions/sort_salesforce_objects")},setupFieldsSort:function(){var b=a(".selected_fields").data("fields");a(".selected_fields .primary.selected").sortElements(function(d,c){return b.indexOf(a(d).data("field"))>b.indexOf(a(c).data("field"))?1:-1});a(".selected_fields .folder.selected").each(function(){a(this).parent().find(".field.selected").sortElements(function(d,c){return b.indexOf(a(d).data("field"))>b.indexOf(a(c).data("field"))?1:-1})});a(".selected_fields .primary_sortable_fields").sortable({cursor:"move",items:"li.selected.field.primary"}).disableSelection();a(".selected_fields .related_sortable_fields").sortable({cursor:"move",items:"li.selected.field.related"}).disableSelection()},loadFolder:function(d,c){var f,b,e;f=this;b=d.find(".contract_link");e=b.html();b.html(this.loadingImage);c.load(f.relatedFieldsUrl(d),function(){d.data("loaded",true);f.copyFolder(d.data("relationship"),c);b.html(e);f.setupFieldsSort()})},loadingImage:function(){return'<img src="/images/ajax_loader_small.gif" style="width:9px">'},copyFolder:function(d,b){var c=this.selectedFields().find('li[data-relationship="'+d+'"]');c.data("loaded",true);c.addClass("expanded");c.removeClass("contracted");this.getChildren(c).html(b.html())},selectedObjectLabel:function(){return this.objSelector().find("option:selected").html()},selectedFields:function(){return a(".selected_fields")},testForm:function(){return a("#crm_test_form")},objSelector:function(){return a("#salesforce_object")},mappingSalesforceField:function(){return a("#mapping_salesforce_field")}}}(jQuery));$z.defModule("settings/extensions/show",{initialize:function(a){$j("#crm_integration").change(function(){var b=$j(this).val();if(b=="SalesforceIntegration"){$j("#sugar, #ms_dynamics").hide();$j("#salesforce").show()}else{if(b=="SugarCrmIntegration"){$j("#salesforce, #ms_dynamics").hide();$j("#sugar").show()}else{if(b=="MsDynamicsIntegration"){$j("#salesforce, #sugar").hide();$j("#ms_dynamics").show()}}}});$j("#ms_dynamics_integration_type_code").change(function(){var b=$j(this).val();if(b==="0"){$j(".ms_dynamics_on_premise").hide();$j(".ms_dynamics_on_ifd").hide();$j(".ms_dynamics_on_cloud").show()}else{if(b==="1"){$j(".ms_dynamics_on_cloud").hide();$j(".ms_dynamics_on_ifd").hide();$j(".ms_dynamics_on_premise").show()}else{$j(".ms_dynamics_on_cloud").hide();$j(".ms_dynamics_on_premise").hide();$j(".ms_dynamics_on_ifd").show()}}});$j("#ms_dynamics_integration_type_code").change();$j("#settings_extensions_ms_dynamics_save_button").click(function(){$j(this).val(I18n.t("txt.admin.public.javascript.views.settings.extensions.testing_connection_please_wait")).prop("disabled",true);$j("#ms_dynamics_form").submit()});$j("#settings_extensions_sugar_crm_save_button").click(function(){$j(this).val(I18n.t("txt.admin.public.javascript.views.settings.extensions.testing_connection_please_wait")).prop("disabled",true);$j("#sugar_crm_form").submit()});$j("#settings_extensions_salesforce_connect_button").click(function(){this.href="/settings/extensions/connect_to_salesforce?salesforce_environment="+$j("select#salesforce_environment option:selected").val();Zendesk.Instrumentation.ToTango.track("Enabling salesforce.com","CRM")});Zendesk.SalesforceConfiguration.init()}});(function(a){Zendesk.NS("Branding");Zendesk.Branding={init:function(b,c){this.branding=b;this.dynamicContent=c;this.cache();this.imgloader();this.autocomplete();this.events()},cache:function(){this.$el={previewHeaderWrapper:a("div#mobile-settings #settings_mobile_preview"),previewHeader:a("div#mobile-settings #mobile-header-wrapper header"),previewHeaderTitle:a("div#mobile-settings #settings_mobile_preview h1"),previewHeaderLogo:a("div#mobile-settings #logo-wrapper img"),previewHeaderSearch:a("div#mobile-settings #search-button"),inputTitle:a("#account_mobile_title"),inputFileLogo:a("#mobile_logo_uploaded_data:file"),pageHeaderDarker:a("#branding_tab_background_color"),revertColorsLink:a("#revert_colors_link"),headerColor:a("#branding_header_color"),pageBackgroundColor:a("#branding_page_background_color"),sideboxColor:a("#branding_sidebox_color"),tabBackgroundColor:a("#branding_tab_background_color"),tabHoverColor:a("#branding_tab_hover_color"),textColor:a("#branding_text_color"),classicLogo:a("#image-block-header_logo img"),mobileLogo:a("#image-block-mobile_logo img"),saveButton:a("#settings_account_branding_save_button")}},imgloader:function(){this.fileReader=window.FileReader?new FileReader():false},autocomplete:function(){if(currentAccount.hasFeature("placeholderSuggestions")){this.suggest=new Suggest();this.suggest.suggestions=this.placeholders()}else{this.suggest=false}},placeholders:function(){var c,b={},d;for(c in this.dynamicContent){d=this.dynamicContent[c];b["{{"+c+"}}"]=d.name}return b},calculateLogoDimension:function(b){if(b>55){b=parseInt((b/114)*55)}else{b=null}return b},events:function(){var b=this;if(this.fileReader){this.$el.inputFileLogo.change(function(){if(this.files&&this.files[0]){b.fileReader.readAsDataURL(this.files[0])}});this.fileReader.onload=function(d){var c=a("<img src='"+d.target.result+"' />").load(function(){a(c).attr({width:b.calculateLogoDimension(this.width),height:b.calculateLogoDimension(this.height)});b.updateLogo.call(b,c)})}}if(this.suggest){this.$el.inputTitle.bind({focusin:function(c){b.suggest.attach(this,c)},focusout:function(c){b.suggest.detach(this,c)}})}this.$el.inputTitle.keyup(function(){b.updateTitle()});this.$el.headerColor.change(function(){b.updateHeaderColors()});this.$el.pageBackgroundColor.change(function(){b.updatePageBgColor()});this.$el.revertColorsLink.click(function(){b.revertColors();b.updateHeaderColors()});this.$el.previewHeaderWrapper.click(function(){return false});this.$el.saveButton.click(function(c){if(b.doubleCheck()){return true}var d=I18n.t("txt.admin.views.settings.account._branding.hex_not_valid");alert(d);c.preventDefault();return false})},updateLogo:function(b){this.$el.previewHeaderLogo.replaceWith(b);this.$el.previewHeaderLogo=b},updateTitle:function(){var c=this.$el.inputTitle.val(),b=this.dynamicTitle(c);this.$el.previewHeaderTitle.text(b)},dynamicTitle:function(c){var b=new RegExp("{{([^}]{2,})}}","gi"),d=this;return c.replace(b,function(f){var e=f.substring(2,f.length-2);return d.dynamicContent[e].value})},updatePageBgColor:function(){var b=this.$el.pageBackgroundColor.val(),c=this.getValid(b);if(!c){return false}this.$el.pageBackgroundColor.val(c);return true},updateHeaderColors:function(){var d=this.$el.headerColor.val(),c=this.getValid(d);if(!c){return false}var g=YAHOO.util.Color.hex2rgb(c),f=YAHOO.util.Color.rgb2hsv(g[0],g[1],g[2]),e=this.getTabBgHexFrom(f),k=this.getTabHoverHexFrom(f),j=this.getTextHexFrom(f),b=this.getBorderColor(e),h=c;this.updateInputFields(h,e,k,j);this.updateHeaderPreview(h,e,b,j);this.updateLogoBackgrounds(h);return true},getValid:function(b){if(this.isValid(b)){b=this.removeHashFrom(b);b=this.sixDigit(b);return b}else{return false}},isValid:function(b){var c=/^#?[0-9a-f]{3,6}$/i;return c.test(b)},removeHashFrom:function(b){return b.replace(/#/gi,"")},sixDigit:function(b){return b.length===6?b:b[0]+b[0]+b[1]+b[1]+b[2]+b[2]},getTabBgHexFrom:function(c){var e=c[0]*1.03>1?1:c[0]*1.03,d=c[1]*0.87,b=c[2]*0.83;return this.hsvToHex([e,d,b])},hsvToHex:function(c){var b=YAHOO.util.Color.hsv2rgb(c[0],c[1],c[2]);return YAHOO.util.Color.rgb2hex(b[0],b[1],b[2])},getTabHoverHexFrom:function(c){var f=c[0],e=c[1]*0.62,b=c[2]*1.02>1?1:c[2]*1.02,d=this.hsvToHex([f,e,b]);return d==="FFFFFF"?"E8E8E8":d},getTextHexFrom:function(b){return b[2]>0.85?"2A2A2A":"FFFFFF"},getBorderColor:function(d){var c=YAHOO.util.Color.hex2rgb(d),b=YAHOO.util.Color.rgb2hsv(c[0],c[1],c[2]);if(b[2]<0.5){b[2]*=1.2}else{b[2]*=0.8}c=YAHOO.util.Color.hsv2rgb(b[0],b[1],b[2]);return YAHOO.util.Color.rgb2hex(c[0],c[1],c[2])},updateInputFields:function(d,c,e,b){this.$el.headerColor.val(d);this.$el.tabBackgroundColor.val(c);this.$el.tabHoverColor.val(e);this.$el.textColor.val(b)},updateHeaderPreview:function(d,b,e,c){this.$el.previewHeader.css({"background-color":"#"+d}).css({"background-image":"-webkit-linear-gradient(top, #"+d+", #"+b+")"}).css({"background-image":"-moz-linear-gradient(top, #"+d+", #"+b+")"}).css({"background-image":"-ms-linear-gradient(top, #"+d+", #"+b+")"}).css({"background-image":"-o-linear-gradient(top, #"+d+", #"+b+")"}).css({"background-image":"linear-gradient(top, #"+d+", #"+b+")"});this.$el.previewHeaderSearch.css({"background-color":"#"+b});this.$el.previewHeader.css({"border-bottom-color":"#"+e});this.$el.previewHeaderTitle.css({color:"#"+c,"text-shadow":c==="FFFFFF"?"0px -1px rgba(0, 0, 0, 0.5)":"none"})},updateLogoBackgrounds:function(b){this.$el.classicLogo.css({"background-color":"#"+b});this.$el.mobileLogo.css({"background-color":"#"+b})},revertColors:function(){this.$el.sideboxColor.val(this.branding.sidebox_color);this.$el.headerColor.css("background-color","#"+this.branding.header_color).val(this.branding.header_color);this.$el.pageBackgroundColor.css("background-color","#"+this.branding.page_background_color).val(this.branding.page_background_color)},doubleCheck:function(){return this.updateHeaderColors()&&this.updatePageBgColor()}}}(jQuery));$z.defModule("settings/account/_branding",{initialize:function(a,b){Zendesk.Branding.init(a,b)}});(function(d,e,c){var b={searchBoostSliderSelector:null,onlyEnduserSliderLabel:"",onlyAgentsSliderLabel:""};function a(){var h={"10:1":-0.9,"4:1":-0.75,"2:1":-0.5,"1:1":0,"1:2":0.5,"1:4":0.75,"1:10":0.9};h[b.onlyAgentsSliderLabel]=-1;h[b.onlyEnduserSliderLabel]=1;function j(r){var p,q=c.find(h,function(t,s){p=s;return r===t});return q!==undefined&&p}function l(r){e("#account_settings_boost_curated_content").val(r);var p=e("#curated-search-slider .label"),q=j(r);p.text(q)}function g(){var p=e("div.slider-bg");p.html("<div/><div/><div/>");var q=e("div.slider-bg > div"),s=q.parent().width(),r=10,t=6;q.filter(":nth-child(1)").css({width:r,left:0});q.filter(":nth-child(2)").css({width:s-r-r-2*t,left:r+t});q.filter(":nth-child(3)").css({width:r,left:s-r})}var o={"10:1":1+10*0.01,"4:1":1+10*0.3,"2:1":1+10*0.4,"1:1":1+10*0.5,"1:2":1+10*0.6,"1:4":1+10*0.7,"1:10":1+10*0.99};o[b.onlyAgentsSliderLabel]=1-0.9;o[b.onlyEnduserSliderLabel]=1+10+0.9;function n(p){return o[j(p)]}g();var m=c.values(h),k=parseFloat(e("#account_settings_boost_curated_content").val())||0,f=m.collect(function(p){return n(p)});d.Slider.setup(b.searchBoostSliderSelector,{onSliderChange:l,range:[0,12],relativePositions:f,values:m,value:k,showTicks:true})}d.defModule("settings/portal/_settings",{initialize:function(f){b.searchBoostSliderSelector=f&&f.sliderId;if(!b.searchBoostSliderSelector){return}b.onlyEnduserSliderLabel=f.enduser_string;b.onlyAgentsSliderLabel=f.agents_string;e(a)}})})(this.Zendesk,this.jQuery,this._);Zendesk.NS("Screenr");Zendesk.Screenr.Provisioning={init:function(b,c,a){Zendesk.Screenr.Provisioning.requestedDomain=b;Zendesk.Screenr.Provisioning.scope=a;this.bindCheckBox(c);this.bindProvisioningForm()},requestedDomain:"",triggeringCheckBoxId:"",scope:"",bindCheckBox:function(a){$j(a).click(function(b){this.showProvisioningModal();b.preventDefault()}.bind(this));Zendesk.Screenr.Provisioning.triggeringCheckBoxId=a},showProvisioningModal:function(){$j.colorbox({inline:true,href:"#screenr_provisioning",width:"620px",onComplete:function(){$j("#screenr_provisioning  #domain").focus()},onClosed:function(){Zendesk.Screenr.Provisioning._removeError()}})},bindProvisioningForm:function(){$j("#screenr_provisioning form").submit(function(a){a.preventDefault();this.onSubmit()}.bind(this))},onSubmit:function(){Zendesk.Screenr.Provisioning._disableSubmitButton();Zendesk.Screenr.Provisioning._removeError();Zendesk.Screenr.Provisioning._enqueueProvisioning()},_enqueueProvisioning:function(){if(this.poller){this.poller.stop()}$j("#provisioning_spinner").show();$j.ajax({type:"POST",url:"/screenr_tenants",data:{domain:Zendesk.Screenr.Provisioning.requestedDomain,scope:Zendesk.Screenr.Provisioning.scope},success:this._startPoller.bind(this)})},_startPoller:function(a){var b={url:a.status_url,type:"GET",dataType:"json"};this.poller=new Zendesk.Utils.Poller(b,1000,20000,this._pollingCallback.bind(this),this._errorCallback.bind(this),this._timeoutCallback.bind(this));this.poller.start()},_pollingCallback:function(a){switch(a.job_status.status){case"completed":this._onCompletedPolling(a.job_status.results);break;case"failed":this._errorCallback(this);break;case"killed":this._errorCallback(this);break;default:return true}},_onCompletedPolling:function(a){switch(a.api_status){case"provisioned":this._onSucessfulProvisioning();break;case"validation_failed":this._onValidationFailed(a.message,a.error_on);break;default:this._errorCallback(this)}},_onSucessfulProvisioning:function(){$j("#provisioning_spinner").hide();var e=I18n.t("public.javascripts.views.settings.screencasts.screenr_account_created"),a=I18n.t("public.javascripts.views.settings.screencasts.close_window_button"),f=I18n.t("public.javascripts.views.settings.screencasts.final_feedback"),g=$j('<div class="info">'),d=$j("<p>"),c=$j('<div class="submit">'),b=$j('<input class="button" name="commit" type="submit"/>');$j("#screenr_provisioning").html("");g.html("&#10004;&nbsp; "+e).appendTo($j("#screenr_provisioning"));d.html(f).appendTo($j("#screencasts_wrapper"));b.attr("value",a).appendTo(c).click(function(h){$j.colorbox.close();d.effect("highlight",{},3000)}.bind(this));c.appendTo($j("#screenr_provisioning"));Zendesk.Screenr.Provisioning._setTriggeringCheckboxAsChecked(Zendesk.Screenr.Provisioning.triggeringCheckBoxId);$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_setTriggeringCheckboxAsChecked:function(a){$j(a).attr("checked",true).unbind().click(function(b){b.preventDefault()})},_onValidationFailed:function(a,b){this._displayError(a);$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_errorCallback:function(a){this._displayError(I18n.t("public.javascripts.views.settings.screencasts.screenr_unavailable"));$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_timeoutCallback:function(a){this._displayError(I18n.t("public.javascripts.views.settings.screencasts.screenr_unavailable"));$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_displayError:function(a){$j(".error").html(a).show();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_removeError:function(){$j(".error").hide();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_disableSubmitButton:function(){$j("#screenr_provisioning .button").attr("disabled","disabled")},_enableSubmitButton:function(){$j("#screenr_provisioning .button").removeAttr("disabled")},recorderId:null,host:null,screenrBaseUri:null,confirmState:false,setupDowngrade:function(c,b,a){this.recorderId=c;this.host=b;this.screenrBaseUri=a;this._bindDowngradeLink()},_bindDowngradeLink:function(){$j("#screenr_downgrade").click(function(a){this._checkTenantStatus();a.preventDefault()}.bind(this))},_checkTenantStatus:function(){var a=Zendesk.Screenr.Helper.publicUrlToTenantStatus(this.recorderId,this.host,this.screenrBaseUri);$j.ajax({type:"GET",url:a,success:this._parseTenantStatus.bind(this),error:this._errorCallback.bind(this)})},_parseTenantStatus:function(b){var a=b;if(typeof a=="string"){a=a.evalJSON()}switch(a.StatusCode){case 200:this._displayDowngrade();break;case 403:this._displayImpossibleToDowngrade();break;default:this._errorCallback()}},_displayImpossibleToDowngrade:function(){var a=$j("#screenr_downgrading");a.find("#no_downgrade").show();a.find("#close_modal").click(function(b){$j.colorbox.close();b.preventDefault()}.bind(this));this._showDowngradingModal()},_displayDowngrade:function(){var a=$j("#screenr_downgrading");a.find("#downgrade").show();a.find("#downgrade_button").click(function(b){if(!this.confirmState){this.confirmState=true;this._onDowngradeClick()}b.preventDefault()}.bind(this));a.find("#close_modal").click(function(b){$j.colorbox.close();b.preventDefault()}.bind(this));this._showDowngradingModal();this.confirmState=false},_onDowngradeClick:function(){var a=confirm(I18n.t("public.javascripts.views.settings.screencasts.sure_you_want_downgrade"));if(a){this._enqueueDowngrading()}else{$j.colorbox.close()}},_enqueueDowngrading:function(){if(this.poller){this.poller.stop()}$j("#downgrading_spinner").show();this._disableDowngradingButton();$j.ajax({type:"POST",url:"/screenr_tenant_downgrades",success:this._startDowngradingPoller.bind(this)})},_startDowngradingPoller:function(a){var b={url:a.status_url,type:"GET",dataType:"json"};this.poller=new Zendesk.Utils.Poller(b,1000,20000,this._pollingDowngradingCallback.bind(this),this._errorCallback.bind(this),this._timeoutCallback.bind(this));this.poller.start()},_pollingDowngradingCallback:function(a){switch(a.job_status.status){case"completed":this._onCompletedDowngradingPolling(a.job_status.results);break;case"failed":this.confirmState=false;this._errorCallback(this);break;case"killed":this.confirmState=false;this._errorCallback(this);break;default:return true}},_onCompletedDowngradingPolling:function(a){switch(a.api_status){case"downgraded":this._onSucessfulDowngrading();break;case"validation_failed":this.confirmState=false;this._onValidationFailed(I18n.t("public.javascripts.views.settings.screencasts.screenr_account_impossible_to_downgrade"),"");break;default:this._errorCallback(this)}},_onSucessfulDowngrading:function(){var b,a;b=$j('<div class="info">'+I18n.t("public.javascripts.views.settings.screencasts.screenr_account_downgraded")+'</div><form><fieldset><input id="close_button" class="button" name="commit" type="submit" /></fieldset></form>');a=b.find("#close_button");a.attr("value",I18n.t("public.javascripts.views.settings.screencasts.screenr_account_downgraded_close_button")).click(function(c){c.preventDefault();$j.colorbox.close()}.bind(this));$j("#provisioning_spinner").hide();$j("#screenr_downgrading").empty();b.appendTo($j("#screenr_downgrading"));$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_disableDowngradingButton:function(){$j("#screenr_downgrading .button").attr("disabled","disabled")},_enableDowngradingButton:function(){$j("#screenr_downgrading .button").removeAttr("disabled")},_showDowngradingModal:function(){$j.colorbox({inline:true,href:"#screenr_downgrading",width:"620px",onComplete:function(){},onClosed:function(){Zendesk.Screenr.Provisioning._removeError()}})}};(function(b,c){var d=function d(){var f=c("#admins_and_agents"),e=c("#end_users");f.find(".remote_auth_selection").click(this.toggleSaveButton.bind(this,f));e.find(".remote_auth_selection").click(this.toggleSaveButton.bind(this,e));c("#account_settings_remote_agent_auth").bind("change",this.toggleSaveButton.bind(this,f));c("#account_settings_remote_end_user_auth").bind("change",this.toggleSaveButton.bind(this,e))};d.prototype.toggleSaveButton=function a(e){var h=c(e).find(".remote_auth_selection"),g=c(e).find(".save_button"),f=c(h[0]).closest(".auth_type").find(".auth_choice").val();g.attr("disabled","disabled");g.removeClass("button").removeClass("save").addClass("button_disabled");h.each(function(j,k){if(f==="0"||c(k).is(":checked")){g.removeAttr("disabled");g.removeClass("button_disabled").addClass("button").addClass("save")}})};b.AuthSaveButtonEventHandler=d})(window.Zendesk,jQuery);(function(e,f){var d=1,h=0;function j(k,l){var m;f.each(l,function(o,n){if(n){m=k.find(".auth_type."+o);if(m){m.addClass("selected");m.find(".options").show()}}})}function b(m,l){var k=l.find(".auth_choice");k.each(function(n,o){f(o).val(h)});m.find(".auth_choice").val(d);f(k).change()}var c=function c(k,l){this.settings=l;this.root=f("#"+k);this.initializeFormDisplay()};c.prototype.initializeFormDisplay=function g(){j(this.root,this.settings);this.root.find(".auth_type .head").click(f.proxy(this.selectAuthType,this))};c.prototype.selectAuthType=function a(m){var l=f(m.currentTarget),k;this.root.find(".auth_type .head").each(f.proxy(function(n,o){if(o===l[0]){return}k=f(o).closest(".auth_type");k.removeClass("selected");k.find(".options").slideUp()},this));k=l.closest(".auth_type");k.addClass("selected");k.find(".options").slideDown();b(k,this.root)};e.AuthTypeSettingsHandler=c})(window.Zendesk,jQuery);(function(a,e){var c=function c(f){this.settings=f;this.initializeGlobalSettings();e("#account_settings_ip_restriction_enabled").change(this.enableIPRestrictions)};c.prototype.initializeGlobalSettings=function b(){if(this.settings.ip_restriction_enabled==="1"){e("#sub_setting_ip_restrictions").addClass("enabled")}};c.prototype.enableIPRestrictions=function d(){var f=e(this).is(":checked"),g=e("#sub_setting_ip_restrictions");f?g.slideDown():g.slideUp()};a.GlobalAuthSettingsHandler=c})(window.Zendesk,jQuery);(function(a,e){var d={admins_and_agents:"zendesk_agent_auth",end_users:"zendesk_end_user_auth"};var c=function c(h,g){this.scope=e("#"+h+" ."+d[h]);this.currentPolicyID=g;var j=this.scope.find('input[type="radio"]');j.click(e.proxy(this.displayWarningBox,this));j.click(e.proxy(this.toggleCustomPolicyForm,this))};c.prototype.displayWarningBox=function b(h){var k=e(h.currentTarget),g=parseInt(k.val()),j=this.scope.find(".warning");if(g>this.currentPolicyID){j.show()}else{j.hide()}};c.prototype.toggleCustomPolicyForm=function f(j){var g=e("#account_settings_agent_security_policy_id_400"),h=e("#custom_security_policy_options");if(g.is(":checked")){h.slideDown()}else{h.slideUp()}};a.PolicyChangeHandler=c})(window.Zendesk,jQuery);(function(d,e){var j={account_remote_authentications_native_is_active:I18n.t("txt.admin.views.settings.security._authentication.zendesk_remote_auth_label"),account_remote_authentications_saml_is_active:I18n.t("txt.admin.views.settings.security._authentication.sam_label"),account_remote_authentications_jwt_is_active:I18n.t("txt.admin.views.settings.security._authentication.jwt_label")};var a=function a(n){var m=0;e(n).each(function(o,p){if(e(p).is(":checked")){m+=1}});return m};var b=function b(m){return a(m)>=1};var h=function h(m){return a(m)>1};var l=function l(m){this.selectedPrimarySSO=m.toString();this.initializeFormDisplay()};l.prototype.initializeFormDisplay=function f(){e(".primary_sso_select").change(this.updateSelectedPrimarySSO.bind(this));e(".remote_auth_selection").click(this.togglePrimarySSOSection.bind(this))};l.prototype.updateSelectedPrimarySSO=function k(n){var m=e(n.target);this.selectedPrimarySSO=m.val()};l.prototype.togglePrimarySSOSection=function c(q){var o=e(q.target),m=o.closest(".auth_type"),p=m.find(".remote_auth_selection"),r=m.find(".primary_sso"),n=m.find(".alternate_login");if(h(p)){this.setPrimarySSOOptions(m);r.removeClass("hidden")}else{r.addClass("hidden")}if(b(p)){n.removeClass("hidden")}else{n.addClass("hidden")}};l.prototype.setPrimarySSOOptions=function g(n){var q=n.find(".remote_auth_selection"),p=n.find(".primary_sso_select"),o=p.val(),m="";e(q).each(function(t,s){var v=e(s),w=v.siblings(".remote_auth_id").val();if(v.is(":checked")){var u=this.selectedPrimarySSO===w,r={value:w,html:j[v.attr("id")]};if(u){e.extend(r,{selected:"selected"})}m+=e("<option>",r).prop("outerHTML")}}.bind(this));if(m){p.html(m)}};d.PrimarySSOSettings=l})(window.Zendesk,jQuery);(function(d,f){var b,h={1:"native",3:"jwt"},k=["#admins_and_agents","#end_users"];var c=function c(m,l){this.authObj=m;b=l;this.initializeFormDisplay()};c.prototype.initializeFormDisplay=function g(){var l=h[this.authObj.auth_mode];f(".remote_auth_selection").click(this.toggleRemoteAuthType);f(k).each(function(n,m){f(m).find(".option."+l+" .generate_remote_auth_token").click(this.displayNewSharedSecret)}.bind(this))};c.prototype.displayActiveForm=function j(){var m=this.settings.auth_mode,l=(m===2)?".zendesk_remote_auth":".saml_remote_auth";this.root.find(l).hide()};c.prototype.displayNewSharedSecret=function e(){var l=f(this).closest(".option");l.find(".new_shared_secret input").val(b);l.find(".existing_shared_secret").hide();l.find(".new_shared_secret").show();return false};c.prototype.toggleRemoteAuthType=function a(m){var l=f(this);target=l.closest(".option").find(".remote_auth");if(l.is(":checked")){target.slideDown()}else{target.slideUp()}};d.RemoteAuthSettingsHandler=c})(window.Zendesk,jQuery);Zendesk.NS("Alerts");Zendesk.Alerts={showTwitterAuthorization:function(){var a="twitter_authorization_failure";var b=_.select(currentAccount.twitterAccounts,function(c){if(c.screen_name!=null){return c.authorized==false}});if(_.size(b)>0){$j("#flash").append(this.renderTwitterAuthorization(b));new Zendesk.AlertManager("#"+a,this.cookieName(a)).show()}},showFacebookAuthorization:function(){var a="facebook_authorization_failure";var b=_.select(currentAccount.facebookPages,function(c){return c.unauthorized});if(_.size(b)>0){$j("#flash").append(this.renderFacebookAuthorization(b));new Zendesk.AlertManager("#"+a,this.cookieName(a)).show()}},showPasswordExpiration:function(){var a="password_expiration";if(currentUser.isPasswordExpiring()){$j("#flash").append(this.renderPasswordExpiration(a));new Zendesk.AlertManager("#"+a,this.cookieName(a)).show()}},showUserAssumeNotice:function(){var a="user_assume";if(currentUser.assumed){$j("#flash").append(this.renderUserAssumeNotice(a));new Zendesk.AlertManager("#"+a,this.cookieName(a)).show()}},showSystemNotice:function(a){new Zendesk.AlertManager("#"+a,a).show()},cookieName:function(a){return"accounts."+currentAccount.id+"."+a},renderTwitterAuthorization:function(d){var b=I18n.t("txt.admin.public.javascripts.views.shared._alert.your_account_no_longer");var a=I18n.t("txt.admin.public.javascripts.views.shared._alert.reauthorize_twitter");var c='<div id="twitter_authorization_failure" style="display:none" class="alert">'+b+"<ul>        {{#accounts}}        <li>{{screen_name}}</li>        {{/accounts}}      </ul>"+a;return jQuery.mustache(c,{accounts:d})},renderFacebookAuthorization:function(d){var b=I18n.t("txt.admin.public.javascripts.views.shared._alert.your_account_not_longer_permissions_facebook");var a=I18n.t("txt.admin.public.javascripts.views.shared._alert.reauthorize_facebook");var c='<div id="facebook_authorization_failure" style="display:none" class="alert">'+b+'<ul>        {{#pages}}        <li>{{name}} - <span class="facebook_authorization_failure_reason">{{reason_for_unauthorization}}</span></li>        {{/pages}}      </ul>'+a+"</div>";return jQuery.mustache(c,{pages:d})},renderPasswordExpiration:function(c){var a='<div id="password_expiration" style="display:none" class="alert">{{{message}}}      <a style="margin-left:10px" id="hide_expiration" class="close" href="#">'+I18n.t("txt.public.javascripts.views.shared._alert.hide_this_notice")+"</a></div>";var b=I18n.t("txt.security_policy.expiration_alert",{count:i18n_distance_of_time_in_words(currentUser.passwordExpiresAt,new Date()),url:"/password"});return jQuery.mustache(a,{message:b})},renderUserAssumeNotice:function(a){var e=I18n.t("txt.admin.public.javascripts.views.shared._alert.user_assume_notice_primary_text"),d=I18n.t("txt.admin.public.javascripts.views.shared._alert.user_assume_notice_secondar_text"),b=I18n.t("txt.admin.public.javascripts.views.shared._alert.revert_identity_link_text"),c='<div id="{{elementId}}" style="display:none" class="alert">          <span class="preamble"> {{primaryMessage}} </span>          <span> {{secondaryMessage}} </span>          <a href="{{revertIdentityUrl}}"> {{revertIdentityLinkText}} </a>        </div>';return jQuery.mustache(c,{elementId:a,primaryMessage:e,secondaryMessage:d,revertIdentityLinkText:b,revertIdentityUrl:"/users/revert"})}};(function(f,c){var b=Number(I18n.t("date.datepicker.first_day"));var d=Boolean(Number(I18n.t("date.datepicker.is_rtl")));var a=Boolean(Number(I18n.t("date.datepicker.show_month_after_year")));var g="yy-mm-dd";function e(){f(".new_date_picker").each(function(){try{var h=f.datepicker.parseDate(g,f(this).val());var l=f.datepicker.formatDate(I18n.t("date.datepicker.date_format"),h);f(this).val(l)}catch(k){}var j="#"+f(this).data("field");if(f(j).exists()){f(this).datepicker("option","altField",j);f(this).datepicker("option","altFormat",g)}})}f(document).ready(function(){f.datepicker.regional.localized_datepicker={closeText:I18n.t("date.datepicker.close_text"),dayNamesMin:I18n.t("date.min_day_names"),prevText:I18n.t("date.datepicker.prev_text"),nextText:I18n.t("date.datepicker.next_text"),currentText:I18n.t("date.datepicker.current_text"),monthNames:I18n.t("date.month_names").slice(1),monthNamesShort:I18n.t("date.abbr_month_names").slice(1),dayNames:I18n.t("date.min_day_names"),dayNamesShort:I18n.t("date.abbr_day_names"),weekHeader:I18n.t("date.datepicker.week_header"),dateFormat:I18n.t("date.datepicker.date_format"),firstDay:b,isRTL:d,showMonthAfterYear:a,yearSuffix:I18n.t("date.datepicker.year_suffix")};f.datepicker.setDefaults(f.datepicker.regional.localized_datepicker);f(".new_date_picker").datepicker({showOn:"both",buttonImage:"/images/calendar_date_select/calendar.gif",buttonImageOnly:true,showAnim:"slideDown",defaultDate:+7});f(".new_date_picker").keyup(function(h){if((h.keyCode==46||h.keyCode==8)&&f(this).data("clear-allowed")){f.datepicker._clearDate(f(this))}});e()})}(window.jQuery,window.Zendesk));$z.defModule("shared/_help_container",{initialize:function(){$j("span.question-link").click(function(){$j(this).nextAll(".help-bubble").slideToggle(50)});$j("span.question-link img").hover(function(){$j(this).attr("src","/images/question-hover.png")},function(){$j(this).attr("src","/images/question.png")})}});zd.jsInitializers.push(["shared/_help_container",[]]);if(!Zendesk){Zendesk={}}if(!Zendesk.UI){Zendesk.UI={}}Zendesk.UI.MacroList={MAX_RESULTS:20,initialize:function(b,c,d){var a=this;a.root=$j(d);a.macro_search_enabled=c;$j(document).bind("keydown","ctrl+m",a.toggle_macro_menu_with_key_combo());$j("form#ticket-chat").find("input,textarea,select").bind("keydown","ctrl+m",a.toggle_macro_menu_with_key_combo());$j(document).keydown(a.escape_close());if(c){a.search_results=a.root.find("ul.search_results");a.nested_macros=a.root.find("ul.first-drop > li");a.root.data("cache",{"":{results:[],max_index:0}});a.root.data("full_results",$j.map(b,function(f,e){return(e)}));a.macros=b;a.root.data("macro_list",a.root.find("ul.search_results li.search_result"));a.add_apply_macro();a.root.data("input",$j(d+"_search"));a.root.find("ul.drop-list li ul.first-drop div.search img.clear").click(function(e){a.clear()});a.root.find("ul.drop-list li ul.first-drop ul.search_results li.no_results div.explain p.try_again a.clear_search").click(function(e){a.clear()});a.root.data("input").bind("keydown",a.escape_clear()).bind("keyup change",a.on_text_changed(d,a.root.data("cache"),a.root.data("full_results"),b,a.root.data("macro_list")));a.root.find("ul.drop-list > li").click(function(e){a.open_macro_menu()});a.root.data("input").keydown(a.advance_on_key(38,-1)).keydown(a.advance_on_key(40,1)).keydown(a.select_with_enter())}},select_with_enter:function(){var a=this;return(function(c){var b=a.search_results.data("selection");if(c.keyCode===13&&(b!==null&&b!==undefined)){c.preventDefault();c.stopPropagation();a.root.data("macro_list").eq(b).click()}})},advance_on_key:function(c,b){var a=this;return(function(d){if(d.keyCode===c){d.stopPropagation();d.preventDefault();a.advance_selection(b)}})},advance_selection:function(c){var b=this;var e=(typeof(b.root.data("search_term"))!=="undefined")?b.root.data("search_term"):"";var a=b.root.data("cache")[e];if(a.results.length>0){c%=a.max_index;var d=((typeof(b.search_results.data("selection_index"))==="undefined")?0:b.search_results.data("selection_index")+c+a.max_index)%a.max_index;b.select(d)}},select:function(d){var b=this;var c=b.search_results.data("selection");var e=(typeof(b.root.data("search_term"))!=="undefined")?b.root.data("search_term"):"";var a=b.root.data("cache")[e].results;if(typeof(c)!=="undefined"){b.root.data("macro_list").eq(c).removeClass("selected")}if(typeof(d)==="number"&&d>=0){b.search_results.data("selection_index",d);b.search_results.data("selection",a[d]);b.root.data("macro_list").eq(a[d]).addClass("selected")}else{b.search_results.data("selection",null)}},toggle_macro_menu_with_key_combo:function(){var a=this;var b=a.root.find("ul.first-drop");return(function(c){c.stopPropagation();c.preventDefault();if(b.css("display")==="none"){a.open_macro_menu()}else{a.close_macro_menu()}})},close_macro_menu:function(){var a=this;a.root.find("ul.first-drop").hide();if(a.macro_search_enabled){a.clear()}},open_macro_menu:function(){var a=this;a.root.find("ul.first-drop").show();if(a.macro_search_enabled){a.root.data("input").focus()}},clear:function(){var a=this;a.root.data("input").val("");a.root.data("input").change()},escape_close:function(){var a=this;return(function(b){if(b.keyCode===27){a.close_macro_menu()}})},escape_clear:function(){var a=this;return(function(b){if(b.keyCode===27){b.preventDefault();if($j.trim($j(this).val())!==""){b.stopPropagation();a.clear()}}})},on_text_changed:function(c,a,f,h,e){var m=this;var k=m.root.find("ul.search_results li.no_results");var b=k.find("span.search_term");var g=m.root.find("ul.drop-list li ul.first-drop div.search img.search");var l=m.root.find("ul.drop-list li ul.first-drop div.search img.clear");var d=function(n,o){return(h[n].label.replace(o,'<span class="highlight">$1</span>'))};var j=function(n,o){e.eq(n).find(" > a").html(o)};return(function(p){var n=(typeof(m.root.data("search_term"))!=="undefined")?m.root.data("search_term"):"";var r=a[n];var q=$j.trim($j(this).val());m.root.data("search_term",q);var t=function(C,z){if(typeof(z)==="undefined"){z=false}var A=$j.ui.autocomplete.escapeRegex(q);var E=RegExp(A,"i");var v=RegExp("("+A+")","gi");var x;var D=0;var w=[];var B=[];if(z){for(var y=0;y<r.max_index;y++){e.eq(r.results[y]).hide()}for(;w.length<m.MAX_RESULTS&&D<C.length;D++){if(h[C[D]].label!==(x=d(C[D],v))){w.push(C[D]);B.push(x);j(C[D],x);e.eq(C[D]).show()}}}else{for(;w.length<m.MAX_RESULTS&&D<C.length;D++){if(h[C[D]].label===(x=d(C[D],v))){e.eq(C[D]).hide()}else{w.push(C[D]);B.push(x);j(C[D],x);e.eq(C[D]).show()}}for(;C[D]<r.results[r.max_index];D++){e.eq(C[D]).hide();if(E.test(h[C[D]].label)){w.push(C[D])}}}for(;D<C.length;D++){if(E.test(h[C[D]].label)){w.push(C[D])}}a[q]={max_index:Math.min.apply(Math,[w.length,m.MAX_RESULTS]),regex:E,results:w,highlights:B}};if(q!==n){if(q.length===0){l.hide();g.show();m.search_results.hide();m.nested_macros.show();for(var o=0;o<r.max_index;o++){e.eq(r.results[o]).hide()}}else{if(n.length===0){g.hide();l.show();m.nested_macros.hide();m.search_results.show()}var s=0,u=0;if(n.length>0&&q.length>n.length&&r.regex.test(q)){if(typeof(a[q])==="object"&&a[q].max_index>0){if(r.results[r.max_index-1]<a[q].results[a[q].max_index-1]){for(;s<r.max_index;s++){if(r.results[s]<a[q].results[u]){e.eq(r.results[s]).hide()}else{j(a[q].results[u],a[q].highlights[u]);u++}}for(;u<a[q].max_index;u++){j(a[q].results[u],a[q].highlights[u]);e.eq(a[q].results[u]).show()}}else{for(;a[q].results[u]<=r.results[r.max_index-1];u++){j(a[q].results[u],a[q].highlights[u]);for(;r.results[s]<a[q].results[u];s++){e.eq(r.results[s]).hide()}if(r.results[s]===a[q].results[u]){s++}}for(;s<r.max_index;s++){e.eq(r.results[s]).hide()}}}else{t(r.results,false)}}else{if(typeof(a[q])==="object"){for(s=0,u=0;s<r.max_index&&u<a[q].max_index;){if(r.results[s]<a[q].results[u]){e.eq(r.results[s]).hide();s++}else{if(r.results[s]>a[q].results[u]){j(a[q].results[u],a[q].highlights[u]);e.eq(a[q].results[u]).show();u++}else{j(a[q].results[u],a[q].highlights[u]);u++;s++}}}if(s===r.max_index){for(;u<a[q].max_index;u++){j(a[q].results[u],a[q].highlights[u]);e.eq(a[q].results[u]).show()}}if(u===a[q].max_index){for(;s<r.max_index;s++){e.eq(r.results[s]).hide()}}}else{t(f,true)}}if(a[q].results.length>0){m.select(0);if(r.results.length===0){k.hide()}}else{m.select();b.html(q);if(r.results.length>0||n.length===0){k.show()}}}}})},add_apply_macro:function(b){var a=this;a.root.find("ul.search_results li.search_result").each(function(c,e){var d=a.macros[c].value;if(Number(d)>=0){$j(e).click(function(f){var g=$j("#ticket-chat");if(typeof(ticket_id)==="undefined"){var h=0}else{var h=ticket_id}if(jQuery("#tickets_to_bulk_update",g).length>0){new Zendesk.API.Macro(d).applyToTicket(null,g)}else{new Zendesk.API.Macro(d).applyToTicket(h,g)}$j(this).fadeOut("fast").fadeIn("fast",function(){a.clear();a.root.find("ul.drop-list li ul.first-drop").hide()})})}})}};$z.defModule("shared/_macro_list",{initialize:function(a,b,c){Zendesk.UI.MacroList.initialize(a,b,c)}});(function(f,g){var a,c,b,e;function h(p){var q=k().not(p);var o=p.attr("href");var m=b.filter(o);var n=b.not(m);q.removeClass("current");n.hide();p.addClass("current");m.trigger("tab.show");m.show();e.forceRedraw()}function d(){f.history.init(function(n){var m=k().filter('[href="#'+n+'"]');if(m.length===0){m=k().first()}h(m)})}function j(){f(window).bind("popstate:tabs",function(m){d()});k().click(function(m){var n=f(this).attr("href").replace(/^.*#/,"");f.history.load(n);m.preventDefault()})}function l(m){a=f(m||".tabbed_container");c=f(".tab_links",a);b=f(".tabs_content .tabs_canvas > div",a);e=f(".tabs_content .tabs_canvas",a).siblings();j();d()}function k(){return f(".tab_links a",a)}g.NS.extend("TabbedContainer",{init:function(m){l(m)},destroy:function(){f(window).unbind("popstate:tabs")}});f(document).ready(function(){if(f("div.tabbed_container[mode!='static']").length>0){g.TabbedContainer.init()}})}(window.jQuery,window.Zendesk));Zendesk.TabbedContainer.SammyApp=function(a){a=a||{};this.options=a;this.container=a.root||".sammy_tabbed_container";this.links=$j(".tab_links a",this.container);this.contentContainers=$j(".tabs_content .tabs_canvas > div",this.container);this.app=this._createSammyApp();this.PATH_NAME_MATCHER=/:([\w\d]+)/g;this.PATH_REPLACER="([^/]+)"};Zendesk.TabbedContainer.SammyApp.prototype={init:function(){this.app.disable_push_state=true;this.app.run()},extractParams:function(c,b,e){var a=this,d={};$j.each(b,function(f,g){if(e[f]){d[e[f].slice(1)]=a._decode(g)}else{if(!d.splat){d.splat=[]}d.splat.push(a._decode(g))}});return d},selectTab:function(a){var c="#"+a,b=this.links.filter('[href="'+c+'"]');if(b.length===0||(b.hasClass("current"))){return}this.links.removeClass("current");b.addClass("current");this.contentContainers.hide().filter(c).show()},_createSammyApp:function(){var a=this;return $j.sammy(this.container,function(b){this.helpers({matchPath:function(e,c){var f=c.match(a.PATH_NAME_MATCHER)||[],d;c=new RegExp(c.replace(a.PATH_NAME_MATCHER,a.PATH_REPLACER)+"$");if(!(d=e.match(c))){return}return a.extractParams(e,d.slice(1),f)}});this.get(/\#([\w\d]*)[\/]?(.*)/,function(){var c=this.params.splat[1],d=this.params.splat[0];a.selectTab(d);this.trigger("tab.change",{tabID:d,path:this.path,subPath:c})});this.get("",function(){b.setLocation(a.links.first().attr("href"))})})},_decode:function(a){return decodeURIComponent((a||"").replace(/\+/g," "))}};$z.defModule("shared/_tickets_table",{initialize:function(){$j("input.tickets_to_bulk_update").enableCheckboxRangeSelection()}});(function(a){a.fn.enableCheckboxRangeSelection=function(){var c=null;var b=this;b.unbind("click.checkboxrange");b.bind("click.checkboxrange",function(d){if(c!=null&&(d.shiftKey||d.metaKey)){b.slice(Math.min(b.index(c),b.index(d.target)),Math.max(b.index(c),b.index(d.target))+1).attr({checked:d.target.checked?"checked":""})}c=d.target})}})(jQuery);zd.jsInitializers.push(["shared/_tickets_table",[]]);$z.defModule("tabindex",{addtabindexes:function(){var a=Array.prototype.slice.call(arguments);var b=a.slice(-1)[0];if(typeof(b)==="number"){a.pop()}else{b=1}$j(a).each(function(d,c){$j(c).each(function(e,f){$j(f).attr({tabindex:b++})})})}});$z.defModule("tags/show",{initialize:function(){},showTagJobStatus:function(a){var b=a.responseJSON;var c=new Zendesk.JobStatus(b.status_url,{title:I18n.t("txt.js.tags.processing_tags"),renderResult:function(e){var d={title:""+I18n.t("txt.js.tags.processed_tags",{number:e.results.total}),body:$j("<ul/>")};if(e.status==="completed"){document.location="/tags/bulk_result?background="+e.job.id}return d}})}});$z.defModule("ticket_fields/_list_for_index",{initialize:function(a){$j("a.cancel-sorting").click(function(b){Ordering.cancelOrdering("div#fields")})}});$z.defModule("ticket_fields/_field_tagger",{initialize:function(b){var a=$z("ticket_fields/_field_tagger");$j("fieldset.conditions a").live("click",function(c){c.preventDefault();$j(this).closest("fieldset.conditions").remove();return false});$j(".customFieldName").live("blur",function(){var c=$j(this).closest("fieldset.conditions").find(".customFieldValue");if(c.val()===""){var d=new XRegExp("[\\p{L}\\p{N}]");c.val(a.substituteNotAcceptedCharacters($j(this).val(),d))}});$j("fieldset.conditions.add").click(function(c){c.preventDefault();a.insertOptionRow("","","");return false});b&&b.each(function(c){a.insertOptionRow(c)})},substituteNotAcceptedCharacters:function(b,e){var c="";for(var d=0;d<b.length;d++){var a=b.charAt(d);if(XRegExp.test(a,e)==true){c+=a.toLowerCase()}else{c+="_"}}return c},insertOptionRow:function(c){var a=$z("ticket_fields/_field_tagger");c.index=a._nextIndex();var b=$j.mustache(a.optionRowTemplate(),c);a.optionsContainer().append(b)},optionsContainer:function(){return $j("#optionsContainer")},optionRowTemplate:function(){var a=$z("ticket_fields/_field_tagger");if(a._optionRowTemplate){return a._optionRowTemplate}a._optionRowTemplate=$j("#custom-field-fieldset-template").html();return a._optionRowTemplate},_nextIndex:function(){this._nextFieldsetIndex=(this._nextFieldsetIndex||-1)+1;return this._nextFieldsetIndex}});$z.defModule("tickets/_editable_notes",{initialize:function(b,a){button=$j("#"+b+"-submit");button.click(function(c){data=$j("#"+b+"-form").serialize();data._method="put";jQuery.post(a,data);InputTracking.trackedElements=[]});$j("#"+b+"-link-show").click(function(){$j("div#"+b+"-edit").toggle();$j("div#"+b+"-show").toggle()})}});Zendesk.NS("Ticket",function(){this.CommentDrafts=function(d,b,a,c){this.niceID=d;this.userID=b;this.key="drafts/"+this.niceID+"/"+this.userID;this.timestampKey=this.key+"/ts";this.privacyKey=this.key+"/privacy";this.translatedVersion=this.key+"/translated";this.translatedHash=this.key+"/translatedHash";this.commentSelector=a;this.commentPrivacySelector=c;this.translationSelector="#translated_flag";this._keyHandler=_.debounce(this._keyHandler,300)};this.CommentDrafts.STALE_TIMEOUT_SECONDS=8*60*60;this.CommentDrafts.prototype={clear:function(){if(!Zendesk.Storage.isSupported()){return}this.localStorage=Zendesk.Storage.handle();return this._clear()},startWatching:function(){if(!Zendesk.Storage.isSupported()){return}this.localStorage=Zendesk.Storage.handle();this.commentInput=$j(this.commentSelector);this.commentPrivacyInput=$j(this.commentPrivacySelector);this.translationLink=jQuery(this.translationSelector);if(this._isStale()){this._clear()}var a=this._load();if(a.comment){this.comment=a.comment;this.commentInput.val(this.comment);this._renderDraftNotification(I18n.t("comment_draft.recovered_a_comment_from_draft"))}else{this.comment=this.commentInput.val()}if(a.commentPrivacy){this.commentPrivacy=a.commentPrivacy;this.commentPrivacyInput.prop("checked",this.commentPrivacy==="public").change()}else{this.commentPrivacy=this.commentPrivacyInput.prop("checked")?"public":"private"}this._bindEvents()},_bindEvents:function(){$j(this.commentInput).keyup($j.proxy(function(b){this._keyHandler(b)},this));var a=$j.proxy(function(b){this._updateDraftFromDom(b)},this);$j(this.commentInput).change(a);$j(document).bind("applied.macro.zendesk",a);$j(this.commentPrivacyInput).change(a);$j(this.translationLink).bind("saveTranslated",a)},_keyHandler:function(a){this._updateDraftFromDom(a)},_updateDraftFromDom:function(b){var a=(this.commentPrivacyInput.prop("checked")?"public":"private");if((this.comment!=this.commentInput.val())||(this.commentPrivacy!=a)){if(!$j(b.target).is(this.commentPrivacyInput)){this._renderDraftSaveNotification()}this._store(this.commentInput.val(),a)}},_renderDraftSaveNotification:function(){var b=I18n.t("txt.public.javascript.views.tickets.comment_drafts.comment_draft_saved");var a=b+' (<abbr id="draft_timestamp" title="'+this._iso8601Timestamp(new Date())+'"></abbr>)';this._renderDraftNotification(a);$j("#draft_timestamp").timeago()},_store:function(b,a){this.comment=b;this.commentPrivacy=a;this.localStorage.setItem(this.timestampKey,(new Date()).toString());this.localStorage.setItem(this.privacyKey,this.commentPrivacy);if(jQuery("#translated_flag").exists()&&jQuery("#translated_flag").val()=="true"){this.localStorage.setItem(this.translatedVersion,this.comment)}else{this.localStorage.setItem(this.key,this.comment)}},_renderDraftNotification:function(a){this.commentInput.css({backgroundPosition:"bottom center",paddingBottom:"25px"});if($j("#draft_status").length===0){this.commentInput.after('<div id="draft_status"></div>')}$j("#draft_status").html(a)},_zeropad:function(a){return((a<10)?"0":"")+a},_iso8601Timestamp:function(a){return a.getUTCFullYear()+"-"+this._zeropad(a.getUTCMonth()+1)+"-"+this._zeropad(a.getUTCDate())+"T"+this._zeropad(a.getUTCHours())+":"+this._zeropad(a.getUTCMinutes())+":"+this._zeropad(a.getUTCSeconds())+"Z"},_load:function(){return{comment:this.localStorage.getItem(this.key),commentPrivacy:this.localStorage.getItem(this.privacyKey)}},_clear:function(){this.localStorage.removeItem(this.key);this.localStorage.removeItem(this.timestampKey);this.localStorage.removeItem(this.privacyKey)},_isStale:function(){var b=this.localStorage.getItem(this.timestampKey);if(!b){return false}var a=(new Date()).getTime();b=new Date(b).getTime();return(a-b)>Zendesk.Ticket.CommentDrafts.STALE_TIMEOUT_SECONDS*1000}}});(function(a){a.widget("zd.ticketTagger",{_create:function(){var b=this.element.data("field-id");this.$input=this.element.parent().find("#ticket_fields_"+b);this.$output=this.element.find("#title-tagger-"+b);this._addBindings()},val:function(b){if(arguments.length===1){this.$input.val(b).change();return this}else{return this.$input.val()}},_addBindings:function(){var b=this;this.element.delegate("li.link","click.ticketTagger",function(){b.$input.val(a(this).data("value")).trigger("change.ticketTagger");selection_feedback($(this));return false});this.$input.bind("change.ticketTagger",function(c,d){var e=b._findLIByValue(a(this).val());b.$output.html(e.data("full-title"))})},_findLIByValue:function(b){return this.element.find('li.link[data-value="'+b+'"]')}});a(".field-tagger").ticketTagger()}(jQuery));function IncidentsWarning(){this._registerEvents()}IncidentsWarning.instance=null;IncidentsWarning.getInstance=function(){if(IncidentsWarning.instance===null){IncidentsWarning.instance=new IncidentsWarning()}return IncidentsWarning.instance};IncidentsWarning.prototype={confirmed:false,isShowingWarning:function(){var a=this;if($j("#associated_incidents_warning").length!==0&&a._updating()&&a._solving()&&!a.confirmed){$j.colorbox({inline:true,href:"#associated_incidents_warning"});return true}else{return false}},_registerEvents:function(){var a=this;$j("#confirm_incidents_warning").click(function(b){$j.colorbox.close();a.confirmed=true;submitTicketForm()});$j("#cancel_incidents_warning").click(function(b){$j.colorbox.close()})},_updating:function(){var a=$j("#submit_type").val();return a===""||a==="macro"||a==="entry"},_solving:function(){return $j("#ticket_status_id").val()==="3"},_addingPublicComment:function(){return $j.trim($j("#comment_value").val()).length!==0&&$j("#comment_is_public").is(":checked")}};$j(function(){var a=$j("#jira_details");if(a.length){var b=a.data("ticketid");$j.ajax({url:"/tickets/"+b+"/jira_ticket_details"}).done(function(f){f=$j.makeArray(f)[0];var e=(f.RESOLUTION||" - ");var c=(f.ASSIGNEE||" - ");var d="<ul>";d=d+"<li><strong>Issue ID</strong>: <a href="+f.URL+">"+f.KEY+"</a></li>";d=d+"<li><strong>Resolution</strong>: "+e+"</li>";d=d+"<li><strong>Assignee</strong>: "+c+"</li>";d=d+"</ul>";$j("#jira_ticket #jira_details").html(d)}).fail(function(){$j("#jira_ticket #jira_details").html("Unable to retrieve issue details from JIRA.")})}});jQuery(function(h){var b,j,v,s,c,e,f;var t,m,r;var d=h("#ticket_agreement_id");if(!d.length){return}b=h("#jira_project_id");s=h("#issue_type_id");f={};function n(w){m=d.data("jira-agreement-ids");return(h.inArray(w,m)!==-1)}function a(){if(!f){return}j=h("#jira_project_id option:selected").val();if(!j){return}c="";e=f[j].issueTypes;for(var w in e){if(e.hasOwnProperty(w)){c+='<option value="'+e[w].id+'">'+e[w].name+"</option>"}}s.html(c)}function o(){v="";for(var w in f){if(f.hasOwnProperty(w)){v+='<option value="'+w+'">'+f[w].name+"</option>"}}b.html(v)}function k(){if(!f){return}h.ajax({url:"/sharing_agreements/"+r+"/jira_projects"}).done(function(w){w.each(function(x){f[x.id]=x});o();a()}).fail(function(){h("#jira_projects").html("Unable to load projects from JIRA");h("#jira_issues").html("Unable to load issues types from JIRA")})}function l(){h.colorbox({width:"550px",inline:true,href:"#jira_sharing_options",onComplete:k,onLoad:function(){h("#cboxClose").remove()},overlayClose:false,escKey:false})}function q(){h.colorbox.close()}function u(){b.val("");s.val("");h("#jira_issue_key").val("")}function p(w){r=parseInt(w.target.value,10);if(n(r)){l()}else{u()}}function g(){u();h.colorbox.close()}h("#jira_sharing_options a").click(function(w){w.preventDefault()});h("#cancel_jira_sharing_options").click(g);h("#save_jira_sharing_options").click(q);d.change(p);b.change(a)});(function(c,d,a){var e=function(f){if(f.mode==="edit"){return false}f.mode="edit";f.previewModeLink.removeClass("disabled");f.editModeLink.addClass("disabled");f.markdownContainer.hide();f.commentField.show().focus();d(f.draftStatusSelector).show()};var b=function(f){if(f.mode==="preview"){return false}f.mode="preview";f.commentFieldHeight=f.commentField.height();f.editModeLink.removeClass("disabled");f.previewModeLink.addClass("disabled");f.markdownContainer.html('<center><img src="/images/ajax_loader_small.gif" alt="Loading"/></center>').css("min-height",f.commentFieldHeight).show();f.commentField.hide();d(f.draftStatusSelector).hide();var g=jQuery.ajax({url:"/api/v1/format/markdown.json",type:"POST",data:{text:f.commentField.val()}});g.done(function(h){f.markdownContainer.html(h.html)});g.fail(function(){f.markdownContainer.html(I18n.t("txt.admin.helpers.tickets_helper.preview_mode_error"))})};a.MarkdownPreview=function(f){f=f||{};this.previewModeLinkSelector=f.previewModeLinkSelector||"#comment_preview_mode_link";this.editModeLinkSelector=f.editModeLinkSelector||"#comment_edit_mode_link";this.markdownContainerSelector=f.markdownContainerSelector||"#markdown_preview";this.commentFieldSelector=f.commentFieldSelector||"#comment_value";this.draftStatusSelector=f.draftStatusSelector||"#draft_status";this.init(this)};a.MarkdownPreview.prototype.init=function(f){f.previewModeLink=d(f.previewModeLinkSelector);f.editModeLink=d(f.editModeLinkSelector);f.markdownContainer=d(f.markdownContainerSelector);f.commentField=d(f.commentFieldSelector);f.editModeLink.click(function(){e(f)});f.previewModeLink.click(function(){b(f)});e(f)}}(this,jQuery,Zendesk));$z.defModule("tickets/merge/show",{initialize:function(){},showMergeJobStatus:function(a){$j.colorbox.close();var b=a.responseJSON;var c=new Zendesk.JobStatus(b.status_url,{title:I18n.t("txt.public.javascripts.views.tickets.merge.merging_tickets"),renderResult:function(e){var d={title:"",body:$j("<ul/>")};if(e.status==="completed"){document.location="/merge/result?background="+e.job.id}return d}})}});function NewUserFromTicket(){this.registerEvents()}NewUserFromTicket.prototype={type:null,registerEvents:function(){var a=this;a.link().click(function(){a.type=$j(this).attr("data-type");$j.colorbox({href:$j(this).attr("href"),onComplete:function(){a.emailField().focus()}});return false});a.form().live("submit",function(){var b=$j.trim(a.emailField().val());if(b===""){alert(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.please_enter_an_email_address_new_user"));a.emailField().focus()}else{$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),beforeSend:function(c){a.submitButton().val(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.creating")).prop("disabled",true)},success:function(c){var d=null;if(c.email!=null&&c.email!==""){d=c.name+" <"+c.email+">"}if(a.type==="requester"){$j("#ticket_requester_name").val(d);$j("#ticket_requester_name").effect("highlight",{},3000)}else{collaboratorsInput.addEntry(c.id,d);$j("div#edit_cc li[choice_id="+c.id+"]").effect("highlight",{},3000)}$j.colorbox.close()},error:function(c,e,d){a.submitButton().val(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.create")).prop("disabled",false);if(c.responseText.include("The organization")){a.organizationField().focus();new Effect.Highlight(a.organizationField().attr("id"),{duration:3})}else{a.emailField().focus();new Effect.Highlight(a.emailField().attr("id"),{duration:3})}}})}return false})},link:function(){return $j("a.new_user_from_ticket")},form:function(){return $j("#new_user_form")},emailField:function(){return this.form().find("#user_email")},organizationField:function(){return this.form().find("#user_organization_name")},submitButton:function(){return this.form().find("input[type='submit']")}};var hexcase=0;var b64pad="";function hex_md5(a){return rstr2hex(rstr_md5(str2rstr_utf8(a)))}function b64_md5(a){return rstr2b64(rstr_md5(str2rstr_utf8(a)))}function any_md5(a,b){return rstr2any(rstr_md5(str2rstr_utf8(a)),b)}function hex_hmac_md5(a,b){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}function b64_hmac_md5(a,b){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}function any_hmac_md5(a,c,b){return rstr2any(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(c)),b)}function md5_vm_test(){return hex_md5("abc").toLowerCase()=="900150983cd24fb0d6963f7d28e17f72"}function rstr_md5(a){return binl2rstr(binl_md5(rstr2binl(a),a.length*8))}function rstr_hmac_md5(c,f){var e=rstr2binl(c);if(e.length>16){e=binl_md5(e,c.length*8)}var a=Array(16),d=Array(16);for(var b=0;b<16;b++){a[b]=e[b]^909522486;d[b]=e[b]^1549556828}var g=binl_md5(a.concat(rstr2binl(f)),512+f.length*8);return binl2rstr(binl_md5(d.concat(g),512+128))}function rstr2hex(c){try{hexcase}catch(g){hexcase=0}var f=hexcase?"0123456789ABCDEF":"0123456789abcdef";var b="";var a;for(var d=0;d<c.length;d++){a=c.charCodeAt(d);b+=f.charAt((a>>>4)&15)+f.charAt(a&15)}return b}function rstr2b64(c){try{b64pad}catch(h){b64pad=""}var g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b="";var a=c.length;for(var f=0;f<a;f+=3){var k=(c.charCodeAt(f)<<16)|(f+1<a?c.charCodeAt(f+1)<<8:0)|(f+2<a?c.charCodeAt(f+2):0);for(var d=0;d<4;d++){if(f*8+d*6>c.length*8){b+=b64pad}else{b+=g.charAt((k>>>6*(3-d))&63)}}}return b}function rstr2any(m,c){var b=c.length;var l,f,a,n,e;var k=Array(Math.ceil(m.length/2));for(l=0;l<k.length;l++){k[l]=(m.charCodeAt(l*2)<<8)|m.charCodeAt(l*2+1)}var h=Math.ceil(m.length*8/(Math.log(c.length)/Math.log(2)));var g=Array(h);for(f=0;f<h;f++){e=Array();n=0;for(l=0;l<k.length;l++){n=(n<<16)+k[l];a=Math.floor(n/b);n-=a*b;if(e.length>0||a>0){e[e.length]=a}}g[f]=n;k=e}var d="";for(l=g.length-1;l>=0;l--){d+=c.charAt(g[l])}return d}function str2rstr_utf8(c){var b="";var d=-1;var a,e;while(++d<c.length){a=c.charCodeAt(d);e=d+1<c.length?c.charCodeAt(d+1):0;if(55296<=a&&a<=56319&&56320<=e&&e<=57343){a=65536+((a&1023)<<10)+(e&1023);d++}if(a<=127){b+=String.fromCharCode(a)}else{if(a<=2047){b+=String.fromCharCode(192|((a>>>6)&31),128|(a&63))}else{if(a<=65535){b+=String.fromCharCode(224|((a>>>12)&15),128|((a>>>6)&63),128|(a&63))}else{if(a<=2097151){b+=String.fromCharCode(240|((a>>>18)&7),128|((a>>>12)&63),128|((a>>>6)&63),128|(a&63))}}}}}return b}function str2rstr_utf16le(b){var a="";for(var c=0;c<b.length;c++){a+=String.fromCharCode(b.charCodeAt(c)&255,(b.charCodeAt(c)>>>8)&255)}return a}function str2rstr_utf16be(b){var a="";for(var c=0;c<b.length;c++){a+=String.fromCharCode((b.charCodeAt(c)>>>8)&255,b.charCodeAt(c)&255)}return a}function rstr2binl(b){var a=Array(b.length>>2);for(var c=0;c<a.length;c++){a[c]=0}for(var c=0;c<b.length*8;c+=8){a[c>>5]|=(b.charCodeAt(c/8)&255)<<(c%32)}return a}function binl2rstr(b){var a="";for(var c=0;c<b.length*32;c+=8){a+=String.fromCharCode((b[c>>5]>>>(c%32))&255)}return a}function binl_md5(p,k){p[k>>5]|=128<<((k)%32);p[(((k+64)>>>9)<<4)+14]=k;var o=1732584193;var n=-271733879;var m=-1732584194;var l=271733878;for(var g=0;g<p.length;g+=16){var j=o;var h=n;var f=m;var e=l;o=md5_ff(o,n,m,l,p[g+0],7,-680876936);l=md5_ff(l,o,n,m,p[g+1],12,-389564586);m=md5_ff(m,l,o,n,p[g+2],17,606105819);n=md5_ff(n,m,l,o,p[g+3],22,-1044525330);o=md5_ff(o,n,m,l,p[g+4],7,-176418897);l=md5_ff(l,o,n,m,p[g+5],12,1200080426);m=md5_ff(m,l,o,n,p[g+6],17,-1473231341);n=md5_ff(n,m,l,o,p[g+7],22,-45705983);o=md5_ff(o,n,m,l,p[g+8],7,1770035416);l=md5_ff(l,o,n,m,p[g+9],12,-1958414417);m=md5_ff(m,l,o,n,p[g+10],17,-42063);n=md5_ff(n,m,l,o,p[g+11],22,-1990404162);o=md5_ff(o,n,m,l,p[g+12],7,1804603682);l=md5_ff(l,o,n,m,p[g+13],12,-40341101);m=md5_ff(m,l,o,n,p[g+14],17,-1502002290);n=md5_ff(n,m,l,o,p[g+15],22,1236535329);o=md5_gg(o,n,m,l,p[g+1],5,-165796510);l=md5_gg(l,o,n,m,p[g+6],9,-1069501632);m=md5_gg(m,l,o,n,p[g+11],14,643717713);n=md5_gg(n,m,l,o,p[g+0],20,-373897302);o=md5_gg(o,n,m,l,p[g+5],5,-701558691);l=md5_gg(l,o,n,m,p[g+10],9,38016083);m=md5_gg(m,l,o,n,p[g+15],14,-660478335);n=md5_gg(n,m,l,o,p[g+4],20,-405537848);o=md5_gg(o,n,m,l,p[g+9],5,568446438);l=md5_gg(l,o,n,m,p[g+14],9,-1019803690);m=md5_gg(m,l,o,n,p[g+3],14,-187363961);n=md5_gg(n,m,l,o,p[g+8],20,1163531501);o=md5_gg(o,n,m,l,p[g+13],5,-1444681467);l=md5_gg(l,o,n,m,p[g+2],9,-51403784);m=md5_gg(m,l,o,n,p[g+7],14,1735328473);n=md5_gg(n,m,l,o,p[g+12],20,-1926607734);o=md5_hh(o,n,m,l,p[g+5],4,-378558);l=md5_hh(l,o,n,m,p[g+8],11,-2022574463);m=md5_hh(m,l,o,n,p[g+11],16,1839030562);n=md5_hh(n,m,l,o,p[g+14],23,-35309556);o=md5_hh(o,n,m,l,p[g+1],4,-1530992060);l=md5_hh(l,o,n,m,p[g+4],11,1272893353);m=md5_hh(m,l,o,n,p[g+7],16,-155497632);n=md5_hh(n,m,l,o,p[g+10],23,-1094730640);o=md5_hh(o,n,m,l,p[g+13],4,681279174);l=md5_hh(l,o,n,m,p[g+0],11,-358537222);m=md5_hh(m,l,o,n,p[g+3],16,-722521979);n=md5_hh(n,m,l,o,p[g+6],23,76029189);o=md5_hh(o,n,m,l,p[g+9],4,-640364487);l=md5_hh(l,o,n,m,p[g+12],11,-421815835);m=md5_hh(m,l,o,n,p[g+15],16,530742520);n=md5_hh(n,m,l,o,p[g+2],23,-995338651);o=md5_ii(o,n,m,l,p[g+0],6,-198630844);l=md5_ii(l,o,n,m,p[g+7],10,1126891415);m=md5_ii(m,l,o,n,p[g+14],15,-1416354905);n=md5_ii(n,m,l,o,p[g+5],21,-57434055);o=md5_ii(o,n,m,l,p[g+12],6,1700485571);l=md5_ii(l,o,n,m,p[g+3],10,-1894986606);m=md5_ii(m,l,o,n,p[g+10],15,-1051523);n=md5_ii(n,m,l,o,p[g+1],21,-2054922799);o=md5_ii(o,n,m,l,p[g+8],6,1873313359);l=md5_ii(l,o,n,m,p[g+15],10,-30611744);m=md5_ii(m,l,o,n,p[g+6],15,-1560198380);n=md5_ii(n,m,l,o,p[g+13],21,1309151649);o=md5_ii(o,n,m,l,p[g+4],6,-145523070);l=md5_ii(l,o,n,m,p[g+11],10,-1120210379);m=md5_ii(m,l,o,n,p[g+2],15,718787259);n=md5_ii(n,m,l,o,p[g+9],21,-343485551);o=safe_add(o,j);n=safe_add(n,h);m=safe_add(m,f);l=safe_add(l,e)}return Array(o,n,m,l)}function md5_cmn(h,e,d,c,g,f){return safe_add(bit_rol(safe_add(safe_add(e,h),safe_add(c,f)),g),d)}function md5_ff(g,f,l,k,e,j,h){return md5_cmn((f&l)|((~f)&k),g,f,e,j,h)}function md5_gg(g,f,l,k,e,j,h){return md5_cmn((f&k)|(l&(~k)),g,f,e,j,h)}function md5_hh(g,f,l,k,e,j,h){return md5_cmn(f^l^k,g,f,e,j,h)}function md5_ii(g,f,l,k,e,j,h){return md5_cmn(l^(f|(~k)),g,f,e,j,h)}function safe_add(a,d){var c=(a&65535)+(d&65535);var b=(a>>16)+(d>>16)+(c>>16);return(b<<16)|(c&65535)}function bit_rol(a,b){return(a<<b)|(a>>>(32-b))}var TicketForm=function(){};TicketForm.prototype={_cacheFollowing:function(e,b,c){TicketForm.twitterFollowingCache=TicketForm.twitterFollowingCache||{};var a=TicketForm.twitterFollowingCache;var d=[e.screenName,b.screenName].join(",");if(c!==undefined){return a[d]=c}else{return a[d]}},isFollowing:function(d,c){var a=this;var b=this._cacheFollowing(d,c);if(b!==undefined){jQuery("#comment_channel_back option[value='dm']").prop("disabled",(b!==true));return}jQuery.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+d.id+"/1.1/friendships/lookup.json",data:{screen_name:c.screenName},type:"GET",success:function(e){a.isFollowingCallback(e,d,c)}})},isFollowingCallback:function(c,d,b){var a=!!c.find(function(e){return b.id===e.id&&e.connections.include("followed_by")});this._cacheFollowing(d,b,a);jQuery("#comment_channel_back option[value='dm']").prop("disabled",a!==true)},updateBalloon:function(){var b=jQuery("#comment_is_public");var a=jQuery("#comment_type");if(b.attr("checked")){a.removeClass("private");a.addClass("public")}else{a.removeClass("public");a.addClass("private")}},hidePreviewComment:function(){var a=this;var c=jQuery("#comment_is_public");var d=jQuery("#preview_translated_comment");var b=jQuery("#warning_gist_translation");if(jQuery("#tickets_to_bulk_update").exists()){d.hide();b.hide()}else{if(c.attr("checked")){d.show("fast");b.show("fast")}else{d.hide("fast");b.hide("fast");if(jQuery("#translated_flag").val()=="true"){a.revertToOriginalMessage()}}}},previewComment:function(a){var a=a;var b=this;jQuery("#preview_translated_comment").click(a,function(g){var c="drafts/"+ticket_id+"/"+currentUser.id+"/translatedHash";var h="drafts/"+ticket_id+"/"+currentUser.id+"/translated";if(jQuery("#translated_flag").val()=="false"){var f=localStorage.getItem(c);var k=jQuery("textarea#comment_value").val();var d=jQuery.trim(k);var e=hex_md5(d);jQuery("#original_comment").val(d);if((f===null)||(f!==e)){b.getTranslationOfComment(a,c,k,e)}else{var j=localStorage.getItem(h);jQuery("#translated_flag").val("true");jQuery("textarea#comment_value").val(j);jQuery("#preview_translated_comment").text(I18n.t("ticket_form.translate_comment.revert_to_my_language_v2"))}}else{jQuery("original_comment").val("");b.revertToOriginalMessage()}})},getTranslationOfComment:function(b,a,g,e){var d=currentAccount.secureUrlPrefix+"/api/v2/machine_translations.json";var c=g;var f=e;jQuery.post(d,{translate:{text:c,target:b}},function(h){var j=h.translation;localStorage.setItem(a,f);jQuery("textarea#comment_value").val(j);jQuery("#translated_flag").val("true");jQuery("#translated_flag").trigger("saveTranslated");jQuery("#preview_translated_comment").text(I18n.t("ticket_form.translate_comment.revert_to_my_language_v2"))})},revertToOriginalMessage:function(){revert=localStorage.getItem("drafts/"+ticket_id+"/"+currentUser.id);jQuery("textarea#comment_value").val(revert);jQuery("#translated_flag").val("false");jQuery("#preview_translated_comment").text(I18n.t("ticket_form.translate_comment.preview_my_comment_v2"))},updateTwitterControls:function(){var b=jQuery("#comment_is_public");var a=jQuery("#twitter_controls");(b.attr("checked"))?a.show():a.hide()},updateTwitterCounter:function(){var d=jQuery("#comment_is_public");var a=jQuery("#charcounter");var c=jQuery("#comment_channel_back").val();var b=jQuery("#comment_channel_back_dm");a.toggle(d.is(":checked")&&(c=="1"||c=="dm"))},updateMthSelector:function(){var b=jQuery("#comment_is_public");var a=jQuery("#monitored_twitter_handle_selection");(b.attr("checked"))?a.show():a.hide()},bindEditRequesterLink:function(){$j("#edit_requester_link a").bind("click",function(a){$j("#edit_requester").show();$j("#dynamic_requester").hide();$j("#static_requester").show();$j("#edit_requester_link").hide();return false})},bindCheckbox:function(){var a=this;jQuery("#comment_is_public").change(function(){a.updateBalloon();a.updateMthSelector();a.updateTwitterControls();a.updateTwitterCounter();a.hidePreviewComment()})},bindRadioButtons:function(){var a=this;jQuery('#twitter_controls input[type="radio"]').click(function(){a.updateTwitterCounter()})}};function TicketMergeWizard(){this.url="/merge/new?source_ids="+this.sources()+"&unchecked="+this.unchecked()+"&background=true";this.registerEvents();this.show()}TicketMergeWizard.prototype={url:null,registerEvents:function(){var a=this;a.winnerLinks().live("click",function(b){$j("#target_id").val($j(this).data("target-id"));a.winnerForm().submit();return false});$j(document).bind("cbox_closed",function(){$j("#submit-button").val("Submit").prop("disabled",false)})},show:function(){var a=this;$j.colorbox({href:this.url,onComplete:function(){if(a.loaded){return}a.winnerForm().submit(function(){var b=$j.trim($j("#target_id").val());if(b===""){alert("Please enter a ticket ID")}else{$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),success:function(c){$j.colorbox({html:c});a.appendComment()},error:function(c,e,d){$j.colorbox({html:c.responseText})}})}return false})}})},appendComment:function(){if($j.trim($j("#comment_value").val())!==""){var a="\n\nComment during merge: "+$j("#comment_value").val();$j("#target_comment").append(a);$j("#source_comment").append(a)}},sources:function(){if($j("#ticket-chat").attr("data-ticket")!==undefined){return $j("#ticket-chat").attr("data-ticket")}else{return this.checked()}},checked:function(){return this.values("input.tickets_to_bulk_update:checked")},unchecked:function(){return this.values("input.tickets_to_bulk_update:not(:checked)")},values:function(a){var b=[];$j(a).each(function(){b.push($j(this).val())});return b.join(",")},winnerForm:function(){return $j("#merge_form")},winnerField:function(){return this.winnerForm().find("input[type='text']")},continueButton:function(){return this.winnerForm().find("input[type='submit']")},winnerLinks:function(){return $j(".winner_selector")}};$z.defModule("tickets/new",{initialize:function(){$j("input#ticket_requester_name").focus();$z("tabindex").addtabindexes("input#ticket_requester_name","#edit_cc input","form#ticket-chat div.selects div.select > input[readonly != readonly][attribute_name != additional_tags],form#ticket-chat div.selects div.select > select[readonly != readonly],form#ticket-chat div.selects div.select > textarea[readonly != readonly]","textarea#comment_value","#ticket_tags",".selects .multi_value_field .search_field_item input","select#submit_type","input#submit_type","input#submit-button");$z("tickets").addSubmitBindings();$z("tickets").monitorRequesterChange();$z("tickets").autoselectAssigneesIfManyAgents();if($j("#ticket_linked_id").attr("auto-complete")){$j("#ticket_linked_id").autocompleteFromSelect()}new NewUserFromTicket();if(currentUser&&currentUser.isAgent){Zendesk.Instrumentation.ToTango.trackOperatingSystem()}}});$z.defModule("tickets/show",{initialize:function(){$j("textarea#comment_value").focus();$z("tabindex").addtabindexes("#edit_cc input","form#ticket-chat div.selects div.select > input[readonly != readonly][attribute_name != additional_tags], form#ticket-chat div.selects div.select > select[readonly != readonly], form#ticket-chat div.selects div.select > textarea[readonly != readonly]","#ticket_tags",".selects .multi_value_field .search_field_item input","textarea#comment_value","input#comment_is_public","select#submit_type","input#submit_type","input#submit-button");$z("tickets").addSubmitBindings();$z("tickets").monitorRequesterChange();$z("tickets").autoselectAssigneesIfManyAgents();if($j("#ticket_linked_id").attr("auto-complete")){$j("#ticket_linked_id").autocompleteFromSelect()}$j(".visibility-controls").click(function(){$j("a.toggle-twitter-data",this).toggle()});$j("a.toggle-twitter-data").click(function(){$j(".twitter-properties").toggle();return false});$j("#comment_full .link, #comment_partial .link").click(function(){$j("#comment_full, #comment_partial, #comment_up, #comment_down").toggle();return false});$j("#sharing_with :first-child").hover(function(){$j("#shared_tickets_list").fadeIn(300)},function(){$j("#shared_tickets_list").fadeOut(100)});if($j("body.tickets-show").length&&currentAccount.daysLeftInTrial){Zendesk.Instrumentation.ToTango.track("View Ticket","Trial")}new UserMergeWizard(false);new NewUserFromTicket();$j("input, select, textarea","#ticket_properties.read_only").prop("disabled",true);if(currentUser&&currentUser.isAgent){Zendesk.Instrumentation.ToTango.trackOperatingSystem()}Zendesk.Ticket.commentDrafts=new Zendesk.Ticket.CommentDrafts(ticket_id,currentUser.id,"#comment_value","#comment_is_public");Zendesk.Ticket.commentDrafts.startWatching();new Zendesk.Twitter.TicketCreationForm()._updateCounter()},setupCommentCharacterCounter:function(a){a=a||{};a.ticketPage=true;new Zendesk.Twitter.TicketCreationForm().setupTweetCounter(a)}});$z.defModule("tickets",{addSubmitBindings:function(){function b(c){c.preventDefault();if($j("input#submit-button").is(":disabled")){return}$j("input#submit-button").click()}function a(c){$j("form#submit_form select#submit_type option[value='next']").prop("selected",true);b(c)}(function(e){var d=83;function c(f){if(f.ctrlKey&&f.which===d){if(f.shiftKey){a(f)}else{b(f)}}}e(document).bind("keydown.zendesk.keyboard-shortcut",c)})(jQuery)},autoselectAssigneesIfManyAgents:function(){if(typeof(agents)!=="undefined"&&agents.length>LARGE_SELECT_LENGTH){$j("select.assignee").autocompleteFromSelect()}},monitorRequesterChange:function(){var a=new RegExp(/<(.*)>/);$j("#ticket_requester_name").observe_field(3,function(){if(a.test($j(this).val())){$z("tickets").requesterChanged($j(this))}})},requesterChanged:function(a){$j.ajax({url:"/tickets/requester_change",data:a.serialize(),beforeSend:function(){$j("#user_details").fadeOut("fast");$j("#add_widget_button").hide()},success:function(){$j("#user_details").fadeIn("fast");$j("#add_widget_button").show()}})}});Zendesk.NS("Twitter");Zendesk.Twitter.SearchApplication=function(f,k){k=k||{};var a=k.savedSearches,d=k.shortenedUrlFrequency,c=a[0];var j=function(n,m){var l=null;$j.each(n,function(o,p){if(m(p)){l=p;return}});return l};var h=function(m,l){g();this.poller=new TwitterSearchPoller(c.monitored_twitter_handle,m,l);this.poller.start()};var g=function(){if(this.poller){this.poller.stop();this.poller=null}};var b=function(){if($j("#monitored_twitter_handle_selection #monitored_twitter_handle_id").length){$j("#monitored_twitter_handle_selection #monitored_twitter_handle_id").val(self.currentSearch.monitored_twitter_handle.id)}};var e=f.sammy(function(){this.element_selector="#twitter_search";this.any("#/",function(m){var l=this;var n=this.params.q;var o=this.params.id;g();this.currentSearch=j(a,function(p){return(p.id==o)});l.currentMonitoredAccount=this.currentSearch.monitored_twitter_handle;Sammy.apps["#twitter_search"].trigger("search-configuration-changed",{search:this.currentSearch,query:n});l.currentSearchStream=new TwitterSearchStream(l.currentMonitoredAccount).searchFor(n,1,function(p){Sammy.apps["#twitter_search"].trigger("search-configuration-changed",{search:this.currentSearch,query:n});h(n,p[0].id_str)});return false});this.bind("on-error",function(m,l){$j("#twitter_search_loading_indicator").html(Zendesk.Twitter.Templates.twitter_is_down_template);$j("#twitter_search_loading_indicator").show()});this.bind("twitter-search-started",function(m){var l=Zendesk.Twitter.Templates.tweet_downloading_template;var n=$j.mustache(l);$j("#twitter_search_loading_indicator").html(n);$j("#twitter_search_loading_indicator").show();$j("#no_results").empty();$j("#twitter_new_result_count").empty()});this.bind("twitter-search-completed",function(n,m){new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#twitter_search_loading_indicator").slideUp("slow",function(){$j("#twitter_search_loading_indicator").empty()});if(m&&m.results&&m.results.length>0){new Zendesk.Twitter.SearchRenderer(m).render();var o=self.currentSearch.id;var l=m.results[0].id_str;if((typeof(Zendesk.Twitter._notifier)!="undefined")&&Zendesk.Twitter._notifier){Zendesk.Twitter._notifier.recordView(o,l)}Sammy.apps["#twitter_search"].trigger("update-timestamps")}else{if(typeof(Zendesk.Twitter._notifier)!="undefined"){Zendesk.Twitter._notifier.recordView(o,"0")}$j("#twitter_search_results").html("Your search returned no results.")}});this.bind("search-configuration-changed",function(m,l){self.currentSearch=l.search;self.currentMonitoredAccount=self.currentSearch.monitored_twitter_handle;$j("#twitter_search_name").html(l.search.safe_name);if(l.search.editable){$j("#twitter_edit_search_link").show();$j("#twitter_edit_search_link").attr("href","/twitter/search/"+l.search.id+"/edit")}else{$j("#twitter_edit_search_link").hide()}$j('#twitter_search_bar input[type="text"]').val(f("<div/>").html(l.query).text());$j('#twitter_search_bar input[type="hidden"]').val(l.search.id)});this.bind("convert-status-to-ticket",function(m,n){var l=$j("#tweet_"+n.id_str+" .drawer");b();new Zendesk.Twitter.TweetActivation().activate(n.id_str);new Zendesk.Twitter.TicketCreationForm().showSingleTicketForm(n,l,self.currentSearch.monitored_twitter_handle,d);l.find("#new_ticket #ticket_subject").val(n.text)});this.bind("drawer-cancel-btn-clicked",function(){new Zendesk.Twitter.TweetActivation().makeInactive()});this.bind("retweet-button-clicked",function(l,m){new Zendesk.Twitter.Retweet().show(m,self.currentMonitoredAccount);new Zendesk.Twitter.TweetActivation().activate(m.id_str)});this.bind("show-bulk-ticket-form-link-clicked",function(n,m){var l=[];$j(".tweet_checkbox:checked").map(function(o,p){l.push($j(p).val())});if(l.length>0){g();b();new Zendesk.Twitter.TweetActivation().activateBulkAction();new Zendesk.Twitter.TicketCreationForm().showBulkTicketForm(l,$j("#twitter_bulk_ticket_form"),d)}else{alert("Please select at least one tweet.")}});this.bind("mark-as-reviewed",function(l,m){new TwitterSearchActions().markAsReviewed(m)});this.bind("follow-button-clicked",function(l,m){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).displayConfirmationMessage(m);new Zendesk.Twitter.TweetActivation().activate(m.searchObj["id_str"])});this.bind("follow-success",function(l){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).successfulFollow()});this.bind("retweet-success",function(l){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).successfulFollow()});this.bind("next-page-btn-clicked",function(l,m){$j("#twitter_search #show_more").html('<img src="/images/loader.gif" />').css("background","none");new TwitterMultiRequest(self.currentMonitoredAccount).nextPage(m,function(n){new Zendesk.Twitter.SearchRenderer(n,false).render();Sammy.apps["#twitter_search"].trigger("update-timestamps")})});this.bind("update-timestamps",function(l){$j("a.timeago").attr("title",function(n,m){return new Date(m).toISOString()});$j("a.timeago").timeago()});this.bind("ticket-creation-success",function(l,m){var n=$j("#tweet_"+m.statusMessageId);n.find("input.tweet_checkbox").attr("checked",false).prop("disabled",true).addClass("inactive");n.find("a.convert_to_ticket").replaceWith('<span class="converted">'+I18n.t("txt.admin.views.twitter.search._ticket_form.Convert_to_Ticket")+"</span>");n.find(".review_status").html('<a href="/tickets/'+m.ticketId+'" class="ticket_badge" target="_blank">#'+m.ticketId+"</a>");if(self.bulkTicketWatcher){self.bulkTicketWatcher.markCompleted(m.statusMessageId)}else{new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);new Zendesk.Twitter.TweetActivation().makeInactive()}});this.bind("ticket-creation-failure",function(l,m){if(self.bulkTicketWatcher){self.bulkTicketWatcher.markFailed(m.statusMessageId)}else{new Zendesk.Twitter.TicketCreationForm()._showError(m);$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false)}});this.bind("bulk-ticket-creation-started",function(l,m){self.bulkTicketWatcher=new Zendesk.Twitter.BulkTicketWatcher(m)});this.bind("bulk-ticket-request-completed",function(m,l){$j("#bulk_creation_counter span").html(l);new Zendesk.Twitter.BulkActions().checkForBulkActivation()});this.bind("bulk-ticket-creation-complete",function(l,m){self.bulkTicketWatcher=null;new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);new Zendesk.Twitter.TweetActivation().makeInactive()});this.bindToAllEvents(function(){setTimeout(function(){new Zendesk.UI.NestedMenu("div.frame_header ul.drop-list").collapse()},50)})});f(function(){e.run("#/?q="+encodeURIComponent(c.query)+"&id="+c.id)});return e};Zendesk.NS("Twitter");Zendesk.Twitter.BulkActions=function(){};Zendesk.Twitter.BulkActions.prototype={setup:function(){$j("#bulk_review").click(function(a){a.preventDefault();var b=[];$j("#twitter_search_results input:checked").each(function(c,d){b.push($j(d).val())});Sammy.apps["#twitter_search"].trigger("mark-as-reviewed",b);return false});$j("#bulk_select").click(function(a){if($j("#bulk_select:checked").size()>0){$j(".tweet_checkbox:not(.inactive)").each(function(b,c){c.checked=true})}else{$j(".tweet_checkbox:checked").each(function(b,c){c.checked=false})}new Zendesk.Twitter.BulkActions().checkForBulkActivation()})},checkForBulkActivation:function(){if($j(".tweet_checkbox:checked").length>0){$j(".bulk_convert_button").prop("disabled",false)}else{$j(".bulk_convert_button").prop("disabled",true)}}};Zendesk.NS("Twitter");Zendesk.Twitter.BulkTicketWatcher=function(a){this.messageIds=a;this.requestCounter=0};Zendesk.Twitter.BulkTicketWatcher.prototype={markCompleted:function(a){this._observeRequestCompleted()},markFailed:function(a){this._observeRequestCompleted()},_observeRequestCompleted:function(){this.requestCounter+=1;Sammy.apps["#twitter_search"].trigger("bulk-ticket-request-completed",this.requestCounter);if(this.requestCounter>=this.messageIds.length){Sammy.apps["#twitter_search"].trigger("bulk-ticket-creation-complete",this.requestCounter)}}};Zendesk.NS("Twitter");Zendesk.Twitter.FollowActions=function(a){this.twitterAccount=a};Zendesk.Twitter.FollowActions.prototype={displayConfirmationMessage:function(d){var a=this;var e=$j(d.tweetElement);var b=Zendesk.Twitter.Templates.follow_confirmation_template;var c=$j.mustache(b,d.searchObj);e.find(".drawer").first().html(c).show();e.find(".drawer .confirm").first().click(function(){$j(".drawer .confirm").html(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")+' <img src="/images/indicator2.gif" />').css({backgroundColor:"#fff"});a.follow(d.searchObj.from_user);return false});e.find(".drawer .cancel").click(function(f){Sammy.apps["#twitter_search"].trigger("drawer-cancel-btn-clicked");f.preventDefault();return false})},follow:function(a){$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/1.1/friendships/create.json",type:"POST",data:{screen_name:a,follow:"true"},success:function(){Sammy.apps["#twitter_search"].trigger("follow-success")}})},successfulFollow:function(){$j(".activated a.follow").replaceWith('<span class="following">'+I18n.t("txt.admin.views.twitter.search.templates._tweet_controls_template.Following_label")+"</span>");new Zendesk.Twitter.TweetActivation().makeInactive()}};Zendesk.NS("Proxy");Zendesk.Proxy={domain:function(){var a=window.location.protocol+"//"+window.location.hostname;if(a.indexOf("localhost")!=-1){a+=":3000"}return a+"/proxy"}};Zendesk.NS("Twitter");Zendesk.Twitter.Retweet=function(){};Zendesk.Twitter.Retweet.prototype={show:function(d,c){var a=Zendesk.Twitter.Templates.retweet_template;var b=$j($j.mustache(a,{screen_name:c.screen_name}));b.find(".confirm").first().click(function(){$j("#tweet_"+d.id_str+" .confirm").html(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")+' <img src="/images/indicator2.gif" />').css({backgroundColor:"#fff"});$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+c.id+"/1.1/statuses/retweet/"+d.id_str+".json",type:"POST",success:function(e){$j("#tweet_"+d.id_str+" .retweet").replaceWith('<span class="retweeted">'+I18n.t("txt.admin.views.twitter.search.templates._tweet_controls_template.Retweeted_label")+"</span>");var f=c.screen_name.substring(1);$j("#tweet_"+d.id_str+" .meta").append('<span class="retweeted_by">'+I18n.t("txt.admin.javascript.views.twitter.retweeted_by_twitter")+'<a href="http://twitter.com/'+f+'">'+f+"</a>");new Zendesk.Twitter.TweetActivation().makeInactive()}})});$j("#tweet_"+d.id_str+" .drawer").html(b).show();$j("#tweet_"+d.id_str+" .drawer .cancel").click(function(e){Sammy.apps["#twitter_search"].trigger("drawer-cancel-btn-clicked");e.preventDefault();return false})}};Zendesk.NS("Twitter");Zendesk.Twitter.TicketCreationForm=function(){};Zendesk.Twitter.TicketCreationForm.prototype={_updateFollowing:function(b,c){var a={id:b.profile.id,screenName:b.profile.screen_name.replace(/@/,"")};new TicketForm().isFollowing(c,a)},showSingleTicketForm:function(f,e,a,c){var d={statusMessageIds:[f.id_str],targetContainer:e,shortenedUrlFrequency:c};this._showForm(d);if(f.follower){e.find("#comment_channel_back option[value='dm']").prop("disabled",false)}else{e.find("#comment_channel_back option[value='dm']").prop("disabled",true)}if(a){e.find("#ticket_monitored_twitter_handle_id").val(a.id);var g={id:a.id,screenName:a.screen_name.replace(/@/,"")};this._updateFollowing(f,g)}var b=this;e.find("#ticket_monitored_twitter_handle_id").change(function(){var h=e.find("#ticket_monitored_twitter_handle_id");var j={id:h.val(),screenName:h.find("option:selected").html().replace(/@/,"")};b._updateFollowing(f,j)})},showBulkTicketForm:function(b,e,a){var c={statusMessageIds:b,targetContainer:e,statusMessageSelector:this._getSelectedTweets,shortenedUrlFrequency:a};this._showForm(c);$j(".cancel_link.bottom").show();e.find("#channel_back_dm").show();e.find("#submit_button").click(function(){Sammy.apps["#twitter_search"].trigger("bulk-ticket-creation-started",b)});var d=function(){var f=I18n.t("txt.public.javascripts.views.twitter.search.ticket_creating_form.convert_many_tweets_to_tickets",{count:$j(".tweet input:checked").length});if($j(".tweet input:checked").length==1){f=I18n.t("txt.public.javascripts.views.twitter.search.ticket_creating_form.convert_one_tweet_to_ticket")}$j("#twitter_convert_to_ticket h3:first").html(f)};d();$j(".tweet input:not(.inactive)").bind("click.updateCount",function(){d()});e.find("#submit_button").bind("click.updateCount",function(){var f=$j(".tweet input:checked").length;$j(".cancel_link.bottom").hide();$j(this).after('<span id="bulk_creation_counter">'+I18n.t("txt.javascript.twitter.search.ticket_creating_form.bulk_ticket_update",{amount:f})+"</span>")})},_getSelectedTweets:function(){var a=[];$j(".tweet_checkbox:checked").map(function(b,c){a.push($j(c).val())});return a},_updateCounter:function(){if($j("textarea#comment_value").length===0){return}var c=twitterText.txt.extractUrls($j("textarea#comment_value").val());var a=c.join("").length;var b=0;for(i=0;i<c.length;i++){b+=(c[i].substr(0,5)=="https")?23:22}$j("div#charcounter > div").html(140-($j("#charcounter").data("offset")+$j("textarea#comment_value").val().length)+a-b)},_setupCharCounter:function(){var a=this;if($j("#charcounter").length===0){$j("div#comment_type").prepend('<div id="charcounter"><div title="Remaining Character Count: Characters past this limit will be truncated on Twitter but appear in their entirety in Zendesk. A shortened link to this ticket will be appended to the tweet, depending on the setup of your zendesk."></div></div>');$j("textarea#comment_value").keyup(function(){a._updateCounter()})}},_setOffset:function(b){b=b||{};var d,c,a;c=(b.ticketPage)?$j(".options .twitter a").html():$j("#tweet_"+b.statusMessageIds[0]+" .screen_name").html();a=b.shortenedUrlFrequency;d=a&&a==="always"?21:0;if(b.ticketPage){d+=c.length+1}else{if(b.statusMessageIds.length===1){d+=c.length+2}}this._setupCharCounter();$j("#charcounter").data("offset",d);$j("div#charcounter > div").html(140-d)},_handleReplyOrNot:function(){var a=$j("#comment_channel_back_optional_add_url");$j("#comment_channel_back").change(function(){a.toggle($j(this).val()!="no_action");new TicketForm().updateTwitterCounter()})},_handleAppendTicketUrl:function(){var a=this;$j("#comment_add_short_url").change(function(){var b=$j("#charcounter").data("offset");if($j(this).is(":checked")){$j("#charcounter").data("offset",b+21)}else{$j("#charcounter").data("offset",b-21)}a._updateCounter()})},setupTweetCounter:function(a){a=a||{};this._setOffset(a);this._handleReplyOrNot();this._handleAppendTicketUrl()},_showForm:function(e){e=e||{};var d=this,c=e.statusMessageIds,f=e.targetContainer,a=e.statusMessageSelector,b=e.shortenedUrlFrequency;this._addFormToContainer(f);f.slideDown(200);$j(".cancel_link.bottom").show();this.setupTweetCounter({ticketPage:false,statusMessageIds:c,shortenedUrlFrequency:b});f.find(".cancel_link").click(function(g){d._cancelForm();new Zendesk.Twitter.TweetActivation().makeInactive();return false});this._fillFormWithTweetInfo(d,c,f,a,b)},showSuccess:function(a){var b=a.location.match(/[0-9]+.json/ig)[0];var c=b.split(".")[0];Sammy.apps["#twitter_search"].trigger("ticket-creation-success",{statusMessageId:a.statusMessageId,ticketId:c,url:a.location})},apply_macro:function(c,b){var d=$j("#twitter_convert_to_ticket #new_ticket");new Zendesk.API.Macro(c).applyToTicket(0,d);var f=(b)?b:window.event;Event.stop(f);var a=f.findElement();selection_feedback(a);return(false)},_addFormToContainer:function(a){a.children().remove();$j("#twitter_convert_to_ticket").appendTo(a);a.find(".cancel_link").unbind("click");a.find("#comment_add_short_url").unbind("change");a.find("#submit_button").unbind("click")},_fillFormWithTweetInfo:function(d,c,e,a,b){e.find("select.assignee").autocompleteFromSelectIfLarge();e.find("#submit_button").click(function(g){e.find("#submit_button").val(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")).prop("disabled",true);var f=new Zendesk.API.TicketForm("#new_ticket");var h=(typeof(a)=="undefined")?c:a();$j.each(h,function(m,l){var j={"ticket[twitter_status_message_id]":l,"comment[is_public]":"1"};var n=jQuery("#tweet_"+l);if(c.length>1&&n.attr("data-follower")!="1"){j["ticket[skip_dm]"]="1"}var k=function(o,q,p){Sammy.apps["#twitter_search"].trigger("ticket-creation-failure",{statusMessageId:l,response:o.responseText})};f.createTicket([j]).done(function(r,s,q){var p=q.getResponseHeader("Location").match(/\/tickets\/[0-9]+\.json$/)[0];var o=function(){d.showSuccess({statusMessageId:l,location:p})};if(f.hasComment()){var r={"comment[value]":f.ticketForm.find('[name="comment[value]"]').val(),"comment[is_public]":f.ticketForm.find('[name="comment[is_public]"][type="checkbox"]').is(":checked"),"comment[channel_back]":f.ticketForm.find('[name="comment[channel_back]"]').val()};if(b==="optional"){r["comment[add_short_url]"]=f.ticketForm.find('[name="comment[add_short_url]"][type="checkbox"]').is(":checked")}$j.ajax({url:p,dataType:"text",type:"PUT",data:r}).done(o).fail(k)}else{o.call(this)}}).fail(k);Zendesk.Instrumentation.ToTango.track("Created","Twicket")});g.preventDefault();return false})},_cancelForm:function(){$j(".ticket_errors").hide();$j("#twitter_convert_to_ticket").appendTo($j("#ticket-conversion-template"));var a=$j("#twitter_convert_to_ticket form");a[0].reset();$j("input, select",a).css("color","");if(typeof(ticketTagField)!="undefined"){ticketTagField.clear()}a.find("#ticket_monitored_twitter_handle_id").unbind("change");a=new TicketForm();a.updateBalloon();a.updateTwitterControls();a.updateMthSelector()},_showError:function(a){var d=Zendesk.Twitter.Templates.ticket_conversion_error_template;var c={messageId:a.statusMessageId,errorMessages:this._errorMessages(a)};var b=$j($j.mustache(d,c));$j("#twitter_convert_to_ticket .cancel_link.top").after(b);$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false)},_errorMessages:function(a){var d=null;try{d=$j.parseJSON(a.response)}catch(b){return[{message:I18n.t("txt.javascript.views.twitter.search.ticket_creation_form.and_error_has_occurred")}]}var c=[];$j.each(d,function(e,f){if(f[0]=="base"){c.push({message:f[1]})}else{c.push({message:f[0]+" "+f[1]})}});return c}};Zendesk.NS("Twitter");Zendesk.Twitter.TweetActivation=function(){};Zendesk.Twitter.TweetActivation.prototype={makeInactive:function(a){$j("#twitter_convert_to_ticket h3:first").html(I18n.t("txt.admin.views.twitter.search._ticket_form.Convert_to_Ticket"));$j(".tweet input:not(.inactive)").unbind("click.updateCount");$j("#submit_button").unbind("click.updateCount");$j("#bulk_creation_counter").remove();if($j(".activated").length>0){if($j("html, body").scrollTop()>$j(".activated:first").offset().top){$j("html, body").animate({scrollTop:$j(".activated:first").offset().top},500)}$j(".activated:first").effect("highlight",{},1200)}new TwitterSearchActions().dropDrawers()},activate:function(a){$j(".tweet_actions").removeClass("enabled");$j("#tweet_"+a).addClass("activated");$j(".tweet input").prop("disabled",true)},activateBulkAction:function(){$j(".tweet_actions").removeClass("enabled")}};var TwitterMultiRequest=function(a){this.mthId=a.id;this.twitterAccount=a;this.tweetsPerPage=30};TwitterMultiRequest.prototype={searchFor:function(a,b){this.callback=b;this.searchType="query";this.fireRequests(a)},nextPage:function(b,a){this.callback=a;this.searchType="nextPage";this.fireRequests(b)},fireRequests:function(a){this.reset();this.search(a);this.getRetweets();this.getFriends();this.getFollowers()},reset:function(){this.metaData=null;this.searchData=null;this.retweetData=null;this.friendsData=null;this.followerData=null;this.lookupData=null;this.reviewedData=null},search:function(b){var a=this.searchOptions();if(this.searchType==="query"){a.data={count:this.tweetsPerPage,q:b}}else{a.url=a.url+b}$j.ajax(a)},searchOptions:function(){var a=this;return{url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/1.1/search/tweets.json",type:"GET",dataType:"jsonp",success:function(b){a.searchCallback(b)},error:function(c,b){Sammy.apps["#twitter_search"].trigger("on-error",b)}}},getMetaData:function(a){var b=this;$j.ajax({url:"/twitter/tickets/exist.json",data:{q:a.join(",")},type:"GET",success:function(c){b.metaDataCallback(c)},error:function(d,c){Sammy.apps["#twitter_search"].trigger("on-error",c)}})},getRetweets:function(){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1.1/statuses/user_timeline.json",type:"GET",data:{include_rts:true,user_id:this.twitterAccount.twitter_user_id,screen_name:this.twitterAccount.screen_name},dataType:"jsonp",success:function(b){a.retweetCallback(b)},error:function(c,b){Sammy.apps["#twitter_search"].trigger("on-error",b)}})},getFriends:function(){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1.1/friends/ids.json",data:{user_id:this.twitterAccount.twitter_user_id},type:"GET",dataType:"jsonp",success:function(b){a.friendsCallback(b)},error:function(c,b){Sammy.apps["#twitter_search"].trigger("on-error",b)}})},getFollowers:function(){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1.1/followers/ids.json",data:{screen_name:this.twitterAccount.screen_name},type:"GET",dataType:"jsonp",success:function(b){a.followersCallback(b)},error:function(c,b){Sammy.apps["#twitter_search"].trigger("on-error",b)}})},getReviewed:function(a){var b=this;$j.ajax({url:"/twitter/reviewed_tweets.json",data:{tweet_ids:a.join(",")},type:"GET",success:function(c){b.reviewedCallback(c)},error:function(d,c){Sammy.apps["#twitter_search"].trigger("on-error",c)}})},lookupUsers:function(b){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1.1/users/lookup.json",data:{screen_name:b.join(",")},type:"GET",dataType:"jsonp",success:function(c){a.lookupCallback(c)},error:function(d,c){Sammy.apps["#twitter_search"].trigger("on-error",c)}})},searchCallback:function(d){var a=[];var e=[];var b={};this.searchData=d;if(!this.searchData.statuses){Sammy.apps["#twitter_search"].trigger("on-error");return}$j.each(this.searchData.statuses,function(f,g){a.push(g.id_str);b[g.user.screen_name]=1});for(var c in b){e.push(c)}if(a.length===0||e.length===0){$j("#show_more").empty();$j("#twitter_search_loading_indicator").empty();$j("#twitter_search_results").html('<div id="no_results" class="message">'+I18n.t("txt.admin.public.javascript.views.twitter.search.application.your_search_returned_no_results_twitter")+"</div>")}else{this.getMetaData(a);this.lookupUsers(e);this.getReviewed(a)}},metaDataCallback:function(a){this.metaData=a;this.synchronizeCallbacks()},retweetCallback:function(a){this.retweetData=a;this.synchronizeCallbacks()},friendsCallback:function(a){this.friendsData=a;this.synchronizeCallbacks()},followersCallback:function(a){this.followersData=a;this.synchronizeCallbacks()},lookupCallback:function(a){this.lookupData=a;this.synchronizeCallbacks()},reviewedCallback:function(a){this.reviewedData=a;this.synchronizeCallbacks()},synchronizeCallbacks:function(){if(this.metaData&&this.retweetData&&this.friendsData&&this.lookupData&&this.followersData&&this.reviewedData){this.passThroughGate();this.working=false}},passThroughGate:function(){if(typeof(this.callback)!=="undefined"){var a=this.compileData();this.callback(a)}},compileData:function(){var b={results:[],nextPage:this.searchData.search_metadata.next_results};var a=this;$j.each(this.searchData.statuses,function(d,c){$j.each(a.metaData.tickets,function(e,f){if(f.status_id_str===c.id_str){c.ticketId=f.ticket_id;return false}});$j.each(a.retweetData,function(f,e){if(e&&e.retweet_count>0&&e.retweeted_status&&e.retweeted_status.id_str==c.id_str){c.retweeted=true;c.retweeted_by=e.user.screen_name;return false}});$j.each(a.lookupData,function(e,f){if(f.screen_name.toLowerCase()===c.user.screen_name.toLowerCase()){c.profile=f;return false}});$j.each(a.friendsData,function(f,e){if(typeof(e)=="string"){e=Number(e)}var g=typeof(e)=="number"?e==c.profile.id:(e.indexOf&&e.indexOf(c.profile.id)>-1);if(c.profile&&g){c.friend=true;c.profile.friend=true;return false}});$j.each(a.followersData,function(e,f){if(c.profile&&f==c.profile.id){c.follower=true;return false}});b.results.push(c)});if(b.results.length===this.tweetsPerPage){b.displayMoreLink=true}return b}};var TwitterSearchActions=function(a){this.mthId=a};TwitterSearchActions.prototype={dropDrawers:function(){$j(".tweet_actions").addClass("enabled");$j(".tweet input:not(.inactive)").prop("disabled",false);$j(".tweet .drawer").hide();$j(".tweet.activated").removeClass("activated")},showLoading:function(b,a){var d=$j("#tweet_"+b);var c=$j('<span><img src="/images/ajax_small_bar.gif" /></span>');d.find(a).html(c)},markAsReviewed:function(b){this.dropDrawers();var a=this;$j.each(b,function(d,c){a.showLoading(c,"span.review_status")});$j.ajax({url:"/twitter/reviewed_tweets.json",data:{tweet_ids:b.join(",")},type:"POST",success:function(c){a.reviewedCallback(c)}})},reviewedCallback:function(a){$j.each(a,function(c,b){var d=$j("#tweet_"+b);d.find(".review_status").first().html('<span class="reviewed">Reviewed</span>')})}};var TwitterSearchPoller=function(a,c,b){this.twitterAccount=a;this.query=c;this.mostRecentTweetId=b;this.tweetsPerPage=30;this.sleepTime=15000;this.killed=false};TwitterSearchPoller.prototype={start:function(){this.sleepThenPoll()},stop:function(){this.killed=true;$j("#twitter_new_result_count").empty()},sleepThenPoll:function(){var a=this;var b=setTimeout(function(){a.poll()},this.sleepTime)},poll:function(){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/1.1/search/tweets.json",type:"GET",dataType:"jsonp",data:{count:this.tweetsPerPage,q:this.query,since_id:this.mostRecentTweetId},success:function(b){a.callback(b)}})},callback:function(b){if(this.killed){return}var a=this.calculateNewTweetCount(b);if(a>0&&a<this.tweetsPerPage){this.renderNewTweetMessage(a)}if(a>=this.tweetsPerPage){this.renderMaxTweetsMessage()}else{this.sleepThenPoll()}},calculateNewTweetCount:function(a){if(a&&a.statuses&&a.statuses.length){return a.statuses.length}else{return 0}},renderNewTweetMessage:function(c){var d;if(c!=1){d=I18n.t("txt.admin.views.twitter.search.templates._more_tweets_template.count_new_tweets_plural",{count:c})}else{d=I18n.t("txt.admin.views.twitter.search.templates._more_tweets_template.count_new_tweets_singular")}var a={tweets:d};var b=$j.mustache(Zendesk.Twitter.Templates.more_tweets_template,a);$j("#twitter_new_result_count").html(b);$j("a.twitter_search_refresh").click(function(e){Sammy.apps["#twitter_search"].refresh();return false})},renderMaxTweetsMessage:function(){var a=$j.mustache(Zendesk.Twitter.Templates.max_tweets_template,{max:this.tweetsPerPage});$j("#twitter_new_result_count").html(a);$j("a.twitter_search_refresh").click(function(b){Sammy.apps["#twitter_search"].refresh();return false})}};var TwitterSearchPreview=function(){};TwitterSearchPreview.prototype={startQuery:function(b){var a=this;var c=$j("#twitter_search_monitored_twitter_handle_id").val();$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+c+"/1.1/search/tweets.json",type:"GET",dataType:"jsonp",data:{count:"5",q:b},success:function(d){a.queryCallback(d)}})},queryCallback:function(c){$j.each(c.statuses,function(d,e){e.profile_image_url=e.user.profile_image_url;e.from_user=e.user.screen_name});var a;a=Zendesk.Twitter.Templates.tweet_preview_template;var b=$j.mustache(a,c);$j("#tweet_preview_container").empty();$j("#tweet_preview_container").append(b);$j("a.timeago").attr("title",function(e,d){return new Date(d).toISOString()});$j("a.timeago").timeago()}};Zendesk.NS("Twitter");Zendesk.Twitter.SearchRenderer=function(b,a){this.data=b;if(typeof(a)=="undefined"){this.removeExistingStatuses=true}else{this.removeExistingStatuses=a}};Zendesk.Twitter.SearchRenderer.prototype={render:function(){var a=this;this.removeTemporaryElements();$j.each(this.data.results,function(c,e){var d=a.buildTweet(e);var b=a.buildTweetControls(e);d.find(".tweet_body").append(b);if(typeof(e.ticket_id)==="undefined"){a.attachEventsTo(d,e)}a.attachProfileMouseOver(d,e);$j("#twitter_search_results").append(d)});$j(".tweet_checkbox").unbind("change").change(function(b){new Zendesk.Twitter.BulkActions().checkForBulkActivation()});if(this.data.displayMoreLink){this.appendMoreLink()}},removeTemporaryElements:function(){$j("#twitter_search_results .temp").remove();if(this.removeExistingStatuses){$j("#twitter_search_results").empty()}},buildTweet:function(a){a.html=Zendesk.Text.autoLink(a.text);a.from_user=a.user.screen_name;a.profile_image_url=a.user.profile_image_url;return $j($j.mustache(Zendesk.Twitter.Templates.tweet_template,a))},buildTweetControls:function(a){return $j.mustache(Zendesk.Twitter.Templates.tweet_controls_template,a)},attachEventsTo:function(b,c){var a=this;b.find("a.convert_to_ticket").first().click(function(d){d.preventDefault();Sammy.apps["#twitter_search"].trigger("convert-status-to-ticket",c)});b.find("a.retweet").first().click(function(d){d.preventDefault();Sammy.apps["#twitter_search"].trigger("retweet-button-clicked",c)});b.find("a.follow").first().click(function(d){d.preventDefault();Sammy.apps["#twitter_search"].trigger("follow-button-clicked",{tweetElement:b,searchObj:c})});b.find("a.review").first().click(function(d){d.preventDefault();Sammy.apps["#twitter_search"].trigger("mark-as-reviewed",[c.id_str])})},attachProfileMouseOver:function(a,f){if(f.profile){var e=a.find("img.profile_image").first();var c=a.find(".profile_details").first();var b=Zendesk.Twitter.Templates.tweet_profile_hover;var d=$j.mustache(b,f.profile);c.html(d);e.mouseenter(function(){$j("#twitter_search_results .tweet").css("z-index","1");a.css("z-index","2");jQuery(".profile_details").hide();c.show()});c.mouseleave(function(){$j("#twitter_search_results .tweet").css("z-index","");c.hide()})}},appendMoreLink:function(){var a=this;more_link=$j("<a>"+I18n.t("txt.admin.javascript.views.twitter.twitter_search_renderer.show_more_results_label")+"</a>").click(function(b){Sammy.apps["#twitter_search"].trigger("next-page-btn-clicked",a.data.nextPage)});$j("#twitter_search #show_more").html(more_link)}};var TwitterSearchStream=function(a){this.twitterAccount=a;this.multiRequest=new TwitterMultiRequest(this.twitterAccount)};TwitterSearchStream.prototype={searchFor:function(d,c,a){Sammy.apps["#twitter_search"].trigger("twitter-search-started");var b=this;this.streamData=null;this.multiRequest.searchFor(d,function(e){Sammy.apps["#twitter_search"].trigger("twitter-search-completed",e);if(typeof(a)!="undefined"){a(e.results)}})},data:function(){return this.streamData},client:function(){return new TwitterSearchActions(this.twitterAccount.id)}};var TwitterSearchSorter=function(a){this.rootElement=a.first()};TwitterSearchSorter.prototype={init:function(){var a=this;this.reorderButton=this.rootElement.parent().find("a.reorder").first();this.reorderButton.click(function(c){a.rootElement.sortable();var b=jQuery("<a class='cancel-sorting'>"+I18n.t("txt.admin.javascript.views.twitter.cancel_label")+"</a>").click(function(){a.cancelSort()});var d=jQuery('<button class="button">'+I18n.t("txt.admin.javascript.views.twitter.done_label")+"</button>").click(function(){a.updatePositions()});a.rootElement.parent().find(".temp").append(d).append("&nbsp;").append(b);a.rootElement.parent().find(".edit_this").hide();a.reorderButton.parent().removeClass("item");a.reorderButton.hide()})},cancelSort:function(){try{this.rootElement.sortable("cancel")}catch(a){}this.rootElement.sortable("destroy");this.reset()},updatePositions:function(){var a=this;var b="/twitter/search/update_positions";this.rootElement.sortable("disable");jQuery.ajax({url:b+"?"+a.rootElement.sortable("serialize"),type:"POST",success:function(){a.updatePositionsCallback()}})},updatePositionsCallback:function(){this.rootElement.sortable("enable").sortable("destroy");this.reset()},reset:function(){var a=this.rootElement.parent();a.find(".temp").empty();a.find(".edit_this").show();this.reorderButton.parent().addClass("item");this.reorderButton.show()}};(function(){if(typeof k==="undefined"||k===null){var k={}}k.txt={};k.txt.regexen={};var h={"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#39;"};k.txt.htmlEscape=function(w){return w&&w.replace(/[&"'><]/g,function(x){return h[x]})};function g(x,w){w=w||"";if(typeof x!=="string"){if(x.global&&w.indexOf("g")<0){w+="g"}if(x.ignoreCase&&w.indexOf("i")<0){w+="i"}if(x.multiline&&w.indexOf("m")<0){w+="m"}x=x.source}return new RegExp(x.replace(/#\{(\w+)\}/g,function(z,y){var A=k.txt.regexen[y]||"";if(typeof A!=="string"){A=A.source}return A}),w)}k.txt.regexSupplant=g;function l(x,w){return x.replace(/#\{(\w+)\}/g,function(z,y){return w[y]||""})}k.txt.stringSupplant=l;function d(x,z,w){var y=String.fromCharCode(z);if(w!==z){y+="-"+String.fromCharCode(w)}x.push(y);return x}k.txt.addCharsToCharClass=d;var o=String.fromCharCode;var c=[o(32),o(133),o(160),o(5760),o(6158),o(8232),o(8233),o(8239),o(8287),o(12288)];d(c,9,13);d(c,8192,8202);var b=[o(65534),o(65279),o(65535)];d(b,8234,8238);k.txt.regexen.spaces_group=g(c.join(""));k.txt.regexen.spaces=g("["+c.join("")+"]");k.txt.regexen.invalid_chars_group=g(b.join(""));k.txt.regexen.punct=/\!'#%&'\(\)*\+,\\\-\.\/:;<=>\?@\[\]\^_{|}~\$/;k.txt.regexen.rtl_chars=/[\u0600-\u06FF]|[\u0750-\u077F]|[\u0590-\u05FF]|[\uFE70-\uFEFF]/mg;var a=[];d(a,1024,1279);d(a,1280,1319);d(a,11744,11775);d(a,42560,42655);d(a,1425,1471);d(a,1473,1474);d(a,1476,1477);d(a,1479,1479);d(a,1488,1514);d(a,1520,1524);d(a,64274,64296);d(a,64298,64310);d(a,64312,64316);d(a,64318,64318);d(a,64320,64321);d(a,64323,64324);d(a,64326,64335);d(a,1552,1562);d(a,1568,1631);d(a,1646,1747);d(a,1749,1756);d(a,1758,1768);d(a,1770,1775);d(a,1786,1788);d(a,1791,1791);d(a,1872,1919);d(a,2208,2208);d(a,2210,2220);d(a,2276,2302);d(a,64336,64433);d(a,64467,64829);d(a,64848,64911);d(a,64914,64967);d(a,65008,65019);d(a,65136,65140);d(a,65142,65276);d(a,8204,8204);d(a,3585,3642);d(a,3648,3662);d(a,4352,4607);d(a,12592,12677);d(a,43360,43391);d(a,44032,55215);d(a,55216,55295);d(a,65441,65500);d(a,12449,12538);d(a,12540,12542);d(a,65382,65439);d(a,65392,65392);d(a,65296,65305);d(a,65313,65338);d(a,65345,65370);d(a,12353,12438);d(a,12441,12446);d(a,13312,19903);d(a,19968,40959);d(a,173824,177983);d(a,177984,178207);d(a,194560,195103);d(a,12291,12291);d(a,12293,12293);d(a,12347,12347);k.txt.regexen.nonLatinHashtagChars=g(a.join(""));var s=[];d(s,192,214);d(s,216,246);d(s,248,255);d(s,256,591);d(s,595,596);d(s,598,599);d(s,601,601);d(s,603,603);d(s,611,611);d(s,616,616);d(s,623,623);d(s,626,626);d(s,649,649);d(s,651,651);d(s,699,699);d(s,768,879);d(s,7680,7935);k.txt.regexen.latinAccentChars=g(s.join(""));k.txt.regexen.hashSigns=/[#＃]/;k.txt.regexen.hashtagAlpha=g(/[a-z_#{latinAccentChars}#{nonLatinHashtagChars}]/i);k.txt.regexen.hashtagAlphaNumeric=g(/[a-z0-9_#{latinAccentChars}#{nonLatinHashtagChars}]/i);k.txt.regexen.endHashtagMatch=g(/^(?:#{hashSigns}|:\/\/)/);k.txt.regexen.hashtagBoundary=g(/(?:^|$|[^&a-z0-9_#{latinAccentChars}#{nonLatinHashtagChars}])/);k.txt.regexen.validHashtag=g(/(#{hashtagBoundary})(#{hashSigns})(#{hashtagAlphaNumeric}*#{hashtagAlpha}#{hashtagAlphaNumeric}*)/gi);k.txt.regexen.validMentionPrecedingChars=/(?:^|[^a-zA-Z0-9_!#$%&*@＠]|RT:?)/;k.txt.regexen.atSigns=/[@＠]/;k.txt.regexen.validMentionOrList=g("(#{validMentionPrecedingChars})(#{atSigns})([a-zA-Z0-9_]{1,20})(/[a-zA-Z][a-zA-Z0-9_-]{0,24})?","g");k.txt.regexen.validReply=g(/^(?:#{spaces})*#{atSigns}([a-zA-Z0-9_]{1,20})/);k.txt.regexen.endMentionMatch=g(/^(?:#{atSigns}|[#{latinAccentChars}]|:\/\/)/);k.txt.regexen.validUrlPrecedingChars=g(/(?:[^A-Za-z0-9@＠$#＃#{invalid_chars_group}]|^)/);k.txt.regexen.invalidUrlWithoutProtocolPrecedingChars=/[-_.\/]$/;k.txt.regexen.invalidDomainChars=l("#{punct}#{spaces_group}#{invalid_chars_group}",k.txt.regexen);k.txt.regexen.validDomainChars=g(/[^#{invalidDomainChars}]/);k.txt.regexen.validSubdomain=g(/(?:(?:#{validDomainChars}(?:[_-]|#{validDomainChars})*)?#{validDomainChars}\.)/);k.txt.regexen.validDomainName=g(/(?:(?:#{validDomainChars}(?:-|#{validDomainChars})*)?#{validDomainChars}\.)/);k.txt.regexen.validGTLD=g(/(?:(?:aero|asia|biz|cat|com|coop|edu|gov|info|int|jobs|mil|mobi|museum|name|net|org|pro|tel|travel|xxx)(?=[^0-9a-zA-Z]|$))/);k.txt.regexen.validCCTLD=g(/(?:(?:ac|ad|ae|af|ag|ai|al|am|an|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bm|bn|bo|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cs|cu|cv|cx|cy|cz|dd|de|dj|dk|dm|do|dz|ec|ee|eg|eh|er|es|et|eu|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|ss|st|su|sv|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tp|tr|tt|tv|tw|tz|ua|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw)(?=[^0-9a-zA-Z]|$))/);k.txt.regexen.validPunycode=g(/(?:xn--[0-9a-z]+)/);k.txt.regexen.validDomain=g(/(?:#{validSubdomain}*#{validDomainName}(?:#{validGTLD}|#{validCCTLD}|#{validPunycode}))/);k.txt.regexen.validAsciiDomain=g(/(?:(?:[\-a-z0-9#{latinAccentChars}]+)\.)+(?:#{validGTLD}|#{validCCTLD}|#{validPunycode})/gi);k.txt.regexen.invalidShortDomain=g(/^#{validDomainName}#{validCCTLD}$/);k.txt.regexen.validPortNumber=g(/[0-9]+/);k.txt.regexen.validGeneralUrlPathChars=g(/[a-z0-9!\*';:=\+,\.\$\/%#\[\]\-_~|&#{latinAccentChars}]/i);k.txt.regexen.validUrlBalancedParens=g(/\(#{validGeneralUrlPathChars}+\)/i);k.txt.regexen.validUrlPathEndingChars=g(/[\+\-a-z0-9=_#\/#{latinAccentChars}]|(?:#{validUrlBalancedParens})/i);k.txt.regexen.validUrlPath=g("(?:(?:#{validGeneralUrlPathChars}*(?:#{validUrlBalancedParens}#{validGeneralUrlPathChars}*)*#{validUrlPathEndingChars})|(?:@#{validGeneralUrlPathChars}+/))","i");k.txt.regexen.validUrlQueryChars=/[a-z0-9!?\*'@\(\);:&=\+\$\/%#\[\]\-_\.,~|]/i;k.txt.regexen.validUrlQueryEndingChars=/[a-z0-9_&=#\/]/i;k.txt.regexen.extractUrl=g("((#{validUrlPrecedingChars})((https?:\\/\\/)?(#{validDomain})(?::(#{validPortNumber}))?(\\/#{validUrlPath}*)?(\\?#{validUrlQueryChars}*#{validUrlQueryEndingChars})?))","gi");k.txt.regexen.validTcoUrl=/^https?:\/\/t\.co\/[a-z0-9]+/i;k.txt.regexen.cashtag=/[a-z]{1,6}(?:[._][a-z]{1,2})?/i;k.txt.regexen.validCashtag=g("(^|#{spaces})(\\$)(#{cashtag})(?=$|\\s|[#{punct}])","gi");k.txt.regexen.validateUrlUnreserved=/[a-z0-9\-._~]/i;k.txt.regexen.validateUrlPctEncoded=/(?:%[0-9a-f]{2})/i;k.txt.regexen.validateUrlSubDelims=/[!$&'()*+,;=]/i;k.txt.regexen.validateUrlPchar=g("(?:#{validateUrlUnreserved}|#{validateUrlPctEncoded}|#{validateUrlSubDelims}|[:|@])","i");k.txt.regexen.validateUrlScheme=/(?:[a-z][a-z0-9+\-.]*)/i;k.txt.regexen.validateUrlUserinfo=g("(?:#{validateUrlUnreserved}|#{validateUrlPctEncoded}|#{validateUrlSubDelims}|:)*","i");k.txt.regexen.validateUrlDecOctet=/(?:[0-9]|(?:[1-9][0-9])|(?:1[0-9]{2})|(?:2[0-4][0-9])|(?:25[0-5]))/i;k.txt.regexen.validateUrlIpv4=g(/(?:#{validateUrlDecOctet}(?:\.#{validateUrlDecOctet}){3})/i);k.txt.regexen.validateUrlIpv6=/(?:\[[a-f0-9:\.]+\])/i;k.txt.regexen.validateUrlIp=g("(?:#{validateUrlIpv4}|#{validateUrlIpv6})","i");k.txt.regexen.validateUrlSubDomainSegment=/(?:[a-z0-9](?:[a-z0-9_\-]*[a-z0-9])?)/i;k.txt.regexen.validateUrlDomainSegment=/(?:[a-z0-9](?:[a-z0-9\-]*[a-z0-9])?)/i;k.txt.regexen.validateUrlDomainTld=/(?:[a-z](?:[a-z0-9\-]*[a-z0-9])?)/i;k.txt.regexen.validateUrlDomain=g(/(?:(?:#{validateUrlSubDomainSegment]}\.)*(?:#{validateUrlDomainSegment]}\.)#{validateUrlDomainTld})/i);k.txt.regexen.validateUrlHost=g("(?:#{validateUrlIp}|#{validateUrlDomain})","i");k.txt.regexen.validateUrlUnicodeSubDomainSegment=/(?:(?:[a-z0-9]|[^\u0000-\u007f])(?:(?:[a-z0-9_\-]|[^\u0000-\u007f])*(?:[a-z0-9]|[^\u0000-\u007f]))?)/i;k.txt.regexen.validateUrlUnicodeDomainSegment=/(?:(?:[a-z0-9]|[^\u0000-\u007f])(?:(?:[a-z0-9\-]|[^\u0000-\u007f])*(?:[a-z0-9]|[^\u0000-\u007f]))?)/i;k.txt.regexen.validateUrlUnicodeDomainTld=/(?:(?:[a-z]|[^\u0000-\u007f])(?:(?:[a-z0-9\-]|[^\u0000-\u007f])*(?:[a-z0-9]|[^\u0000-\u007f]))?)/i;k.txt.regexen.validateUrlUnicodeDomain=g(/(?:(?:#{validateUrlUnicodeSubDomainSegment}\.)*(?:#{validateUrlUnicodeDomainSegment}\.)#{validateUrlUnicodeDomainTld})/i);k.txt.regexen.validateUrlUnicodeHost=g("(?:#{validateUrlIp}|#{validateUrlUnicodeDomain})","i");k.txt.regexen.validateUrlPort=/[0-9]{1,5}/;k.txt.regexen.validateUrlUnicodeAuthority=g("(?:(#{validateUrlUserinfo})@)?(#{validateUrlUnicodeHost})(?::(#{validateUrlPort}))?","i");k.txt.regexen.validateUrlAuthority=g("(?:(#{validateUrlUserinfo})@)?(#{validateUrlHost})(?::(#{validateUrlPort}))?","i");k.txt.regexen.validateUrlPath=g(/(\/#{validateUrlPchar}*)*/i);k.txt.regexen.validateUrlQuery=g(/(#{validateUrlPchar}|\/|\?)*/i);k.txt.regexen.validateUrlFragment=g(/(#{validateUrlPchar}|\/|\?)*/i);k.txt.regexen.validateUrlUnencoded=g("^(?:([^:/?#]+):\\/\\/)?([^/?#]*)([^?#]*)(?:\\?([^#]*))?(?:#(.*))?$","i");var u="tweet-url list-slug";var j="tweet-url username";var q="tweet-url hashtag";var f="tweet-url cashtag";var e={urlClass:true,listClass:true,usernameClass:true,hashtagClass:true,cashtagClass:true,usernameUrlBase:true,listUrlBase:true,hashtagUrlBase:true,cashtagUrlBase:true,usernameUrlBlock:true,listUrlBlock:true,hashtagUrlBlock:true,linkUrlBlock:true,usernameIncludeSymbol:true,suppressLists:true,suppressNoFollow:true,targetBlank:true,suppressDataScreenName:true,urlEntities:true,symbolTag:true,textWithSymbolTag:true,urlTarget:true,invisibleTagAttrs:true,linkAttributeBlock:true,linkTextBlock:true,htmlEscapeNonEntities:true};var t={disabled:true,readonly:true,multiple:true,checked:true};function r(y){var x={};for(var w in y){if(y.hasOwnProperty(w)){x[w]=y[w]}}return x}k.txt.tagAttrs=function(y){var z="";for(var x in y){var w=y[x];if(t[x]){w=w?x:null}if(w==null){continue}z+=" "+k.txt.htmlEscape(x)+'="'+k.txt.htmlEscape(w.toString())+'"'}return z};k.txt.linkToText=function(x,A,w,y){if(!y.suppressNoFollow){w.rel="nofollow"}if(y.linkAttributeBlock){y.linkAttributeBlock(x,w)}if(y.linkTextBlock){A=y.linkTextBlock(x,A)}var z={text:A,attr:k.txt.tagAttrs(w)};return l("<a#{attr}>#{text}</a>",z)};k.txt.linkToTextWithSymbol=function(x,A,C,w,y){var B=y.symbolTag?"<"+y.symbolTag+">"+A+"</"+y.symbolTag+">":A;C=k.txt.htmlEscape(C);var z=y.textWithSymbolTag?"<"+y.textWithSymbolTag+">"+C+"</"+y.textWithSymbolTag+">":C;if(y.usernameIncludeSymbol||!A.match(k.txt.regexen.atSigns)){return k.txt.linkToText(x,B+z,w,y)}else{return B+k.txt.linkToText(x,z,w,y)}};k.txt.linkToHashtag=function(w,B,y){var A=B.substring(w.indices[0],w.indices[0]+1);var z=k.txt.htmlEscape(w.hashtag);var x=r(y.htmlAttrs||{});x.href=y.hashtagUrlBase+z;x.title="#"+z;x["class"]=y.hashtagClass;if(z[0].match(k.txt.regexen.rtl_chars)){x["class"]+=" rtl"}if(y.targetBlank){x.target="_blank"}return k.txt.linkToTextWithSymbol(w,A,z,x,y)};k.txt.linkToCashtag=function(x,A,z){var w=k.txt.htmlEscape(x.cashtag);var y=r(z.htmlAttrs||{});y.href=z.cashtagUrlBase+w;y.title="$"+w;y["class"]=z.cashtagClass;if(z.targetBlank){y.target="_blank"}return k.txt.linkToTextWithSymbol(x,"$",w,y,z)};k.txt.linkToMentionAndList=function(y,C,A){var w=C.substring(y.indices[0],y.indices[0]+1);var x=k.txt.htmlEscape(y.screenName);var D=k.txt.htmlEscape(y.listSlug);var B=y.listSlug&&!A.suppressLists;var z=r(A.htmlAttrs||{});z["class"]=(B?A.listClass:A.usernameClass);z.href=B?A.listUrlBase+x+D:A.usernameUrlBase+x;if(!B&&!A.suppressDataScreenName){z["data-screen-name"]=x}if(A.targetBlank){z.target="_blank"}return k.txt.linkToTextWithSymbol(y,w,B?x+D:x,z,A)};k.txt.linkToUrl=function(w,C,z){var y=w.url;var D=y;var A=k.txt.htmlEscape(D);var B=(z.urlEntities&&z.urlEntities[y])||w;if(B.display_url){A=k.txt.linkTextWithEntity(B,z)}var x=r(z.htmlAttrs||{});x.href=y;if(z.targetBlank){x.target="_blank"}if(z.urlClass){x["class"]=z.urlClass}if(z.urlTarget){x.target=z.urlTarget}if(!z.title&&B.display_url){x.title=B.expanded_url}return k.txt.linkToText(w,A,x,z)};k.txt.linkTextWithEntity=function(z,A){var D=z.display_url;var y=z.expanded_url;var B=D.replace(/…/g,"");if(y.indexOf(B)!=-1){var C=y.indexOf(B);var x={displayUrlSansEllipses:B,beforeDisplayUrl:y.substr(0,C),afterDisplayUrl:y.substr(C+B.length),precedingEllipsis:D.match(/^…/)?"…":"",followingEllipsis:D.match(/…$/)?"…":""};for(var w in x){if(x.hasOwnProperty(w)){x[w]=k.txt.htmlEscape(x[w])}}x.invisible=A.invisibleTagAttrs;return l("<span class='tco-ellipsis'>#{precedingEllipsis}<span #{invisible}>&nbsp;</span></span><span #{invisible}>#{beforeDisplayUrl}</span><span class='js-display-url'>#{displayUrlSansEllipses}</span><span #{invisible}>#{afterDisplayUrl}</span><span class='tco-ellipsis'><span #{invisible}>&nbsp;</span>#{followingEllipsis}</span>",x)}return D};k.txt.autoLinkEntities=function(D,A,E){E=r(E||{});E.hashtagClass=E.hashtagClass||q;E.hashtagUrlBase=E.hashtagUrlBase||"https://twitter.com/#!/search?q=%23";E.cashtagClass=E.cashtagClass||f;E.cashtagUrlBase=E.cashtagUrlBase||"https://twitter.com/#!/search?q=%24";E.listClass=E.listClass||u;E.usernameClass=E.usernameClass||j;E.usernameUrlBase=E.usernameUrlBase||"https://twitter.com/";E.listUrlBase=E.listUrlBase||"https://twitter.com/";E.htmlAttrs=k.txt.extractHtmlAttrsFromOptions(E);E.invisibleTagAttrs=E.invisibleTagAttrs||"style='position:absolute;left:-9999px;'";var w,y,B;if(E.urlEntities){w={};for(y=0,B=E.urlEntities.length;y<B;y++){w[E.urlEntities[y].url]=E.urlEntities[y]}E.urlEntities=w}var F="";var z=0;A.sort(function(H,G){return H.indices[0]-G.indices[0]});var C=E.htmlEscapeNonEntities?k.txt.htmlEscape:function(G){return G};for(var y=0;y<A.length;y++){var x=A[y];F+=C(D.substring(z,x.indices[0]));if(x.url){F+=k.txt.linkToUrl(x,D,E)}else{if(x.hashtag){F+=k.txt.linkToHashtag(x,D,E)}else{if(x.screenName){F+=k.txt.linkToMentionAndList(x,D,E)}else{if(x.cashtag){F+=k.txt.linkToCashtag(x,D,E)}}}}z=x.indices[1]}F+=C(D.substring(z,D.length));return F};k.txt.autoLinkWithJSON=function(B,z,w){var A=[];for(var y in z){A=A.concat(z[y])}for(var x=0;x<A.length;x++){entity=A[x];if(entity.screen_name){entity.screenName=entity.screen_name}else{if(entity.text){entity.hashtag=entity.text}}}k.txt.modifyIndicesFromUnicodeToUTF16(B,A);return k.txt.autoLinkEntities(B,A,w)};k.txt.extractHtmlAttrsFromOptions=function(y){var z={};for(var x in y){var w=y[x];if(e[x]){continue}if(t[x]){w=w?x:null}if(w==null){continue}z[x]=w}return z};k.txt.autoLink=function(y,w){var x=k.txt.extractEntitiesWithIndices(y,{extractUrlsWithoutProtocol:false});return k.txt.autoLinkEntities(y,x,w)};k.txt.autoLinkUsernamesOrLists=function(y,w){var x=k.txt.extractMentionsOrListsWithIndices(y);return k.txt.autoLinkEntities(y,x,w)};k.txt.autoLinkHashtags=function(y,w){var x=k.txt.extractHashtagsWithIndices(y);return k.txt.autoLinkEntities(y,x,w)};k.txt.autoLinkCashtags=function(y,w){var x=k.txt.extractCashtagsWithIndices(y);return k.txt.autoLinkEntities(y,x,w)};k.txt.autoLinkUrlsCustom=function(y,w){var x=k.txt.extractUrlsWithIndices(y,{extractUrlsWithoutProtocol:false});return k.txt.autoLinkEntities(y,x,w)};k.txt.removeOverlappingEntities=function(y){y.sort(function(A,z){return A.indices[0]-z.indices[0]});var x=y[0];for(var w=1;w<y.length;w++){if(x.indices[1]>y[w].indices[0]){y.splice(w,1);w--}else{x=y[w]}}};k.txt.extractEntitiesWithIndices=function(y,w){var x=k.txt.extractUrlsWithIndices(y,w).concat(k.txt.extractMentionsOrListsWithIndices(y)).concat(k.txt.extractHashtagsWithIndices(y,{checkUrlOverlap:false})).concat(k.txt.extractCashtagsWithIndices(y));if(x.length==0){return[]}k.txt.removeOverlappingEntities(x);return x};k.txt.extractMentions=function(z){var A=[],w=k.txt.extractMentionsWithIndices(z);for(var y=0;y<w.length;y++){var x=w[y].screenName;A.push(x)}return A};k.txt.extractMentionsWithIndices=function(A){var w=[],z,y=k.txt.extractMentionsOrListsWithIndices(A);for(var x=0;x<y.length;x++){z=y[x];if(z.listSlug==""){w.push({screenName:z.screenName,indices:z.indices})}}return w};k.txt.extractMentionsOrListsWithIndices=function(x){if(!x||!x.match(k.txt.regexen.atSigns)){return[]}var w=[],y;x.replace(k.txt.regexen.validMentionOrList,function(G,H,D,C,z,E,I){var A=I.slice(E+G.length);if(!A.match(k.txt.regexen.endMentionMatch)){z=z||"";var F=E+H.length;var B=F+C.length+z.length+1;w.push({screenName:C,listSlug:z,indices:[F,B]})}});return w};k.txt.extractReplies=function(x){if(!x){return null}var w=x.match(k.txt.regexen.validReply);if(!w||RegExp.rightContext.match(k.txt.regexen.endMentionMatch)){return null}return w[1]};k.txt.extractUrls=function(A,x){var z=[],w=k.txt.extractUrlsWithIndices(A,x);for(var y=0;y<w.length;y++){z.push(w[y].url)}return z};k.txt.extractUrlsWithIndices=function(F,I){if(!I){I={extractUrlsWithoutProtocol:true}}if(!F||(I.extractUrlsWithoutProtocol?!F.match(/\./):!F.match(/:/))){return[]}var D=[];while(k.txt.regexen.extractUrl.exec(F)){var E=RegExp.$2,y=RegExp.$3,G=RegExp.$4,B=RegExp.$5,H=RegExp.$7;var z=k.txt.regexen.extractUrl.lastIndex,C=z-y.length;if(!G){if(!I.extractUrlsWithoutProtocol||E.match(k.txt.regexen.invalidUrlWithoutProtocolPrecedingChars)){continue}var x=null,A=false,w=0;B.replace(k.txt.regexen.validAsciiDomain,function(K){var J=B.indexOf(K,w);w=J+K.length;x={url:K,indices:[C+J,C+w]};A=K.match(k.txt.regexen.invalidShortDomain);if(!A){D.push(x)}});if(x==null){continue}if(H){if(A){D.push(x)}x.url=y.replace(B,x.url);x.indices[1]=z}}else{if(y.match(k.txt.regexen.validTcoUrl)){y=RegExp.lastMatch;z=C+y.length}D.push({url:y,indices:[C,z]})}}return D};k.txt.extractHashtags=function(z){var y=[],x=k.txt.extractHashtagsWithIndices(z);for(var w=0;w<x.length;w++){y.push(x[w].hashtag)}return y};k.txt.extractHashtagsWithIndices=function(B,x){if(!x){x={checkUrlOverlap:true}}if(!B||!B.match(k.txt.regexen.hashSigns)){return[]}var w=[];B.replace(k.txt.regexen.validHashtag,function(H,J,F,I,E,K){var C=K.slice(E+H.length);if(C.match(k.txt.regexen.endHashtagMatch)){return}var G=E+J.length;var D=G+I.length+1;w.push({hashtag:I,indices:[G,D]})});if(x.checkUrlOverlap){var z=k.txt.extractUrlsWithIndices(B);if(z.length>0){var A=w.concat(z);k.txt.removeOverlappingEntities(A);w=[];for(var y=0;y<A.length;y++){if(A[y].hashtag){w.push(A[y])}}}}return w};k.txt.extractCashtags=function(z){var w=[],x=k.txt.extractCashtagsWithIndices(z);for(var y=0;y<x.length;y++){w.push(x[y].cashtag)}return w};k.txt.extractCashtagsWithIndices=function(x){if(!x||x.indexOf("$")==-1){return[]}var w=[];x.replace(k.txt.regexen.validCashtag,function(B,E,y,z,F,A){var C=F+E.length;var D=C+z.length+1;w.push({cashtag:z,indices:[C,D]})});return w};k.txt.modifyIndicesFromUnicodeToUTF16=function(x,w){k.txt.convertUnicodeIndices(x,w,false)};k.txt.modifyIndicesFromUTF16ToUnicode=function(x,w){k.txt.convertUnicodeIndices(x,w,true)};k.txt.convertUnicodeIndices=function(E,B,x){if(B.length==0){return}var w=0;var y=0;B.sort(function(G,F){return G.indices[0]-F.indices[0]});var A=0;var z=B[0];while(w<E.length){if(z.indices[0]==(x?w:y)){var C=z.indices[1]-z.indices[0];z.indices[0]=x?y:w;z.indices[1]=z.indices[0]+C;A++;if(A==B.length){break}z=B[A]}var D=E.charCodeAt(w);if(55296<=D&&D<=56319&&w<E.length-1){D=E.charCodeAt(w+1);if(56320<=D&&D<=57343){w++}}y++;w++}};k.txt.splitTags=function(C){var w=C.split("<"),B,A=[],z;for(var y=0;y<w.length;y+=1){z=w[y];if(!z){A.push("")}else{B=z.split(">");for(var x=0;x<B.length;x+=1){A.push(B[x])}}}return A};k.txt.hitHighlight=function(H,J,z){var F="em";J=J||[];z=z||{};if(J.length===0){return H}var y=z.tag||F,I=["<"+y+">","</"+y+">"],G=k.txt.splitTags(H),M,L,C="",w=0,D=G[0],E=0,x=0,Q=false,A=D,K=[],B,N,R,P,O;for(M=0;M<J.length;M+=1){for(L=0;L<J[M].length;L+=1){K.push(J[M][L])}}for(B=0;B<K.length;B+=1){N=K[B];R=I[B%2];P=false;while(D!=null&&N>=E+D.length){C+=A.slice(x);if(Q&&N===E+A.length){C+=R;P=true}if(G[w+1]){C+="<"+G[w+1]+">"}E+=A.length;x=0;w+=2;D=G[w];A=D;Q=false}if(!P&&D!=null){O=N-E;C+=A.slice(x,O)+R;x=O;if(B%2===0){Q=true}else{Q=false}}else{if(!P){P=true;C+=R}}}if(D!=null){if(x<A.length){C+=A.slice(x)}for(B=w+1;B<G.length;B+=1){C+=(B%2===0?G[B]:"<"+G[B]+">")}}return C};var p=140;var m=[o(65534),o(65279),o(65535),o(8234),o(8235),o(8236),o(8237),o(8238)];k.txt.getTweetLength=function(A,x){if(!x){x={short_url_length:20,short_url_length_https:21}}var z=A.length;var w=k.txt.extractUrlsWithIndices(A);for(var y=0;y<w.length;y++){z+=w[y].indices[0]-w[y].indices[1];if(w[y].url.toLowerCase().match(/^https:\/\//)){z+=x.short_url_length_https}else{z+=x.short_url_length}}return z};k.txt.isInvalidTweet=function(x){if(!x){return"empty"}if(k.txt.getTweetLength(x)>p){return"too_long"}for(var w=0;w<m.length;w++){if(x.indexOf(m[w])>=0){return"invalid_characters"}}return false};k.txt.isValidTweetText=function(w){return !k.txt.isInvalidTweet(w)};k.txt.isValidUsername=function(x){if(!x){return false}var w=k.txt.extractMentions(x);return w.length===1&&w[0]===x.slice(1)};var n=g(/^#{validMentionOrList}$/);k.txt.isValidList=function(x){var w=x.match(n);return !!(w&&w[1]==""&&w[4])};k.txt.isValidHashtag=function(x){if(!x){return false}var w=k.txt.extractHashtags(x);return w.length===1&&w[0]===x.slice(1)};k.txt.isValidUrl=function(w,B,E){if(B==null){B=true}if(E==null){E=true}if(!w){return false}var x=w.match(k.txt.regexen.validateUrlUnencoded);if(!x||x[0]!==w){return false}var y=x[1],z=x[2],D=x[3],C=x[4],A=x[5];if(!((!E||(v(y,k.txt.regexen.validateUrlScheme)&&y.match(/^https?$/i)))&&v(D,k.txt.regexen.validateUrlPath)&&v(C,k.txt.regexen.validateUrlQuery,true)&&v(A,k.txt.regexen.validateUrlFragment,true))){return false}return(B&&v(z,k.txt.regexen.validateUrlUnicodeAuthority))||(!B&&v(z,k.txt.regexen.validateUrlAuthority))};function v(x,y,w){if(!w){return((typeof x==="string")&&x.match(y)&&RegExp["$&"]===x)}return(!x||(x.match(y)&&RegExp["$&"]===x))}if(typeof module!="undefined"&&module.exports){module.exports=k.txt}if(typeof window!="undefined"){window.twitterText=k}})();Zendesk.NS("Twitter");Zendesk.Twitter.Menu={init:function(){this.bindDismissTwitterMenu()},bindDismissTwitterMenu:function(){var a=this;jQuery(".hide_twitter_menu").click(function(b){b.preventDefault();a.dismissTwitterMenu()})},dismissTwitterMenu:function(){var a=this;jQuery.ajax({type:"PUT",url:"/twitter/settings.json",data:{account:{settings:{twitter_search_stream:0}}},success:function(){a.hideTwitterMenu()}})},hideTwitterMenu:function(){$j("#twitter_menu").remove()}};Zendesk.NS("Twitter");Zendesk.Twitter.Settings={init:function(){this.bindSettingsToggle();this.bindMakePrimary();this.bindRemovePrimary();this.bindChangeURLShortener();this.bindTestURLShortener()},bindSettingsToggle:function(){var a=jQuery("#monitored_accounts_frame .twitter_profile_card .toggle");a.toggle(function(){jQuery(this).html("Close settings").parents(".twitter_profile_card").addClass("activated")},function(){jQuery(this).html("Settings").parents(".twitter_profile_card").removeClass("activated")})},bindMakePrimary:function(){var a=this;jQuery("#monitored_accounts .make_primary").click(function(b){b.preventDefault();var c=jQuery(b.target).attr("id").split("_").last();a.makePrimary(c)})},makePrimary:function(b){var a=this;jQuery.ajax({type:"PUT",url:"/account/channels/"+b,dataType:"json",data:{monitored_twitter_handle:{master:true}},success:function(){a.displayPrimary(b)}})},displayPrimary:function(a){jQuery("#monitored_accounts .twitter_profile").removeClass("is_primary");jQuery("#monitored_accounts #twitter_profile_"+a).addClass("is_primary")},hidePrimary:function(a){jQuery("#monitored_accounts .twitter_profile").removeClass("is_primary");jQuery("#monitored_accounts #twitter_profile_"+a).removeClass("is_primary")},bindRemovePrimary:function(){var a=this;jQuery("#monitored_accounts .remove_primary").click(function(b){b.preventDefault();var c=jQuery(b.target).attr("id").split("_").last();a.removePrimary(c)})},removePrimary:function(b){var a=this;jQuery.ajax({type:"PUT",url:"/account/channels/"+b,dataType:"json",data:{monitored_twitter_handle:{master:false}},success:function(){a.hidePrimary(b)}})},bindChangeURLShortener:function(){$j("#url_shortener_name").change(function(){$j("#test_url_results").hide();var a=$j(this).val();$j(this).siblings("[data-if-shortener]").each(function(b,c){c=$j(c);if(c.attr("data-if-shortener")===a){$j("input, textarea, select",c).prop("disabled",false);c.show()}else{c.hide();$j("input, textarea, select",c).prop("disabled",true)}});$j("#test_url_shortener").show()}).change()},bindTestURLShortener:function(){$j("#test_url_shortener_link").click(function(){$j.ajax({url:"/twitter/settings/test_shorten",data:{name:$j("#url_shortener_name").val(),username:$j("#url_shortener_username:enabled").val(),api_key:$j("#url_shortener_api_key:enabled").val(),url:$j("#url_shortener_url:enabled").val()},dataType:"json",beforeSend:function(a){$j("#test_in_process").show();$j("#test_url_shortener").hide()},success:function(a){$j("#test_url_results").css("color","#333");$j("#test_url_results").html(I18n.t("txt.public.javascripts.twitter.settings.zendesk_twitter_settings.successfully_shortened_long_to_short",{long_url:"<a href="+a.long_url+">"+a.long_url+"</a>",short_url:"<a href="+a.short_url+">"+a.short_url+"</a>"})).show();$j("#test_in_process").hide()},error:function(){$j("#test_url_results").css("color","red");$j("#test_url_results").html(I18n.t("txt.admin.public.javascript.views.twitter.settings.zendesk_twitter_settings.check_your_settings")).show();$j("#test_in_process").hide();$j("#test_url_shortener").show()}});return false})}};(function(b){b.fn.zclip=function(a){if("object"==typeof a&&!a.length){var d=b.extend({path:"ZeroClipboard.swf",copy:null,beforeCopy:null,afterCopy:null,clickAfter:!0,setHandCursor:!0,setCSSEffects:!0},a);return this.each(function(){var c=b(this);if(c.is(":visible")&&("string"==typeof d.copy||b.isFunction(d.copy))){ZeroClipboard.setMoviePath(d.path);var e=new ZeroClipboard.Client;b.isFunction(d.copy)&&c.bind("zClip_copy",d.copy);b.isFunction(d.beforeCopy)&&c.bind("zClip_beforeCopy",d.beforeCopy);b.isFunction(d.afterCopy)&&c.bind("zClip_afterCopy",d.afterCopy);e.setHandCursor(d.setHandCursor);e.setCSSEffects(d.setCSSEffects);e.addEventListener("mouseOver",function(){c.trigger("mouseenter")});e.addEventListener("mouseOut",function(){c.trigger("mouseleave")});e.addEventListener("mouseDown",function(){c.trigger("mousedown");b.isFunction(d.copy)?e.setText(c.triggerHandler("zClip_copy")):e.setText(d.copy);b.isFunction(d.beforeCopy)&&c.trigger("zClip_beforeCopy")});e.addEventListener("complete",function(h,f){b.isFunction(d.afterCopy)?c.trigger("zClip_afterCopy"):(500<f.length&&(f=f.substr(0,500)+"...\n\n("+(f.length-500)+" characters not shown)"),c.removeClass("hover"),alert("Copied text to clipboard:\n\n "+f));d.clickAfter&&c.trigger("click")});e.glue(c[0],c.parent()[0]);b(window).bind("load resize",function(){e.reposition()})}})}if("string"==typeof a){return this.each(function(){var f=b(this);a=a.toLowerCase();var e=f.data("zclipId"),e=b("#"+e+".zclip");"remove"==a?(e.remove(),f.removeClass("active hover")):"hide"==a?(e.hide(),f.removeClass("active hover")):"show"==a&&e.show()})}}})(jQuery);var ZeroClipboard={version:"1.0.7",clients:{},moviePath:"ZeroClipboard.swf",nextId:1,$:function(b){"string"==typeof b&&(b=document.getElementById(b));b.addClass||(b.hide=function(){this.style.display="none"},b.show=function(){this.style.display=""},b.addClass=function(c){this.removeClass(c);this.className+=" "+c},b.removeClass=function(f){for(var j=this.className.split(/\s+/),g=-1,h=0;h<j.length;h++){j[h]==f&&(g=h,h=j.length)}-1<g&&(j.splice(g,1),this.className=j.join(" "));return this},b.hasClass=function(c){return !!this.className.match(RegExp("\\s*"+c+"\\s*"))});return b},setMoviePath:function(b){this.moviePath=b},dispatch:function(e,d,f){(e=this.clients[e])&&e.receiveEvent(d,f)},register:function(d,c){this.clients[d]=c},getDOMObjectPosition:function(e,d){var f={left:0,top:0,width:e.width?e.width:e.offsetWidth,height:e.height?e.height:e.offsetHeight};e&&e!=d&&(f.left+=e.offsetLeft,f.top+=e.offsetTop);return f},Client:function(b){this.handlers={};this.id=ZeroClipboard.nextId++;this.movieId="ZeroClipboardMovie_"+this.id;ZeroClipboard.register(this.id,this);b&&this.glue(b)}};ZeroClipboard.Client.prototype={id:0,ready:!1,movie:null,clipText:"",handCursorEnabled:!0,cssEffects:!0,handlers:null,glue:function(g,f,k){this.domElement=ZeroClipboard.$(g);g=99;this.domElement.style.zIndex&&(g=parseInt(this.domElement.style.zIndex,10)+1);"string"==typeof f?f=ZeroClipboard.$(f):"undefined"==typeof f&&(f=document.getElementsByTagName("body")[0]);var h=ZeroClipboard.getDOMObjectPosition(this.domElement,f);this.div=document.createElement("div");this.div.className="zclip";this.div.id="zclip-"+this.movieId;$j(this.domElement).data("zclipId","zclip-"+this.movieId);var j=this.div.style;j.position="absolute";j.left=""+h.left+"px";j.top=""+h.top+"px";j.width=""+h.width+"px";j.height=""+h.height+"px";j.zIndex=g;if("object"==typeof k){for(addedStyle in k){j[addedStyle]=k[addedStyle]}}f.appendChild(this.div);this.div.innerHTML=this.getHTML(h.width,h.height)},getHTML:function(g,f){var k="",h="id="+this.id+"&width="+g+"&height="+f;if(navigator.userAgent.match(/MSIE/)){var j=location.href.match(/^https/i)?"https://":"http://",k=k+('<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="'+j+'download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+g+'" height="'+f+'" id="'+this.movieId+'" align="middle"><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+ZeroClipboard.moviePath+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+h+'"/><param name="wmode" value="transparent"/></object>')}else{k+='<embed id="'+this.movieId+'" src="'+ZeroClipboard.moviePath+'" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+g+'" height="'+f+'" name="'+this.movieId+'" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+h+'" wmode="transparent" />'}return k},hide:function(){this.div&&(this.div.style.left="-2000px")},show:function(){this.reposition()},destroy:function(){if(this.domElement&&this.div){this.hide();this.div.innerHTML="";var d=document.getElementsByTagName("body")[0];try{d.removeChild(this.div)}catch(c){}this.div=this.domElement=null}},reposition:function(d){d&&((this.domElement=ZeroClipboard.$(d))||this.hide());if(this.domElement&&this.div){var d=ZeroClipboard.getDOMObjectPosition(this.domElement),c=this.div.style;c.left=""+d.left+"px";c.top=""+d.top+"px"}},setText:function(b){this.clipText=b;this.ready&&this.movie.setText(b)},addEventListener:function(d,c){d=d.toString().toLowerCase().replace(/^on/,"");this.handlers[d]||(this.handlers[d]=[]);this.handlers[d].push(c)},setHandCursor:function(b){this.handCursorEnabled=b;this.ready&&this.movie.setHandCursor(b)},setCSSEffects:function(b){this.cssEffects=!!b},receiveEvent:function(k,j){k=k.toString().toLowerCase().replace(/^on/,"");switch(k){case"load":this.movie=document.getElementById(this.movieId);if(!this.movie){var q=this;setTimeout(function(){q.receiveEvent("load",null)},1);return}if(!this.ready&&navigator.userAgent.match(/Firefox/)&&navigator.userAgent.match(/Windows/)){q=this;setTimeout(function(){q.receiveEvent("load",null)},100);this.ready=!0;return}this.ready=!0;try{this.movie.setText(this.clipText)}catch(o){}try{this.movie.setHandCursor(this.handCursorEnabled)}catch(p){}break;case"mouseover":this.domElement&&this.cssEffects&&(this.domElement.addClass("hover"),this.recoverActive&&this.domElement.addClass("active"));break;case"mouseout":this.domElement&&this.cssEffects&&(this.recoverActive=!1,this.domElement.hasClass("active")&&(this.domElement.removeClass("active"),this.recoverActive=!0),this.domElement.removeClass("hover"));break;case"mousedown":this.domElement&&this.cssEffects&&this.domElement.addClass("active");break;case"mouseup":this.domElement&&this.cssEffects&&(this.domElement.removeClass("active"),this.recoverActive=!1)}if(this.handlers[k]){for(var l=0,m=this.handlers[k].length;l<m;l++){var n=this.handlers[k][l];if("function"==typeof n){n(this,j)}else{if("object"==typeof n&&2==n.length){n[0][n[1]](this,j)}else{if("string"==typeof n){window[n](this,j)}}}}}}};(function(c,a){var b=Minilog("voice");var d=c.sammy("#call-console",function(){this.use("Mustache");this.use("ActiveTemplate");this.call=null;this.state="idle";this.restoring=false;this.maxDisplayStringLength=30;this.init=function(g){this.capabilityToken=g;this.clientAvailable=false;this.name="CallConsole";b.info("#init");c(window).load(function(){_.delay(function(){b.info("#twilio-load-start");var h=a.currentAccount.hasFeature("voiceWebRTC")?"1.1":"1.0",j="//static.twilio.com/libs/twiliojs/"+h+"/twilio.min.js";c.getScript(j,function(l,n,m){b.info("#twilio-load-finish",{status:n});if(n==="success"){if(!window.Twilio){b.error("#twilio-load-error",{message:"ec5"});a.voiceMenu&&a.voiceMenu.updateAvailability("off","twilio");alert(I18n.t("txt.voice.error.ec5"));return}c("#__soundFlash__").css("visibility","hidden");if(a.voiceMenu){var k=a.voiceMenu.backOff([1,2,4,8],function(){return Twilio&&Twilio.MediaStream});k.done(function(){c("#__soundFlash__").css("visibility","hidden")})}d.hookUpTwilioDevice()}else{b.error("#twilio-load-error",{message:"ec10"});a.voiceMenu&&a.voiceMenu.updateAvailability("off","twilio-asset");alert(I18n.t("txt.voice.error.ec10"))}})},100)});var f=this;c(window).bind("beforeunload",function(){var j=f.call;if(j){var k=j.outgoing_kind,h=j&&j.status!=="completed"&&j.status!=="ended"&&j.status!=="cancelled";if(k==="client"&&h){return I18n.t("txt.voice.warning.on_browser_exit")}}});c(window).unload(function(){window.voiceUnloading=true});this.setupVoiceInMaintenance();this.callOverlay=new a.CallOverlay();this.banner=new a.VoiceBanner();if(a.currentUser.voice.current_call){d.setCurrentCall(a.currentUser.voice.current_call)}};this.showConsoleIfNeeded=function(){if(!this.$element().is(":visible")){this.trigger("show-console")}};this.hideConsoleIfNeeded=function(){if(this.$element().is(":visible")){this.trigger("close-console")}};this.logTrigger=function(f,g){b.info("#trigger",{name:f,payload:g});this.trigger.apply(this,[f,g])};this.safeTrigger=_.debounce(this.logTrigger,300);this.retrigger=function(){if(this.lastTrigger){b.info("#retrigger",{last:this.lastTrigger});this.safeTrigger(this.lastTrigger)}};this.getCallInfo=function(g,l,k,f){var h=this;if(!f){f=new jQuery.Deferred()}if(this.callInfoDeferred){this.callInfoDeferred.reject(h.call);this.callInfoDeferred=f}var j={};if(d.call&&d.call.id){j.call_id=d.call.id}else{j.outgoing_sid=g}c.ajax({url:"/voice/calls/incoming_info",type:"GET",data:j,dataType:"json"}).always(function(m){if(m.outbound){h.setCurrentCall(m);f.resolve(m)}else{if(k&&!k(m)&&!f.isResolved()){if(l<1){if(m&&g&&!m.outgoing_sid){m.outgoing_sid=g}h.setCurrentCall(m);b.error("#incoming-info-failed",{sid:g,data:m});f.reject(h.call)}else{var n=_.bind(h.getCallInfo,h);_.delay(n,1000,g,l-1,k,f);b.info("#incoming-info-retry",{sid:g,tries:l})}}else{b.debug("#incoming-info-retrieved",{sid:g,tries:l});h.setCurrentCall(m);f.resolve(m)}}});return f.promise()};this.waitForAfterSetup=function(){b.info("#twilio-device-wait");if(!Twilio.Device.__afterSetup){b.info("#twilio-device-still-waiting");setTimeout(this.waitForAfterSetup.bind(this),100)}else{if(this.afterSetupCallback){this.afterSetupCallback()}}};this.hookUpTwilioDevice=function(){var f=this;b.info("#hookup-device-start");if(!window.Twilio){b.info("#hookup-device-error",{message:"no-twilio"});return}var g=function(h){f._acceptCalls=(h!=="off");if(h==="client"&&!f.clientAvailable&&!f.clientReadying){f.clientReadying=true;a.voiceMenu.catchFlash(function(){f.afterSetupCallback=function(){b.info("#twilio-device-after-setup-callback");if(Twilio.Device.__afterSetup){Twilio.Device.__afterSetup(function(){Twilio.Device.instance.log.handler=function(j){if(typeof j==="string"){b.debug("#twilio-device",j)}else{b.debug("#twilio-device",JSON.stringify(j))}}})}if(window.WebSocket&&!window.WebSocket.__flash&&window.WebSocket.__initialize){WebSocket.__initialize()}b.info("#twilio-device-setup",{token:f.capabilityToken,debug:a.currentUser.voice.logging});Twilio.Device.setup(f.capabilityToken,{debug:a.currentUser.voice.logging})};if(a.currentUser.voice.logging){f.waitForAfterSetup()}else{f.afterSetupCallback()}})}};RadarClient.alloc("voice_availability",function(){RadarClient.status("voice_availability/"+a.currentAccount.subdomain).get(function(h){var j=h.value&&h.value[a.currentUser.id];g(j)}).on(function(j){var h=parseInt(j.key,10);if(h===a.currentUser.id){g(j.value)}}).subscribe()});Twilio.Device.ready(function(j){b.info("#twilio-ready",{status:j._status});f.clientAvailable=true;f.clientReadying=false;if(!f.fightStaged){var h=a.RadarFight;f.fight=new h("ringer",{win:function(){Twilio.Device.sounds.incoming(true)},lose:function(){Twilio.Device.sounds.incoming(false)},check:function(){return Twilio.Device.sounds.incoming()}})}f.fightStaged=true;if(a.voiceMenu.flashPermissionsDeferred){Twilio.MediaStream.__queue(function(){a.voiceMenu.showFlashPermissions()});a.voiceMenu.flashPermissionsDeferred=null}});Twilio.Device.incoming(function(h){b.info("#twilio-incoming",{conn:h.parameters});f.connection=h;if(!f._acceptCalls&&h){h.disconnect()}h.error(function(j){b.error("#twilio-error2",{conn:h.parameters,message:j.message,code:j.code})});f.clearState();f.getCallInfo(h.parameters.CallSid,3,function(j){return j&&j.status=="routing"}).always(function(){f.gotCallInfo=true;f.trigger("routing");f.gotCallInfo=false}).fail(function(){f.call.human_calling_number="Unknown"})});Twilio.Device.connect(function(h){b.info("#twilio-connect",{conn:h.parameters});f.connection=h;f.getCallInfo(h.parameters.CallSid,15,function(j){return j&&j.status==="in_conference"}).done(function(){f.getCallInfo(h.parameters.CallSid,5,function(j){return j&&j.connected_at}).always(function(){f.trigger("in_conference");f.lastTrigger="in_conference";f.callOverlay.show();f.getCallInfo(h.parameters.CallSid,10,function(j){return j&&j.ticket&&j.ticket.nice_id}).done(function(j){f.retrigger()})}).fail(function(){f.call.connected_at=new Date();f.retrigger()})}).fail(function(){b.error("#twilio-connect:conference-fail",{conn:h.parameters,kind:a.currentUser.availableForVoiceOn});if(a.currentUser.availableForVoiceOn==="client"){b.error("#twilio-connect:disconnect:start",{conn:h.parameters});Twilio.Device.instance.disconnectAll();b.error("#twilio-connect:disconnect:finished",{conn:h.parameters})}})});Twilio.Device.disconnect(function(h){b.info("#twilio-disconnect",{conn:h.parameters});f.connection=null;f.callOverlay.hide();f.getCallInfo(h.parameters.CallSid,3,function(j){return j&&j.status==="completed"||j.status==="ended"}).done(function(){f.getCallInfo(h.parameters.CallSid,5,function(j){return j&&j.recording_url&&j.is_recording_url_ready}).always(function(j){f.trigger(j.status);f.lastTrigger=j.status;f.getCallInfo(h.parameters.CallSid,3,function(k){return k&&k.ticket&&k.ticket.nice_id}).always(function(k){f.retrigger()})})}).fail(function(){f.trigger("missed-call")})});Twilio.Device.cancel(function(h){b.info("#twilio-cancel",{conn:h.parameters});f.connection=null;f.getCallInfo(h.parameters.CallSid,3,function(j){return j&&j.id&&j.reasons&&j.reasons[a.currentUser.id]}).done(function(){f.trigger("missed-call")}).fail(function(){f.trigger("close-console")})});Twilio.Device.offline(function(){b.error("#twilio-offline",{args:arguments});f.connection=null;f.clientAvailable=false;f.clientReadying=false;if(f.checkingOffline||a.currentUser.availableForVoiceOn!=="client"){return}var h=a.voiceMenu.backOff([2,4,8,16],function(){if(Twilio.Device.status()!=="ready"){Twilio.Device.setup(f.capabilityToken,{debug:a.currentUser.voice.logging});return false}else{return true}});h.fail(function(){f.knockOfflineIfNotUnloading()}).always(function(){f.checkingOffline=false});f.checkingOffline=true});f.invalidTokenCount=0;f.refreshing=false;Twilio.Device.error(function(h){b.error("#twilio-error",{conn:f.connection&&f.connection.parameters,message:h.message,code:h.code});f.connection=null;if(a.currentUser.availableForVoiceOn!=="client"){return}if((f.fight&&f.fight.check())||!f.clientAvailable){if(h.message==="No microphone is available"){b.error("#twilio-no-microphone-error",{message:"ec2"});alert(I18n.t("txt.voice.error.ec2"));a.voiceMenu.updateAvailability("off","error-ec2")}else{if(h.message==="This AccessToken is no longer valid"){f.refreshCapabilityToken()}else{b.error("#twilio-unknown-error",{message:"ec3"});alert(I18n.t("txt.voice.error.ec3"));a.voiceMenu.updateAvailability("off","error-ec3")}}}});b.info("#hookup-device-finish")};this.refreshCapabilityToken=function(){var g=this;var f=a.currentUser.voice.client_capability_token;if(this.refreshing){return}if(this.invalidTokenCount>=3){b.error("#invalid-token-error",{message:"ec13"});a.voiceMenu.updateAvailability("off","error-ec13");alert(I18n.t("txt.voice.error.ec13"));return}this.refreshing=true;this.invalidTokenCount++;b.info("#refresh-token",{count:g.invalidTokenCount});jQuery.ajax({async:false,url:"/generated/javascripts/voice.json"}).done(function(h){a.currentUser.voice=h;if(f!=a.currentUser.voice.client_capability_token){b.info("#new-token","#twilio-device-setup",{count:g.invalidTokenCount,token:a.currentUser.voice.client_capability_token});Twilio.Device.setup(a.currentUser.voice.client_capability_token,{debug:a.currentUser.voice.logging})}else{b.error("#stale-token",{count:g.invalidTokenCount,token:f})}g.refreshing=false})};this.knockOfflineIfNotUnloading=function(){var f=this;var g=a.voiceMenu.backOff([1,2,3],function(){return window.voiceUnloading});g.fail(function(){if(f.fight&&f.fight.check()){b.error("#twilio-offline-error",{message:"ec1"});a.voiceMenu.updateAvailability("off","offline");alert(I18n.t("txt.voice.error.ec1"))}})};this.setupVoiceInMaintenance=function(){if(!a.currentUser.voice.in_maintenance){return}c(".console-title-bar").addClass("notice");c(".console-title-notice").css("display","block")};this._muteCall=function(f){if(this.connection){if(f){b.info("#mute");this.connection.mute()}else{b.info("#unmute");this.connection.unmute()}}};this.restoreState=function(){if(!this.call){return}else{if(this.call.outgoing_kind!=="client"||this.call.status==="completed"){this.state=this.call.status;this.trigger(this.state,this.call)}}};this.clearState=function(){this.callOverlay.hide();this.stopTimer();this.call=null};var e=function(){};e.prototype={ignoring:false,ignore:function(){this.ignoring=true},reset:function(){this.ignoring=false}};this.reasonMessaging=new e();this.setCurrentCall=function(f){if(!f){return this.call}if(f.caller){f.caller.name=this.truncateString(f.caller.name,this.maxDisplayStringLength);if(f.caller.organization){f.caller.organization.name=this.truncateString(f.caller.organization.name,15)}}b.debug("#set-current-call",{call:f});this.call=f;this.call.calling_number_encoded=encodeURIComponent(f.calling_number);return this.call};this.bind("run",function(f){this.app.restoreState()});this.bind("show-console",function(f){b.info("#show-console");this.$element().show()});this.bind("unanswered",function(f){this.trigger("close-console")});this.bind("close-console",function(f){b.info("#close-console");this.$element().hide();this.app.clearState()});this.bind("accept-call",function(g,f){b.info("#accept-call",{available:a.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(a.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.accept()}else{this.app.updateCall("agent_accepts")}this.renderTemplate(c("#title_bar_waiting_template"));this.renderTemplate(c("#action_bar_accepted_call_template"))});this.bind("deny-call",function(g,f){b.info("#deny-call",{available:a.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(a.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.disconnect()}this.app.updateCall("agent_declines");this.app.reasonMessaging.ignore();this.trigger("close-console")});this.bind("end-call",function(g,f){b.info("#end-call",{available:a.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(a.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.disconnect()}else{this.app.updateCall("agent_end_call")}this.renderTemplate(c("#action_bar_ending_call_template"));this.$element().find(".console-number").slideUp("slow")});this.bind("mute-call",function(g,f){if(this.app.clientAvailable){if(this.$element().find(".mute_call").hasClass("muted")){this.app._muteCall(false)}else{this.app._muteCall(true)}this.$element().find(".mute_call").toggleClass("muted")}});this.bind("finish-call",function(g,f){b.info("#finish-call",{available:a.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(!this.app.call){return}if(this.app.audioPlayer){this.app.audioPlayer.pause()}this.app.updateCall("finish");this.trigger("close-console")});this.bind("close",function(g,f){this.trigger("close-console")});this.bind("missed-call",function(m){this.app.callOverlay.hide();b.info("#missed-call");if(a.currentUser.availableForVoiceOn==="client"){Twilio.Device.instance.disconnectAll()}if(this.app.reasonMessaging.ignoring){b.info("#ignore-reason-messaging");this.trigger("close-console");return}var f=this;var j=function(){if(!f.app.call.reasons){return}var u=f.app.call.reasons[a.currentUser.id];if(!u){return}var t=u[u.length-1];var s=f.app.call.reasons.all;if(t.title==="call_returned_to_queue"){if(s.length>0){for(var q=s.length-1;q>=0;q--){var r=s[q];var p=new Date(r.at);var o=new Date(t.at);if(p>=o){return r}}}}return t};var l=j();if(!l){return}b.info("#missed-call",{reason:l});var n=l.title;var g=l.details;if(n!=="call_routed_to_agent"){n=I18n.t("txt.views.voice.call_console.reason.title."+n);if(g){g=I18n.t("txt.views.voice.call_console.reason.detail."+g)}}else{n=I18n.t("txt.views.voice.call_console.reason.title."+n,{name:g});g=null}var h=n&&g;var k=c("#title_bar_missed_call_template");if(c(".console-title-text").hasClass("waiting")){k=c("#title_bar_unable_to_accept_call_template")}this.renderTemplate(k,{id:f.app.call.id}).then(function(){var o=c(".console-title-content");o.zclip({path:"/javascripts/ZeroClipboard.swf",copy:""+f.app.call.id,afterCopy:function(){},setCSSEffects:true});o.hover(function(){o.find(".title").hide();o.find(".call-id").show();o.addClass("clickable")},function(){o.find(".title").show();o.find(".call-id").hide();o.removeClass("clickable")})});this.renderTemplate(c("#routing_reason_template"),{title:n,details:g,both:h});this.renderTemplate(c("#action_bar_close_template"));this.app.showConsoleIfNeeded()});this.setCall=function(f){this.call=f;this.call.calling_number_encoded=encodeURIComponent(f.calling_number)};this.updateCall=function(h){var g=this;var f=g.$element().is(":visible");c.ajax({url:"/voice/calls/update_status?call_id="+this.call.id+"&outgoing_sid="+this.call.outgoing_sid,type:"POST",data:{event:h},error:function(){b.error("#update-call-error",{message:"ec4"});alert(I18n.t("txt.voice.error.ec4"));if(f){g.showConsoleIfNeeded()}else{g.hideConsoleIfNeeded()}}})};this.startTimer=function(){if(this.timer){return}var f=new Voice.Timer(this.$element().find(".console-title-text"));if(this.call&&this.call.connected_at){this.timer=new Voice.TimerManager(f,new Date(this.call.connected_at))}else{this.timer=new Voice.TimerManager(f,new Date())}};this.stopTimer=function(){if(this.timer){this.timer.stop();delete this.timer}};this.bind("routing",function(j,f){b.info("#trigger-routing",{available:a.currentUser.availableForVoiceOn,gotInfo:this.app.gotCallInfo});if(a.currentUser.availableForVoiceOn==="client"&&!this.app.gotCallInfo){return}f=this.app.setCurrentCall(f);var g=this;this.app.reasonMessaging.reset();this.renderTemplate(c("#title_bar_incoming_call_template")).then(function(){g.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call_answer_in"));var k=new Voice.CountdownTimer(g.$element().find(".console-title-timer"));k.stop(function(){g.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call"))});g.app.routingTimer=new Voice.TimerManager(k,new Date((new Date()).valueOf()+f.answer_in*1000))});this.renderTemplate(c("#number_template"),f);this.$element().find(".console-number").show();this.renderTemplate(c("#call_console_user_card"),f);var h=f.outbound?"action_bar_in_call_template":"action_bar_user_calling_template";this.renderTemplate(c("#"+h),f);this.app.showConsoleIfNeeded()});this.bind("accepted",function(g,f){b.info("#trigger-accepted",{available:a.currentUser.availableForVoiceOn,gotInfo:this.app.gotCallInfo});this.renderTemplate(c("#title_bar_waiting_template"));this.renderTemplate(c("#action_bar_accepted_call_template"));this.app.showConsoleIfNeeded()});this.bind("check_agent",function(h,f){var g=this;if(g.app.routingTimer){g.app.routingTimer.stop();delete g.app.routingTimer}this.renderTemplate(c("#title_bar_incoming_call_template")).then(function(){g.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call_accept_in"));var j=new Voice.CountdownTimer(g.$element().find(".console-title-timer"));j.stop(function(){g.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call"))});new Voice.TimerManager(j,new Date((new Date()).valueOf()+f.accept_in*1000))})});this.bind("in_conference",function(h,f){b.info("#trigger-in-conference",{available:a.currentUser.availableForVoiceOn,client:this.app.clientAvailable});if(a.currentUser.availableForVoiceOn==="client"&&!this.app.clientAvailable){return}f=this.app.setCurrentCall(f);var g=this;this.renderTemplate(c("#action_bar_in_call_template"));this.renderTemplate(c("#number_template"),f);this.$element().find(".console-number").show();this.renderTemplate(c("#call_console_user_card"),f);if(!this.app.timer){this.renderTemplate(c("#title_bar_in_call_template")).then(function(){if(a.currentUser.availableForVoiceOn==="client"){g.$element().find(".mute_call").show();g.$element().find(".mute_call").unbind("click");g.$element().find(".mute_call").click(function(){g.app.trigger("mute-call")})}else{g.$element().find(".mute_call").hide()}g.app.startTimer()})}this.app.showConsoleIfNeeded()});this.bind("completed",function(h,f){f=this.app.setCurrentCall(f);var g=this;b.info("#trigger-completed",{wrap:f["agent_wrap_up_after_calls?"]});if(f["agent_wrap_up_after_calls?"]===false){this.trigger("close-console");return}this.app.stopTimer();this.$element().find(".mute_call").hide();this.$element().find(".console-number").hide();this.renderTemplate(c("#title_bar_call_ended_template"));this.renderTemplate(c("#action_bar_completed_call_template"));this.renderTemplate(c("#call_console_user_card"),f).then(function(){g.app.setupAudioPlayer()});this.app.showConsoleIfNeeded()});this.bind("voicemail",function(){this.trigger("missed-call")});this.bind("voicemail_transcription_completed",function(){this.trigger("missed-call")});this.bind("cancelled",function(){this.trigger("missed-call")});this.bind("queued",function(){this.trigger("missed-call")});this.bind("ended",function(){this.trigger("close-console")});this.truncateString=function(g,f){if(g.length>f){g=g.slice(0,f-g.length)+"..."}return g};this.notFound=function(){};this.messageHandler=_.bind(function(h){h=h.value;var f=h.name;var j=h.data;var g=h.triggers;if(_.isUndefined(f)){return}this.setCurrentCall(j);if(j.outgoing_kind!=="client"||j.status==="completed"||j.status==="ended"){d.safeTrigger(f,j)}},this);this.subscribeForMessages=function(){if(a.currentUser.voice.in_maintenance){return}b.info("#subscribe-for-messages",{channel:"call_console."+a.currentUser.id});var f=this;RadarClient.alloc("current_call",function(){RadarClient.status("call_console/"+a.currentUser.id).on(f.messageHandler.bind(f)).subscribe()})};this.pubsubChannel="call_console."+a.currentUser.id;this.initAudioPlayer=function(){var f=this;b.info("#init-audio-player-start",{call:f.call});var g=new Player({domId:"audio_player_console_"+f.call.id,url:f.call.player_recording_urls,swfUrl:"/media/voice/soundmanager"})};this.setupAudioPlayer=function(){var f=this;if(this.call.recording_url&&this.call.is_recording_url_ready){f.initAudioPlayer()}else{if(this.call.outgoing_sid){this.getCallInfo(this.call.outgoing_sid,3,function(g){return g&&g.recording_url&&g.is_recording_url_ready}).done(function(){f.initAudioPlayer()})}}}});a.CallConsoleApp=d}(jQuery,Zendesk));(function(b,a){a.CallOverlay=(function(){var f,c;var d=function(){if(!c){b("#call-console a, #cboxWrapper a").live("click",function(g){if(!f){return}g.preventDefault();g.stopPropagation();window.open(this.href,"_blank")});c=true}};function e(){this.show=function(){f=true;b("#voice-blocking-banner").slideDown(1000);b("#voice-blocking-overlay").show();d()};this.hide=function(){f=false;b("#voice-blocking-banner").slideUp(1000);b("#voice-blocking-overlay").hide()}}return e})()}(jQuery,Zendesk));(function(c,a){var b=Minilog("fight");a.RadarFight=(function(){function d(j,h){this.options=h||{};this.check=h.check||function(){};this.win=h.win||function(){};this.lose=h.lose||function(){};var g=this;var k="voice.fight."+a.currentUser.id;var f;var l=function(m){if(f!==undefined&&(f==m)){return}b.info("#transition",f,m);f=m;switch(f){case"win":g.win();break;case"lose":g.lose();break}};var e=[];RadarClient.alloc(k,function(){RadarClient.presence(k).set("online").on(function(o){var m;if(o.op==="client_online"){m=o.value.clientId;e.push(m);if(m===RadarClient._socket.id){l("win")}else{l("lose")}}else{if(o.op==="client_offline"){m=o.value.clientId;var n=e.indexOf(m);if(n>-1){e.splice(n,1)}if(e[e.length-1]===RadarClient._socket.id){l("win")}else{l("lose")}}}}).sync()})}return d}())}(jQuery,Zendesk));Zendesk.NS("Voice");Zendesk.Voice.AssociateGreetingNumbers={init:function(a){this.container=$j(a);this.setup()},setup:function(a){var b=this;this.container.find(".std_tile").click(function(){b.toggleNumberSelected($j(this));b.updateSelectedNumbers($j(this))})},toggleNumberSelected:function(a){a.toggleClass("selected")},updateSelectedNumbers:function(){var a=this.container.find(".std_tile.selected").map(function(){return $j(this).attr("data-phone-number-id")}).get();this.container.find("#numbers_selected").val(a.join())}};Zendesk.NS("Voice");Zendesk.Voice.AudioPlayer={init:function(a){this.setupAudioPlayers(a)},setupAudioPlayers:function(a){$j(a).find(".audio:enabled").each(function(f,d){var c=$j(d);if(!c.attr("data-audio-id")){var b=_.uniqueId("audio_");c.attr("data-audio-id",b);var e=new Player.Audio({domId:b,url:c.attr("data-audio-src"),swfUrl:"/media/voice/soundmanager",stream:true});e.ready(function(g){c.click(function(){if(c.hasClass("playing")){if(!c.hasClass("small")){c.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"))}c.removeClass("playing buffering");g.pause()}else{if(!c.hasClass("small")){c.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.pause"))}c.addClass("playing");var h=c.attr("data-audio-src");if(e.url!==h){g=window.soundManager.createSound({id:h,url:h,stream:true});e.url=h}g.play({onbufferchange:function(){if(g.isBuffering){setTimeout(function(){if(g.isBuffering){c.addClass("buffering")}},300)}else{c.removeClass("buffering")}},onfinish:function(){if(!c.hasClass("small")){c.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"))}c.removeClass("playing")}})}})})}})}};Zendesk.NS("Voice");Zendesk.Voice.AudioRecorder={init:function(a){var b=this;this.greetingID=$j(a).data("greeting-id");$j(a).click(function(c){b.updateColorbox("#custom_greeting_form_main_page");$j("#custom_greeting_form #record_custom_greeting_button").click(function(d){b.showCustomGreetingFormRecordPage();if(d){d.preventDefault()}});$j("#voice_custom_greeting_form #greeting_upload").change(function(){$j("#voice_custom_greeting_form").submit()});$j.colorbox({inline:true,href:"#custom_greeting_form",scrolling:false})})},showCustomGreetingFormRecordPage:function(){var a=this;this.updateColorbox("#custom_greeting_form_record_page");$j("#custom_greeting_form #call_phone_number").focus();$j("#custom_greeting_form #call_phone_number_button").click(function(b){a.startRecordingFlow();if(b){b.preventDefault()}})},startRecordingFlow:function(){var b=this;var a=$j("#custom_greeting_form #call_phone_number").val();if(!b.validatePhoneNumber(a)){return}$j.ajax({url:"/voice/calls/greetings/call_number",type:"post",data:{greeting_id:this.greetingID,call_phone_number:a,authenticity_token:Zendesk.currentUser.authenticityToken},success:function(){var c=I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.calling_you_at",{number:a});$j("#custom_greeting_form").html($j.mustache($j("#custom_greeting_form_record_wait_page").html(),{message:c}));RadarClient.alloc("voice_recordings",function(){RadarClient.status("call_recording/"+Zendesk.currentAccount.subdomain).once(b.recordingUpdateHandler.bind(b)).subscribe()})},error:function(){b.showInvalidPhoneNumberError(a)},complete:function(){_.defer($j.colorbox.resize)}})},validatePhoneNumber:function(a){a=$j.trim(a);if(a.match(/^(\s*|\++)$/)){this.showEmptyPhoneNumberError()}else{if(!a.match(/\d+/)){this.showInvalidPhoneNumberError(a)}else{return true}}_.defer($j.colorbox.resize);return false},showEmptyPhoneNumberError:function(){$j("#custom_greeting_call_status").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.empty_phone_number_error"))},showInvalidPhoneNumberError:function(a){$j("#custom_greeting_call_status").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.phone_number_error",{number:a}))},recordingUpdateHandler:function(c){var b=this;var a=c.value.status;switch(a){case"complete":$j("#custom_greeting_form #record_wait_message").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.updated_successfully"));_.defer($j.colorbox.resize);_.delay(b.reloadPage,2000);break;case"incomplete":$j("#custom_greeting_form #record_wait_message").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.couldnt_complete_recording"));_.defer($j.colorbox.resize);_.delay($j.colorbox.close,2000);break}},updateColorbox:function(a,b){$j("#custom_greeting_form").html($j(a).html(),b);$j.colorbox.resize()},reloadPage:function(){window.location.reload(true)}};(function($){var msOldDiv="";var dd=function(element,options){var sElement=element;var $this=this;var options=$.extend({height:120,visibleRows:7,rowHeight:23,showIcon:true,zIndex:9999,mainCSS:"dd",useSprite:false,animStyle:"slideDown",onInit:"",style:""},options);this.ddProp=new Object;var oldSelectedValue="";var actionSettings={};actionSettings.insideWindow=true;actionSettings.keyboardAction=false;actionSettings.currentKey=null;var ddList=false;var config={postElementHolder:"_msddHolder",postID:"_msdd",postTitleID:"_title",postTitleTextID:"_titletext",postChildID:"_child",postAID:"_msa",postOPTAID:"_msopta",postInputID:"_msinput",postArrowID:"_arrow",postInputhidden:"_inp"};var styles={dd:options.mainCSS,ddTitle:"ddTitle",arrow:"arrow",ddChild:"ddChild",ddTitleText:"ddTitleText",disabled:0.3,ddOutOfVision:"ddOutOfVision",borderTop:"borderTop",noBorderTop:"noBorderTop",selected:"selected"};var attributes={actions:"focus,blur,change,click,dblclick,mousedown,mouseup,mouseover,mousemove,mouseout,keypress,keydown,keyup",prop:"size,multiple,disabled,tabindex"};this.onActions=new Object;var elementid=$(sElement).prop("id");if(typeof elementid=="undefined"||elementid.length<=0){elementid="msdrpdd"+$.msDropDown.counter++;$(sElement).attr("id",elementid)}var inlineCSS=$(sElement).prop("style");options.style+=inlineCSS==undefined?"":inlineCSS;var allOptions=$(sElement).children();ddList=$(sElement).prop("size")>1||$(sElement).prop("multiple")==true?true:false;if(ddList){options.visibleRows=$(sElement).prop("size")}var a_array={};var currentP=0;var isFilter=false;var oldHeight;var cacheElement={};var getElement=function(a){if(typeof cacheElement[a]=="undefined"){cacheElement[a]=document.getElementById(a)}return cacheElement[a]};var getPostID=function(a){return elementid+config[a]};var getOptionsProperties=function(a){var b=a;var c=$(b).prop("style");return c};var matchIndex=function(a){var b=$("#"+elementid+" option:selected");if(b.length>1){for(var c=0;c<b.length;c++){if(a==b[c].index){return true}}}else{if(b.length==1){if(b[0].index==a){return true}}}return false};var createA=function(a,b,c,d){var e="";var f=d=="opt"?getPostID("postOPTAID"):getPostID("postAID");var g=d=="opt"?f+"_"+b+"_"+c:f+"_"+b;var h="";var i="";if(options.useSprite!=false){i=" "+options.useSprite+" "+a.className}else{h=$(a).prop("title");h=h.length==0?"":'<img src="'+h+'" align="absmiddle" /> '}var j=$(a).text();var k=$(a).val();var l=$(a).prop("disabled")==true?"disabled":"enabled";a_array[g]={html:h+j,value:k,text:j,index:a.index,id:g};var m=getOptionsProperties(a);if(matchIndex(a.index)==true){e+='<a href="javascript:void(0);" class="'+styles.selected+" "+l+i+'"'}else{e+='<a  href="javascript:void(0);" class="'+l+i+'"'}if(m!==false&&m!==undefined){e+=" style='"+m+"'"}e+=' id="'+g+'">';e+=h+'<span class="'+styles.ddTitleText+'">'+j+"</span></a>";return e};var in_array=function(a){var b=a.toLowerCase();if(b.length==0){return -1}var c="";for(var d in a_array){var e=a_array[d].text.toLowerCase();if(e.substr(0,b.length)==b){c+="#"+a_array[d].id+", "}}return c==""?-1:c};var createATags=function(){var a=allOptions;if(a.length==0){return""}var b="";var c=getPostID("postAID");var d=getPostID("postOPTAID");a.each(function(c){var d=a[c];if(d.nodeName=="OPTGROUP"){b+="<div class='opta'>";b+="<span style='font-weight:bold;font-style:italic; clear:both;'>"+$(d).prop("label")+"</span>";var e=$(d).children();e.each(function(a){var d=e[a];b+=createA(d,c,a,"opt")});b+="</div>"}else{b+=createA(d,c,"","")}});return b};var createChildDiv=function(){var a=getPostID("postID");var b=getPostID("postChildID");var c=options.style;sDiv="";sDiv+='<div id="'+b+'" class="'+styles.ddChild+'"';if(!ddList){sDiv+=c!=""?' style="'+c+'"':""}else{sDiv+=c!=""?' style="border-top:1px solid #c3c3c3;display:block;position:relative;'+c+'"':""}sDiv+=">";return sDiv};var createTitleDiv=function(){var a=getPostID("postTitleID");var b=getPostID("postArrowID");var c=getPostID("postTitleTextID");var d=getPostID("postInputhidden");var e="";var f="";if(getElement(elementid).options.length>0){e=$("#"+elementid+" option:selected").text();f=$("#"+elementid+" option:selected").prop("title")}f=f.length==0||f==undefined||options.showIcon==false||options.useSprite!=false?"":'<img src="'+f+'" align="absmiddle" /> ';var g='<div id="'+a+'" class="'+styles.ddTitle+'"';g+=">";g+='<span id="'+b+'" class="'+styles.arrow+'"></span><span class="'+styles.ddTitleText+'" id="'+c+'">'+f+'<span class="'+styles.ddTitleText+'">'+e+"</span></span></div>";return g};var applyEventsOnA=function(){var a=getPostID("postChildID");$("#"+a+" a.enabled").unbind("click");$("#"+a+" a.enabled").bind("click",function(b){b.preventDefault();manageSelection(this);setValue();if(!ddList){$("#"+a).unbind("mouseover");setInsideWindow(false);var c=options.showIcon==false?$(this).text():$(this).html();setTitleText(c);$this.close()}})};var createDropDown=function(){var a=false;var b=getPostID("postID");var c=getPostID("postTitleID");var d=getPostID("postTitleTextID");var e=getPostID("postChildID");var f=getPostID("postArrowID");var g=$("#"+elementid).outerWidth()+20;g=g+2;var h=options.style;if($("#"+b).length>0){$("#"+b).remove();a=true}var i='<div id="'+b+'" class="'+styles.dd+'"';i+=h!=""?' style="'+h+'"':"";i+=">";i+=createTitleDiv();i+=createChildDiv();i+=createATags();i+="</div>";i+="</div>";if(a==true){var j=getPostID("postElementHolder");$("#"+j).after(i)}else{$("#"+elementid).after(i)}if(ddList){var c=getPostID("postTitleID");$("#"+c).hide()}$("#"+b).css("width",g+"px");$("#"+e).css("width",g-2+"px");if(allOptions.length>options.visibleRows){var k=parseInt($("#"+e+" a:first").css("padding-bottom"))+parseInt($("#"+e+" a:first").css("padding-top"));var l=options.rowHeight*options.visibleRows-k;$("#"+e).css("height",l+"px")}else{if(ddList){var l=$("#"+elementid).height();$("#"+e).css("height",l+"px")}}if(a==false){setOutOfVision();addRefreshMethods(elementid)}if($("#"+elementid).prop("disabled")==true){$("#"+b).css("opacity",styles.disabled)}applyEvents();$("#"+c).bind("mouseover",function(a){hightlightArrow(1)});$("#"+c).bind("mouseout",function(a){hightlightArrow(0)});applyEventsOnA();$("#"+e+" a.disabled").css("opacity",styles.disabled);if(ddList){$("#"+e).bind("mouseover",function(a){if(!actionSettings.keyboardAction){actionSettings.keyboardAction=true;$(document).bind("keydown",function(a){var b=a.keyCode;actionSettings.currentKey=b;if(b==39||b==40){a.preventDefault();a.stopPropagation();next();setValue()}if(b==37||b==38){a.preventDefault();a.stopPropagation();previous();setValue()}})}})}$("#"+e).bind("mouseout",function(a){setInsideWindow(false);$(document).unbind("keydown");actionSettings.keyboardAction=false;actionSettings.currentKey=null});$("#"+c).bind("click",function(a){setInsideWindow(false);if($("#"+e+":visible").length==1){$("#"+e).unbind("mouseover")}else{$("#"+e).bind("mouseover",function(a){setInsideWindow(true)});$this.open()}});$("#"+c).bind("mouseout",function(a){setInsideWindow(false)});if(options.showIcon&&options.useSprite!=false){setTitleImageSprite()}};var getByIndex=function(a){for(var b in a_array){if(a_array[b].index==a){return a_array[b]}}return -1};var manageSelection=function(a){var b=getPostID("postChildID");if($("#"+b+" a."+styles.selected).length==1){oldSelectedValue=$("#"+b+" a."+styles.selected).text()}if(!ddList){$("#"+b+" a."+styles.selected).removeClass(styles.selected)}var c=$("#"+b+" a."+styles.selected).prop("id");if(c!=undefined){var d=actionSettings.oldIndex==undefined||actionSettings.oldIndex==null?a_array[c].index:actionSettings.oldIndex}if(a&&!ddList){$(a).addClass(styles.selected)}if(ddList){var e=actionSettings.currentKey;if($("#"+elementid).prop("multiple")==true){if(e==17){actionSettings.oldIndex=a_array[$(a).prop("id")].index;$(a).toggleClass(styles.selected)}else{if(e==16){$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);var f=$(a).prop("id");var g=a_array[f].index;for(var h=Math.min(d,g);h<=Math.max(d,g);h++){$("#"+getByIndex(h).id).addClass(styles.selected)}}else{$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);actionSettings.oldIndex=a_array[$(a).prop("id")].index}}}else{$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);actionSettings.oldIndex=a_array[$(a).prop("id")].index}}};var addRefreshMethods=function(a){var b=a;getElement(b).refresh=function(a){$("#"+b).msDropDown(options)}};var setInsideWindow=function(a){actionSettings.insideWindow=a};var getInsideWindow=function(){return actionSettings.insideWindow};var applyEvents=function(){var a=getPostID("postID");var b=attributes.actions.split(",");for(var c=0;c<b.length;c++){var d=b[c];var e=has_handler(d);if(e==true){switch(d){case"focus":$("#"+a).bind("mouseenter",function(a){getElement(elementid).focus()});break;case"click":$("#"+a).bind("click",function(a){$("#"+elementid).trigger("click")});break;case"dblclick":$("#"+a).bind("dblclick",function(a){$("#"+elementid).trigger("dblclick")});break;case"mousedown":$("#"+a).bind("mousedown",function(a){$("#"+elementid).trigger("mousedown")});break;case"mouseup":$("#"+a).bind("mouseup",function(a){$("#"+elementid).trigger("mouseup")});break;case"mouseover":$("#"+a).bind("mouseover",function(a){$("#"+elementid).trigger("mouseover")});break;case"mousemove":$("#"+a).bind("mousemove",function(a){$("#"+elementid).trigger("mousemove")});break;case"mouseout":$("#"+a).bind("mouseout",function(a){$("#"+elementid).trigger("mouseout")});break}}}};var setOutOfVision=function(){var a=getPostID("postElementHolder");$("#"+elementid).after("<div class='"+styles.ddOutOfVision+"' style='height:0px;overflow:hidden;position:absolute;' id='"+a+"'></div>");$("#"+elementid).appendTo($("#"+a))};var setTitleText=function(a){var b=getPostID("postTitleTextID");$("#"+b).html(a)};var navigateA=function(a){var b=a;var c=getPostID("postChildID");var d=$("#"+c+" a:visible");var e=d.length;var f=$("#"+c+" a:visible").index($("#"+c+" a.selected:visible"));var g;switch(b){case"next":if(f<e-1){f++;g=d[f]}break;case"previous":if(f<e&&f>0){f--;g=d[f]}break}if(typeof g=="undefined"){return false}$("#"+c+" a."+styles.selected).removeClass(styles.selected);$(g).addClass(styles.selected);var h=g.id;if(!ddList){var i=options.showIcon==false?a_array[h].text:$("#"+h).html();setTitleText(i);setTitleImageSprite(a_array[h].index)}if(b=="next"){if(parseInt($("#"+h).position().top+$("#"+h).height())>=parseInt($("#"+c).height())){$("#"+c).scrollTop($("#"+c).scrollTop()+$("#"+h).height()+$("#"+h).height())}}else{if(parseInt($("#"+h).position().top+$("#"+h).height())<=0){$("#"+c).scrollTop($("#"+c).scrollTop()-$("#"+c).height()-$("#"+h).height())}}};var next=function(){navigateA("next")};var previous=function(){navigateA("previous")};var setTitleImageSprite=function(a){if(options.useSprite!=false){var b=getPostID("postTitleTextID");var c=typeof a=="undefined"?getElement(elementid).selectedIndex:a;var d=getElement(elementid).options[c].className;if(d.length>0){var e=getPostID("postChildID");var f=$("#"+e+" a."+d).prop("id");var g=$("#"+f).css("background-image");var h=$("#"+f).css("background-position");var i=$("#"+f).css("padding-left");if(g!=undefined){$("#"+b).find("."+styles.ddTitleText).attr("style","background:"+g)}if(h!=undefined){$("#"+b).find("."+styles.ddTitleText).css("background-position",h)}if(i!=undefined){$("#"+b).find("."+styles.ddTitleText).css("padding-left",i)}$("#"+b).find("."+styles.ddTitleText).css("background-repeat","no-repeat");$("#"+b).find("."+styles.ddTitleText).css("padding-bottom","2px")}}};var setValue=function(){var a=getPostID("postChildID");var b=$("#"+a+" a."+styles.selected);if(b.length==1){var c=$("#"+a+" a."+styles.selected).text();var d=$("#"+a+" a."+styles.selected).prop("id");if(d!=undefined){var e=a_array[d].value;getElement(elementid).selectedIndex=a_array[d].index}if(options.showIcon&&options.useSprite!=false){setTitleImageSprite()}}else{if(b.length>1){for(var f=0;f<b.length;f++){var d=$(b[f]).prop("id");var g=a_array[d].index;getElement(elementid).options[g].selected="selected"}}}var h=getElement(elementid).selectedIndex;$this.ddProp.selectedIndex=h};var has_handler=function(a){if($("#"+elementid).prop("on"+a)!=undefined){return true}var b=$("#"+elementid).data("events");if(b&&b[a]){return true}return false};var checkMethodAndApply=function(){var a=getPostID("postChildID");if(has_handler("change")==true){var b=a_array[$("#"+a+" a.selected").prop("id")].text;if($.trim(oldSelectedValue)!==$.trim(b)&&oldSelectedValue!==""){$("#"+elementid).trigger("change")}}if(has_handler("mouseup")==true){$("#"+elementid).trigger("mouseup")}if(has_handler("blur")==true){$(document).bind("mouseup",function(a){$("#"+elementid).focus();$("#"+elementid)[0].blur();setValue();$(document).unbind("mouseup")})}};var hightlightArrow=function(a){var b=getPostID("postArrowID");if(a==1){$("#"+b).css({backgroundPosition:"0 100%"})}else{$("#"+b).css({backgroundPosition:"0 0"})}};var setOriginalProperties=function(){for(var a in getElement(elementid)){if(typeof getElement(elementid)[a]!="function"&&getElement(elementid)[a]!==undefined&&getElement(elementid)[a]!==null){$this.set(a,getElement(elementid)[a],true)}}};var setValueByIndex=function(a,b){if(getByIndex(b)!=-1){getElement(elementid)[a]=b;var c=getPostID("postChildID");$("#"+c+" a."+styles.selected).removeClass(styles.selected);$("#"+getByIndex(b).id).addClass(styles.selected);var d=getByIndex(getElement(elementid).selectedIndex).html;setTitleText(d)}};var addRemoveFromIndex=function(a,b){if(b=="d"){for(var c in a_array){if(a_array[c].index==a){delete a_array[c];break}}}var d=0;for(var c in a_array){a_array[c].index=d;d++}};var shouldOpenOpposite=function(){var a=getPostID("postChildID");var b=getPostID("postID");var c=$("#"+b).position();var d=$("#"+b).height();var e=$(window).height();var f=$(window).scrollTop();var g=$("#"+a).height();var h={zIndex:options.zIndex,top:c.top+d+"px",display:"none"};var i=options.animStyle;var j=false;var k=styles.noBorderTop;$("#"+a).removeClass(styles.noBorderTop);$("#"+a).removeClass(styles.borderTop);if(e+f<Math.floor(g+d+c.top)){var l=c.top-g;if(c.top-g<0){l=10}h={zIndex:options.zIndex,top:l+"px",display:"none"};i="show";j=true;k=styles.borderTop}return{opp:j,ani:i,css:h,border:k}};var fireOpenEvent=function(){if($this.onActions.onOpen!=null){eval($this.onActions.onOpen)($this)}};var fireCloseEvent=function(){checkMethodAndApply();if($this.onActions.onClose!=null){eval($this.onActions.onClose)($this)}};this.open=function(){if($this.get("disabled",true)==true||$this.get("options",true).length==0){return}var a=getPostID("postChildID");if(msOldDiv!=""&&a!=msOldDiv){$("#"+msOldDiv).slideUp("fast");$("#"+msOldDiv).css({zIndex:"0"})}if($("#"+a).css("display")=="none"){oldSelectedValue=a_array[$("#"+a+" a.selected").prop("id")].text;var b="";oldHeight=$("#"+a).height();$("#"+a+" a").show();$(document).bind("keydown",function(c){var d=c.keyCode;if(d==8){c.preventDefault();c.stopPropagation();b=b.length==0?"":b.substr(0,b.length-1)}switch(d){case 39:case 40:c.preventDefault();c.stopPropagation();next();break;case 37:case 38:c.preventDefault();c.stopPropagation();previous();break;case 27:case 13:$this.close();setValue();break;default:if(d>46){b+=String.fromCharCode(d)}var e=in_array(b);if(e!=-1){$("#"+a).css({height:"auto"});$("#"+a+" a").hide();$(e).show();var f=shouldOpenOpposite();$("#"+a).css(f.css);$("#"+a).css({display:"block"})}else{$("#"+a+" a").show();$("#"+a).css({height:oldHeight+"px"})}break}if(has_handler("keydown")==true){getElement(elementid).onkeydown()}});$(document).bind("keyup",function(a){if($("#"+elementid).prop("onkeyup")!=undefined){getElement(elementid).onkeyup()}});$(document).bind("mouseup",function(a){if(getInsideWindow()==false){$this.close()}});var c=shouldOpenOpposite();$("#"+a).css(c.css);if(c.opp==true){$("#"+a).css({display:"block"});$("#"+a).addClass(c.border);fireOpenEvent()}else{$("#"+a)[c.ani]("fast",function(){$("#"+a).addClass(c.border);fireOpenEvent()})}if(a!=msOldDiv){msOldDiv=a}}};this.close=function(){var a=getPostID("postChildID");var b=$("#"+getPostID("postTitleID")).position().top;var c=shouldOpenOpposite();isFilter=false;if(c.opp==true){$("#"+a).animate({height:0,top:b},function(){$("#"+a).css({height:oldHeight+"px",display:"none"});fireCloseEvent()})}else{$("#"+a).slideUp("fast",function(b){fireCloseEvent();$("#"+a).css({zIndex:"0"});$("#"+a).css({height:oldHeight+"px"})})}setTitleImageSprite();$(document).unbind("keydown");$(document).unbind("keyup");$(document).unbind("mouseup")};this.selectedIndex=function(a){if(typeof a=="undefined"){return $this.get("selectedIndex")}else{$this.set("selectedIndex",a)}};this.debug=function(a){if(typeof a=="undefined"||a==true){$("."+styles.ddOutOfVision).removeAttr("style")}else{$("."+styles.ddOutOfVision).attr("style","height:0px;overflow:hidden;position:absolute")}};this.set=function(a,b,c){if(a==undefined||b==undefined){throw {message:"set to what?"}}$this.ddProp[a]=b;if(c!=true){switch(a){case"selectedIndex":setValueByIndex(a,b);break;case"disabled":$this.disabled(b,true);break;case"multiple":getElement(elementid)[a]=b;ddList=$(sElement).prop("size")>0||$(sElement).prop("multiple")==true?true:false;if(ddList){var d=$("#"+elementid).height();var e=getPostID("postChildID");$("#"+e).css("height",d+"px");var f=getPostID("postTitleID");$("#"+f).hide();var e=getPostID("postChildID");$("#"+e).css({display:"block",position:"relative"});applyEventsOnA()}break;case"size":getElement(elementid)[a]=b;if(b==0){getElement(elementid).multiple=false}ddList=$(sElement).prop("size")>0||$(sElement).prop("multiple")==true?true:false;if(b==0){var f=getPostID("postTitleID");$("#"+f).show();var e=getPostID("postChildID");$("#"+e).css({display:"none",position:"absolute"});var g="";if(getElement(elementid).selectedIndex>=0){var h=getByIndex(getElement(elementid).selectedIndex);g=h.html;manageSelection($("#"+h.id))}setTitleText(g)}else{var f=getPostID("postTitleID");$("#"+f).hide();var e=getPostID("postChildID");$("#"+e).css({display:"block",position:"relative"})}break;default:try{getElement(elementid)[a]=b}catch(i){}break}}};this.get=function(a,b){if(a==undefined&&b==undefined){return $this.ddProp}if(a!=undefined&&b==undefined){return $this.ddProp[a]!=undefined?$this.ddProp[a]:null}if(a!=undefined&&b!=undefined){return getElement(elementid)[a]}};this.visible=function(a){var b=getPostID("postID");if(a==true){$("#"+b).show()}else{if(a==false){$("#"+b).hide()}else{return $("#"+b).css("display")}}};this.add=function(a,b){var c=a;var d=c.text;var e=c.value==undefined||c.value==null?d:c.value;var f=c.title==undefined||c.title==null?"":c.title;var g=b==undefined||b==null?getElement(elementid).options.length:b;getElement(elementid).options[g]=new Option(d,e);if(f!=""){getElement(elementid).options[g]["title"]=f}var h=getByIndex(g);if(h!=-1){var i=createA(getElement(elementid).options[g],g,"","");$("#"+h.id).html(i)}else{var i=createA(getElement(elementid).options[g],g,"","");var j=getPostID("postChildID");$("#"+j).append(i);applyEventsOnA()}};this.remove=function(a){getElement(elementid).remove(a);if(getByIndex(a)!=-1){$("#"+getByIndex(a).id).remove();addRemoveFromIndex(a,"d")}if(getElement(elementid).length==0){setTitleText("")}else{var b=getByIndex(getElement(elementid).selectedIndex).html;setTitleText(b)}$this.set("selectedIndex",getElement(elementid).selectedIndex)};this.disabled=function(a,b){getElement(elementid).disabled=a;var c=getPostID("postID");if(a==true){$("#"+c).css("opacity",styles.disabled);$this.close()}else{if(a==false){$("#"+c).css("opacity",1)}}if(b!=true){$this.set("disabled",a)}};this.form=function(){return getElement(elementid).form==undefined?null:getElement(elementid).form};this.item=function(){if(arguments.length==1){return getElement(elementid).item(arguments[0])}else{if(arguments.length==2){return getElement(elementid).item(arguments[0],arguments[1])}else{throw {message:"An index is required!"}}}};this.namedItem=function(a){return getElement(elementid).namedItem(a)};this.multiple=function(a){if(typeof a=="undefined"){return $this.get("multiple")}else{$this.set("multiple",a)}};this.size=function(a){if(typeof a=="undefined"){return $this.get("size")}else{$this.set("size",a)}};this.addMyEvent=function(a,b){$this.onActions[a]=b};this.fireEvent=function(nm){eval($this.onActions[nm])($this)};var updateCommonVars=function(){$this.set("version",$.msDropDown.version);$this.set("author",$.msDropDown.author)};var init=function(){createDropDown();setOriginalProperties();updateCommonVars();if(options.onInit!=""){eval(options.onInit)($this)}};init()};$.msDropDown={version:2.37,author:"Marghoob Suleman",counter:20,create:function(a,b){return $(a).msDropDown(b).data("dd")}};$.fn.extend({msDropDown:function(a){return this.each(function(){var b=new dd(this,a);$(this).data("dd",b)})}});if(typeof $.fn.prop=="undefined"){$.fn.prop=function(a){return $(this).attr(a)}}})(jQuery);Zendesk.NS("Voice");Zendesk.Voice.AssociatePhoneNumberGroups={init:function(a){this.container=$j(a);this.setup()},setup:function(){this.attachGroupClickHandlers();this.attachDropdownChangeHandlers();this.attachSubmitHandlers()},attachGroupClickHandlers:function(){var a=this;this.container.find(".std_tile").click(function(){a.toggleGroupSelected($j(this));a.updateSelectedGroups($j(this))})},attachDropdownChangeHandlers:function(){var a=this;this.container.find("#default_group_id").change(function(){a.setIntendedGroupDefault($j(this));a.validateDefaultGroupsDropdown()})},attachSubmitHandlers:function(){var a=this;var b=this.container.closest("form");b.submit(function(c){if(!a.validateDefaultGroupsDropdown()){c.preventDefault()}})},validateDefaultGroupsDropdown:function(){if(this.container.find("#default_group_id option:selected").val()===""){this.showValidationMessage();return false}else{this.hideValidationMessage();return true}},showValidationMessage:function(){this.container.find("#default_group_id").addClass("error");this.container.find("#groups_validation_msg").addClass("error").show()},hideValidationMessage:function(){this.container.find("#default_group_id").removeClass("error");this.container.find("#groups_validation_msg").removeClass("error").hide()},setIntendedGroupDefault:function(a){this.container.find(".std_tile").attr("data-intended-default-group","false");this.container.find("#group_"+a.val()).attr("data-intended-default-group","true")},toggleGroupSelected:function(a){a.toggleClass("selected");if(a.hasClass("selected")){this.markAsNotIntendedDefault(a)}this.toggleDropdownDisplay();this.createDefaultDropdown()},markAsNotIntendedDefault:function(a){a.attr("data-intended-default-group","false")},toggleDropdownDisplay:function(){var a=this.getSelectedGroups();if(a.length<2){this.container.find("#group_routing_default").slideUp()}else{this.container.find("#group_routing_default").slideDown()}},updateSelectedGroups:function(){var a=this.getSelectedGroupIDs();this.container.find("#groups_selected").val(a.join())},getDefaultGroupID:function(){var a=this.container.find(".std_tile.selected[data-intended-default-group=true]");if(!a.length){a=this.container.find(".std_tile.selected[data-default-group=true]")}if(a.length){return a.attr("data-group-id")}return null},createDefaultDropdown:function(){var b=this.getSelectedGroups();var c=this.getDefaultGroupID();var a=this.container.find("#default_group_id");a.children().remove();b.each($j.proxy(function(f){var e=$j("<option />").attr({value:f.id}).html(f.name);if(f.id==c){e.attr({selected:"selected"})}e.appendTo(a)},this));if(!c&&b.length>1){var d=$j("<option />").attr({value:"",selected:"selected"}).html("");d.appendTo(a)}},getSelectedGroups:function(){var a=this.container.find(".std_tile.selected").map(function(){var b={id:$j(this).attr("data-group-id"),name:$j(this).attr("title"),isDefault:$j(this).attr("data-default-group"),intendedDefault:$j(this).attr("data-intended-default-group")};return b}).get();return a},getSelectedGroupIDs:function(){var b=this.getSelectedGroups();var a=b.map(function(c){return c.id});return a}};Zendesk.NS("Voice");Zendesk.Voice.PhoneNumberEditor={init:function(a){Zendesk.Voice.AudioPlayer.init(a);this.setupGreetingsDropdowns(a)},setupGreetingsDropdowns:function(a){$j(a).find("select.greeting").each(function(c,d){var b=$j(d);b.change(function(){var e=b.find(":selected").attr("data-audio-src");var g=b.parent().find(".audio");g.attr("data-audio-src",e);var f=!!e;g.attr("disabled",!f);Zendesk.Voice.AudioPlayer.init(a)})})}};Zendesk.NS("Voice");(function(b,a){b(".call-history-container a.sortable, .call-history-container .pagination a").live("click",function(){b.getScript(this.href);return false});b("#call_history a.more").live("click",function(){var c=b(this).attr("data-call-id");b("#call_history .breakdown[data-call-id="+c+"]").toggle();b(this).toggleClass("expanded");if(b(this).hasClass("expanded")){b(this).html(I18n.t("txt.views.voice.settings._call_settings.less_label"))}else{b(this).html(I18n.t("txt.views.voice.settings._call_settings.more_label"))}});a.Voice.History={filter:function(){b.ajax({url:"/voice/settings/call_history_list?period="+b("#call_billing_period").val(),type:"GET",dataType:"script",beforeSend:function(){b("#call_history .loading-placeholder").addClass("loading")}})}}}(jQuery,Zendesk));Zendesk.NS("Voice");Zendesk.Voice.GreetingsPicker=function(a){this.formContainer=$j(a)};Zendesk.Voice.GreetingsPicker.prototype={init:function(){this.availableContainer=this.formContainer.find("#wait_greeting_audio");this.voicemailContainer=this.formContainer.find("#voicemail_greeting_audio");this.waitContainer=this.formContainer.find("#hold_greeting_audio");this.bindAddGreetingLink();_(["available","voicemail","wait"]).each(function(a){this.setupAudioPlayer(a);this.bindGreetingsSelect(a)},this)},containerForKind:function(a){switch(a){case"available":return this.availableContainer;case"voicemail":return this.voicemailContainer;case"wait":return this.waitContainer}},bindAddGreetingLink:function(){var a=this;$j("#add_greeting").click(function(b){$j("#custom_greeting_form").html($j("#new_greeting_modal_form").html());$j.colorbox.resize();$j("#create_greeting_button").click(function(f){var d=$j("#greeting_name");var c=$j.trim(d.val());d.val(c);d.focus();if(c.length===0){if(f){f.preventDefault()}}});$j.colorbox({inline:true,href:"#custom_greeting_form",scrolling:false});if(b){b.preventDefault()}})},setupAudioPlayer:function(b){var a=this.containerForKind(b);this.setupAudioPlayerForContainer(a)},setupAudioPlayerForContainer:function(a){a.find(".audio").each(function(f,c){c=$j(c);var b=c.attr("data-audio-id");var e=c.attr("data-audio-src");var d=new Player.Audio({domId:b,url:e,swfUrl:"/media/voice/soundmanager",stream:true});d.ready(function(g){c.click(function(){if(c.hasClass("playing")){c.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"));c.removeClass("playing buffering");g.pause()}else{c.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.pause"));c.addClass("playing");g.play({onbufferchange:function(){if(g.isBuffering){setTimeout(function(){if(g.isBuffering){c.addClass("buffering")}},300)}else{c.removeClass("buffering")}},onfinish:function(){c.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"));c.removeClass("playing")}})}})})})},bindGreetingsSelect:function(c){var a=this.containerForKind(c);var b=this;a.find(".greeting_options").change(function(g){var d=this;var f=$j(this).val();if(f==="default"){b.resetGreeting(c)}else{if(f==="default_jp"){b.japaneseGreeting(c)}else{if(f==="new_custom"){b.showCustomGreetingFormMainPage(c)}else{if(f==="none"){b.emptyGreeting(c)}}}}if(g){g.preventDefault()}})},showCustomGreetingFormMainPage:function(d){var a=this.containerForKind(d);var c=a.find(".greeting_options");if(d==="wait"){$j("#custom_greeting_form").html($j("#custom_greeting_form_upload_page").html())}else{$j("#custom_greeting_form").html($j("#custom_greeting_form_main_page").html())}$j("#custom_greeting_form #greeting_upload").attr("name",d);$j("#custom_greeting_form h2.title").hide();switch(d){case"available":$j("#custom_greeting_available_agents_title").show();break;case"voicemail":$j("#custom_greeting_voicemail_title").show();break}$j.colorbox.resize();var b=this;$j("#voice_custom_greeting_form #record_custom_greeting_button").click(function(f){b.showCustomGreetingFormRecordPage(d);if(f){f.preventDefault()}});$j("#voice_custom_greeting_form #greeting_upload").change(this.submitCustomGreetingForm);$j.colorbox({inline:true,href:"#custom_greeting_form",scrolling:false,onClosed:function(){$j(c).val($j(c).attr("data-audio-type"))},onComplete:function(){var f=$j("#greeting_upload");var e=$j("#upload_custom_greeting_button");f.mouseover(function(){e.addClass("hover")});f.mouseout(function(){e.removeClass("hover")});f.mousedown(function(){e.addClass("active")});f.mouseup(function(){e.removeClass("active")})}})},showCustomGreetingFormRecordPage:function(b){var a=this;$j("#custom_greeting_form").html($j("#custom_greeting_form_record_page").html());$j("#voice_custom_greeting_form h2.title").hide();switch(b){case"available":$j("#custom_greeting_available_agents_title").show();break;case"voicemail":$j("#custom_greeting_voicemail_title").show();break}$j.colorbox.resize();$j("#custom_greeting_form #call_phone_number").focus();$j("#custom_greeting_form #call_phone_number_button").click(function(c){a.startRecordingFlow(b);if(c){c.preventDefault()}})},startRecordingFlow:function(b){var a=this;this.callingNumber=$j("#custom_greeting_form #call_phone_number").val();this.recordingKind=b;if(!a.validatePhoneNumber(a.callingNumber)){return}$j.ajax({url:"/voice/calls/greetings/call_number",type:"post",data:{call_phone_number:this.callingNumber,kind:b,authenticity_token:Zendesk.currentUser.authenticityToken},success:function(){var c=I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.calling_you_at",{number:a.callingNumber});$j("#custom_greeting_form").html($j.mustache($j("#custom_greeting_form_record_wait_page").html(),{message:c}));$j("#custom_greeting_form h2.title").hide();switch(b){case"available":$j("#custom_greeting_available_agents_title").show();break;case"voicemail":$j("#custom_greeting_voicemail_title").show();break}RadarClient.alloc("voice_recordings",function(){RadarClient.status("call_recording/"+Zendesk.currentAccount.subdomain).once(a.recordingUpdateHandler.bind(a)).subscribe()})},error:function(){a.showInvalidPhoneNumberError(a.callingNumber)},complete:function(){_.defer($j.colorbox.resize)}})},validatePhoneNumber:function(a){a=$j.trim(a);if(a.match(/^(\s*|\++)$/)){this.showEmptyPhoneNumberError()}else{if(!a.match(/\d+/)){this.showInvalidPhoneNumberError(a)}else{return true}}_.defer($j.colorbox.resize);return false},showEmptyPhoneNumberError:function(){$j("#custom_greeting_call_status").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.empty_phone_number_error"))},showInvalidPhoneNumberError:function(a){$j("#custom_greeting_call_status").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.phone_number_error",{number:a}))},recordingUpdateHandler:function(b){var a=b.value.status;switch(a){case"complete":this.reloadGreeting(this.recordingKind,function(){$j.colorbox.close();window.location.reload(true)});break;case"incomplete":$j("#custom_greeting_form #record_wait_message").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.couldnt_complete_recording"));_.defer($j.colorbox.resize);_.delay($j.colorbox.close,2000);break}},reloadGreeting:function(b,c){var a=this;$j.ajax({url:"/voice/settings/greeting",type:"get",data:{kind:b},success:function(d){a.renderGreeting(b,d);if(_.isFunction(c)){c()}},error:function(){alert("Error fetching greeting");if(_.isFunction(c)){c()}}})},resetGreeting:function(d){var a=this.containerForKind(d);var c=a.find(".greeting_options");if(!confirm(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.this_will_reset"))){$j(c).val($j(c).attr("data-audio-type"));return}var b=this;$j.ajax({url:"/voice/settings/reset_greeting",type:"delete",data:{kind:d},success:function(e){b.renderGreeting(d,e)},error:function(){alert(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.error_resetting_greeting"))}})},emptyGreeting:function(d){var a=this.containerForKind(d);var c=a.find(".greeting_options");if(!confirm(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.empty_greeting_confirm"))){$j(c).val($j(c).attr("data-audio-type"));return}var b=this;$j.ajax({url:"/voice/settings",type:"put",data:{kind:d,blank:true},success:function(e){b.renderGreeting(d,e)},error:function(){alert(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.error_updating_greeting"))}})},japaneseGreeting:function(d){var a=this.containerForKind(d);var c=a.find(".greeting_options");if(!confirm(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.this_will_reset"))){$j(c).val($j(c).attr("data-audio-type"));return}var b=this;$j.ajax({url:"/voice/settings",type:"put",data:{kind:d,locale:"jp"},success:function(e){b.renderGreeting(d,e)},error:function(){alert(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.error_updating_greeting"))}})},renderGreeting:function(b,a){$j("#"+b+"_audio").html(a).effect("highlight",{},1000);switch(b){case"available":this.availableContainer=this.formContainer.find("#wait_greeting_audio");break;case"voicemail":this.voicemailContainer=this.formContainer.find("#voicemail_greeting_audio");break;case"wait":this.waitContainer=this.formContainer.find("#hold_greeting_audio");break}this.bindGreetingsSelect(b);this.setupAudioPlayer(b)},submitCustomGreetingForm:function(){$j("#voice_custom_greeting_form").submit()}};Zendesk.NS("Voice");Zendesk.Voice.NumberPicker=function(a){this.elem=a;this.pickedNumber=null};Zendesk.Voice.NumberPicker.prototype={fetchAvailableNumbers:function(){var b=this._getQuery();var a=this;this.elem.find(".area_code_loading_spinner").show();$j.colorbox.resize();$j.get("/voice/phone_numbers/available",{country:b.country,area_code:b.areaCode,contains:b.search,toll_free:b.tollFree},function(d){$j("#pre_results").hide();$j(".area_code_loading_spinner").hide();$j("#number_results").html(d);$j("#available_number_list input:radio:first").prop("checked",true);var c=$j("#number_picker");c.find("#number_info").hide();c.find("#number_form .submit input").val("Search again");c.find("#number_results form").submit(function(g){g.preventDefault();var f=c.find(".number_list input:radio:checked");a.showConfirmation(f.attr("friendly"),f.attr("price"),b);return false});new Zendesk.Pager(c.find("#available_number_list"),c.find(".pagination_links .previous"),c.find(".pagination_links .next")).paginate(function(){$j.colorbox.resize()});_.defer(function(){$j.colorbox.resize()})})},changeAreaCode:function(){var a=$j("#number_picker");var c=a.find("#country").val();var b=Zendesk.Voice.NumberResources;if(b[c].area_code){a.find("#number_field_instructions").html(I18n.t("txt.admin.views.voice.phone_numbers._area_code_search_form.Search_by_area_code_digits"));a.find("#area_code_field, .area_code_parens").show()}else{a.find("#number_field_instructions").html(I18n.t("txt.admin.views.voice.phone_numbers._area_code_search_form.Search_by_digits"));a.find("#area_code_field, .area_code_parens").hide()}a.find("#country_code .code").html("+"+b[c].code);this._setPrefix(c,a,b);$j.colorbox.resize()},_setPrefix:function(d,b,c){b.find("#fixed_prefix").html("");b.find("#toll_free_dropdown").hide();if(c[d].toll_free){b.find("#local_picker").show();var a=b.find("#local").val()==="true";if(a){this._setTollFreePrefix(d,b);this._lastAreaCode=b.find("#area_code").val()}else{b.find("#area_code").val(this._lastAreaCode||"");if(d=="GB"){b.find("#area_code").attr("maxlength",4)}else{b.find("#area_code").attr("maxlength",3)}}}else{b.find("#local_picker").hide();this._setCountryPrefix(d,b,c)}},_setTollFreePrefix:function(b,a){a.find("#area_code_field").hide();if(b=="US"||b=="CA"){a.find(".area_code_parens").show();a.find("#toll_free_dropdown").show();a.find("#toll_prefix").msDropDown();a.find("#toll_prefix_msdd").width("48px")}else{if(b=="GB"){a.find("#area_code_field, .area_code_parens").hide();a.find("#fixed_prefix").html("800");a.find("#area_code").val("")}}},_setCountryPrefix:function(d,a,c){var b=c[d].prefix;if(!b||(currentAccount.hasFeature("voiceInternational")&&c[d].certification)){b=""}a.find("#fixed_prefix").html(b)},_getQuery:function(){var c=Zendesk.Voice.NumberResources;var d=$j("#number_picker");var b=d.find("#country").val();var f=d.find("#area_code").val();var j=d.find("#number").val();var e=c[b].code;var a=d.find("#local").val()==="true";if(!c[b].toll_free||a==null){a=false}if(b=="US"||b=="CA"){if(a){f=d.find("#toll_prefix").val();d.find("#area_code").val(f);if(f=="Any"){f=""}}}if(!currentAccount.hasFeature("voiceInternational")){var k=d.find("#fixed_prefix").text();if(b!="FR"){j=k+j}}var g=this._searchByPrefix(f,b,c);var h=(j!=="");return{country:b,areaCode:f,search:j,countryCode:e,tollFree:a,searchByPrefix:g,customSearch:h}},_searchByPrefix:function(a,c,b){if(a===""){return false}return b[c].area_code},showConfirmation:function(d,g,h){var k=this;var j=Zendesk.Voice.NumberResources[h.country];if(currentAccount.hasFeature("voiceInternational")){var b=j.certification;var f=$j("#country_titletext").text().replace(/\s/g,"");if(b&&j.prefix!==""&&d.replace(/\s/g,"").indexOf("+"+j.code+j.prefix)>-1){b=false}var a=b?I18n.t("txt.admin.views.voice.phone_numbers._confirmation.certification",{country:f}):null}var e={friendlynumber:d,price:g,certification:a};var c=$j.mustache($j("#confirmation").html(),e);this.elem.find("#number_info").html(c).show();this.elem.find("#number_form").hide();this.elem.find("#number_results").hide();this.elem.find(".number_select_loading_spinner").hide();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()});this.elem.find("#number_info form").submit(function(l){l.preventDefault();selectedPhoneNumber=k.elem.find(".number_list input:radio:checked");k.addNumber(selectedPhoneNumber.val(),selectedPhoneNumber.attr("token"));return false});this.elem.find(".back a").click(function(l){l.preventDefault();k.elem.find("#number_info").hide();k.elem.find("#number_form").show();k.elem.find("#number_results").show();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})})},addNumber:function(b,a){this.elem.find(".number_select_loading_spinner").show();this.pickedNumber=b;$j.ajax({url:"/voice/phone_numbers",type:"POST",data:{token:a},success:function(c){$j("#number_info").html(c);$j("#number_info a#finished").click(function(d){d.preventDefault();document.location.href="/voice/settings?number_added="+b});$j.colorbox.resize()},error:function(){$j(".error").html("<p>Error occurred when adding number. Please try again.</p>");$j(".number_select_loading_spinner").hide();$j(".error").show();$j.colorbox.resize()}});Zendesk.Instrumentation.ToTango.track("Enabled Trial","Voice")}};Zendesk.NS("Voice");Zendesk.Voice.Settings={init:function(){this.bindAddNumberLink();this.numberPicker=new Zendesk.Voice.NumberPicker($j("#number_picker"));this.greetingsPicker=new Zendesk.Voice.GreetingsPicker("#greetings_form");this.greetingsPicker.init();this.ajaxHistoryLoad()},bindAddNumberLink:function(){var a=this;$j("#add_number_link").click(function(b){a.showNumberPicker();if(b){b.preventDefault()}})},showNumberPicker:function(){var a=this;$j("#number_form").html($j.mustache($j("#area_code_search_form").html()));$j("#number_results").html("");$j("#number_picker #country").change(function(b){a.numberPicker.changeAreaCode()});$j("#number_picker #local").change(function(b){a.numberPicker.changeAreaCode()});$j("#number_picker form").submit(function(b){b.preventDefault();a.numberPicker.fetchAvailableNumbers();return false});$j.colorbox({inline:true,href:"#number_picker",width:"490px",onComplete:function(){var b=$j("#number_picker");b.find("#country").msDropDown();b.find("#local").msDropDown();b.find("#prefix").msDropDown();b.find("#country").focus()}})},ajaxHistoryLoad:function(){$j.sammy(".tab_links a",function(){this.get("#call_activity",function(){Zendesk.Voice.LiveStats.init()});this.get("#call_history",function(){$j("#call_history .loading-placeholder").addClass("loading");$j.get("/voice/settings/call_history_list",{},function(a){$j("#call_history").html(a)}).always(function(){$j("#call_history .loading-placeholder").removeClass("loading")})});this.get("#general_settings",function(){});this.get("#numbers",function(){});this.get("#greetings",function(){})}).run()}};Zendesk.Voice.LiveStats={init:function(){setTimeout(this.refreshLiveStats,2500);setTimeout(this.refreshLast24Stats,15000)},refreshLiveStats:function(){$j.ajax({url:"/voice/calls/current_queue_activity",type:"GET",dataType:"json",success:function(d){var c=parseInt($j(".stat.current_calls_waiting .val").html());if(d.current_calls_waiting!=c){if(d.current_calls_waiting>c){$j(".stat.current_calls_waiting .indicator").addClass("up");$j(".stat.current_calls_waiting .indicator").removeClass("down")}else{$j(".stat.current_calls_waiting .indicator").removeClass("up");$j(".stat.current_calls_waiting .indicator").addClass("down")}$j(".stat.current_calls_waiting .indicator").fadeIn()}else{$j(".stat.current_calls_waiting .indicator").fadeOut()}$j(".stat.current_calls_waiting .val").html(d.current_calls_waiting);$j(".stat.current_avg_wait_time").html(d.current_avg_wait_time);$j(".stat.current_longest_wait_time").html(d.current_longest_wait_time);for(var b=0;b<d.agents.length;b++){var e=d.agents[b][0];var a=d.agents[b][1];$j(".agent-status.agent-"+e).html("<span class='status-"+a+"'>"+d.statuses[a]+"</span>")}}});if(window.location.hash==="#call_activity"){setTimeout(Zendesk.Voice.LiveStats.refreshLiveStats,5000)}},refreshLast24Stats:function(){$j.ajax({url:"/voice/calls/queue_activity_last_24",type:"GET",dataType:"json",success:function(b){$j(".stat.total_calls").html(b.total_calls);$j(".stat.most_calls_waiting").html(b.most_calls_waiting);$j(".stat.avg_wait_time").html(b.avg_wait_time);$j(".stat.longest_wait_time").html(b.longest_wait_time);$j(".stat.avg_talk_time").html(b.avg_talk_time);for(var a=0;a<b.agents.length;a++){var c=b.agents[a];var d=c.id;$j(".agent-stat.available_time.agent-"+d).html(c.available_time);$j(".agent-stat.calls_accepted.agent-"+d).html(c.calls_accepted);$j(".agent-stat.calls_denied.agent-"+d).html(c.calls_denied);$j(".agent-stat.calls_missed.agent-"+d).html(c.calls_missed);$j(".agent-stat.avg_talk_time.agent-"+d).html(c.avg_talk_time)}$j("#last-updated-at-value").html(b.last_updated_at)}});if(window.location.hash==="#call_activity"){setTimeout(Zendesk.Voice.LiveStats.refreshLast24Stats,30000)}}};(function(b,a){a.VoiceBanner=(function(){function c(){var f=this;var j;var d=a.Banner.create({text:"",visible:false,reload:true}).addClass("urgent");var g="user/"+a.currentUser.id;var h=function(k){if(k===1){return I18n.t("txt.admin.views.voice._voice_banner.You_have_missed_X_phone_calls_and_are_now_offline.one")}else{return I18n.t("txt.admin.views.voice._voice_banner.You_have_missed_X_phone_calls_and_are_now_offline.other",{count:k})}};var e=function(){RadarClient.status(g).set({availability:"ignored"})};b(d).find(".reload").show();b(d).find(".reload a").html(I18n.t("txt.agent.views.voice._voice_banner.make_available")).unbind("click").click(function(){if(j&&(j==="phone"||j==="client")){a.voiceMenu.updateAvailability(j,"banner-make-available")}d.disappear();e();return false});RadarClient.alloc("agent_availability").once("ready",function(){RadarClient.status(g).on(function(k){if(!k.value||!k.value.availability){return}if(k.value.availability==="off"){a.voiceMenu.updateMenu("off");j=k.value.via_was;d.setContent(h(k.value.max));d.appear()}if(k.value.availability==="ignored"){d.disappear()}}).subscribe()});b(d).bind("ignore.zd.banner",function(){e()});this.show=function(){d.appear()}}return c}())}(jQuery,Zendesk));(function(c,a){var b=Minilog("voice-menu");a.VoiceMenu=function(){this.name="VoiceMenu"};a.VoiceMenu.prototype={initialize:function(){b.info("#init-start");var e=this;var f=function(h){var g=c(h).attr("data-available");e.updateAvailability(g,"user")};var d=_.throttle(f,100);c("#phone_menu .pick_availability").click(function(g){d(this);g.preventDefault()});if(c.browser.msie&&c.browser.version<8){c("#phone_menu li[data-available='client']").remove()}c("a.audio_settings").click(function(g){g.preventDefault();e.showFlashPermissions(true)});c(window).load(function(){_.defer(function(){b.info("#voice-menu-init");RadarClient.alloc("voice_menu",function(){RadarClient.status("voice_availability/"+a.currentAccount.subdomain).get(function(g){if(!g||!g.value){e.updateMenu(a.currentUser.availableForVoiceOn);return}var h=g.value&&g.value[a.currentUser.id];if(h){e.updateMenu(g.value[a.currentUser.id])}else{e.updateMenu("off")}}).on(function(h){if(!h||!h.value){return}var g=parseInt(h.key,10);if(g===a.currentUser.id){e.updateMenu(h.value)}}).subscribe()})})});b.info("#init-finish")},updateAvailability:function(e,j){if(!e){return}var d=this;var k=e!="off";var f=e=="off"?"client":e;var h={is_available:k,via:f,reason:j,from:window.location.toString()};b.info("#update-availability",{from:a.currentUser.availableForVoiceOn,to:e,reason:j});var g=function(){return c.ajax({url:"/voice/settings/available_via",type:"POST",data:h,dataType:"json",error:function(p,l,n){b.error("#update-availability-error",{result:l,reason:j});if(p.responseText){var m=JSON.parse(p.responseText);var o=m.message;if(o){b.error("#update-availability-error:message",{result:l,reason:j,message:o});alert(I18n.t(o))}}}})};RadarClient.alloc("voice_menu",function(){g().done(function(l){b.info("#update-availability-success",{result:l.available,reason:j})});RadarClient.status("voice_availability/"+a.currentAccount.subdomain).set(e,function(){b.info("#radar-update-availability-success",{result:e,reason:j});d.lastReason=j;d.updateMenu(e)})})},updateMenu:function(d){var f=this.lastReason;this.lastReason=null;b.info("#update-menu",{from:a.currentUser.availableForVoiceOn,to:d,lastReason:f});a.currentUser.availableForVoiceOn=d;c("#phone_menu .pick_availability a").removeClass("on");c("#phone_menu li[data-available='client'] a").toggleClass("on",d==="client");c("#phone_menu li[data-available='phone'] a").toggleClass("on",d==="phone");c("#phone_menu li[data-available='off'] a").toggleClass("on",d==="off");c("#phone_menu #phone_menu_item").toggleClass("on",d!="off");if(d!=="off"&&!this._pubsubEnabled){b.info("#subscribe-for-messages");a.CallConsoleApp.subscribeForMessages();this._pubsubEnabled=true}if(d==="client"){if(f==="user"){b.info("#update-menu","#show-flash-permissions");var e=this;var g=this.backOff([1,2,4,8],function(){return Twilio.MediaStream&&Twilio.MediaStream.initialized});g.done(function(){Twilio.MediaStream.__queue(function(){e.showFlashPermissions()})}).fail(function(){b.error("#twilio-mediastream-error",{message:"ec6"});alert(I18n.t("txt.voice.error.ec6"))})}}},backOff:function(h,e){var d=c.Deferred(),g=[],f=this;c.each(h,function(l,k){var j=(l==h.length-1);var m=setTimeout(function(){b.info("#twilio-mediastream",{delay:k});if(e&&e()){d.resolve(k)}else{if(j){d.reject(k)}}},k*1000);g.push(m)});d.done(function(j){b.info("#twilio-mediastream-done",{delay:j});c.each(g,function(k,l){clearTimeout(l)})}).fail(function(j){b.error("#twilio-mediastream-fail",{delay:j})});return d.promise()},safeIsMicMuted:function(d){try{return Twilio.MediaStream.isMicMuted()}catch(e){b.error("#is-mic-muted-fail",{message:e.message,verbose:d});if(d){alert(I18n.t("txt.voice.error.ec7"))}return true}},catchFlash:function(e){try{e.call(this)}catch(d){if(d.message&&d.message.match("Flash")){b.error("#catch-flash-error",{message:d.message});a.voiceMenu.updateAvailability("off","flash. "+d.message);alert(I18n.t("txt.voice.error.ec8",{error:d.message}))}throw (d)}},showFlashPermissions:function(e){b.info("#show-flash-permissions");var d=this;d.catchFlash(function(){if(!Twilio.Device.instance){Twilio.Device.setup(a.CallConsoleApp.capabilityToken);b.info("#flash-setup")}if(d.safeIsMicMuted(true)||e){b.info("#flash-show");Twilio.MediaStream.__queue(function(){Twilio.Device.instance.showSettings(function(){if(d.safeIsMicMuted(false)){if(a.currentUser.availableForVoiceOn==="client"){b.error("#flash-setup-denied");a.voiceMenu.updateAvailability("off","microphone");alert(I18n.t("txt.voice.error.ec9"))}}})})}})}}}(jQuery,Zendesk));if(typeof(Voice)==="undefined"){Voice={}}Voice.Timer=(function(){function a(b){this.element=jQuery(b);this.turnOff()}a.prototype.off=function(){return this._lastReset===null};a.prototype.reset=function(){this._lastReset=new Date();return this};a.prototype.turnOff=function(){this._lastReset=null;return this};a.prototype.shouldStop=function(){return false};a.prototype.update=function(){this.element.html(this._toHTML());return this};a.prototype.stop=function(b){this.stopCallback=b;return this};a.prototype.triggerStop=function(b){if(this.stopCallback){this.stopCallback()}this.element.hide();return this};a.prototype._toHTML=function(){if(this._lastReset){var b=this._sinceLastReset();return I18n.t("txt.admin.public.javascripts.views.voice.voice_timer.time",{minutes:b[0],seconds:b[1]})}else{return"--"}};a.prototype._sinceLastReset=function(){var b=this._diffInSeconds();return[Math.floor(b/60),Math.floor(b%60)]};a.prototype._diffInSeconds=function(){var b=((new Date())-this._lastReset)/1000;return b};return a}());var __hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Voice.CountdownTimer=(function(b){__extends(a,b);function a(){return a.__super__.constructor.apply(this,arguments)}a.prototype.shouldStop=function(){var c=-1*this._diffInSeconds();c=Math.round(c);if(c<=0){return true}return false};a.prototype._toHTML=function(){if(this._lastReset){var c=-1*this._diffInSeconds();c=Math.round(c);return I18n.t("txt.admin.public.javascripts.views.voice.voice_countdown_timer.seconds",{seconds:c})}else{return"--"}};return a}(Voice.Timer));Voice.TimerManager=(function(){function a(d,c){d._lastReset=c;var b=this;this._job=function(){if(d.shouldStop()){b.stop();d.triggerStop()}d.update()};this.start()}a.prototype.start=function(){var b=a.worker();b.jobs.push(this._job);b.start();return this};a.prototype.stop=function(){var b=a.worker();b.jobs=_(b.jobs).without(this._job);if(b.jobs.length===0){b.stop()}return this};a.worker=function(){if(!this._worker){var b=5;this._worker=new PeriodicWorker(1000/b)}return this._worker};return a}());(function(a,c,b){b.AlertManager=function(d,e){this._selector=""+d;this._key=""+e;c(d+" a.close").click(this.hide.bind(this))};b.AlertManager.prototype={show:function(){if(b.SettingsCookie.get(this._key)==null){var e=c(this._selector);var d=e.data("alert-id");e.show();if(d){b.Instrumentation.ToTango.track(d,"alert:load");e.find("a.link").click(function(){b.Instrumentation.ToTango.track(d,"alert:link")})}}},hide:function(e){e&&e.preventDefault&&e.preventDefault();var d=c(this._selector).hide().data("alert-id");if(d){c.ajax({type:"delete",url:"/api/v1/alerts/"+d+".json"});b.Instrumentation.ToTango.track(d,"alert:dismiss")}else{b.SettingsCookie.set(this._key,"1")}return false}}}(this.Cookie,this.jQuery,this.Zendesk));